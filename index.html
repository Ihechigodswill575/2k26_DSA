<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="theme-color" content="#0a0f1e"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>2k26_DSA</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#0a0f1e;--bg2:#111827;--bg3:#1f2937;
  --accent:#00d4aa;--accent2:#0099ff;
  --text:#f1f5f9;--text2:#94a3b8;
  --border:#1e293b;--danger:#ef4444;--warn:#f59e0b;
  --radius:12px;--radius-sm:8px;--transition:0.2s ease;--shadow:0 4px 24px rgba(0,0,0,0.4);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text)}

#splash{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.6s ease}
#splash.hide{opacity:0;pointer-events:none}
#splash img{width:130px;height:130px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);box-shadow:0 0 40px rgba(0,212,170,0.3);animation:zoomIn 0.7s ease 0.2s both}
#splash h1{margin-top:18px;font-size:26px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:fadeUp 0.7s ease 0.5s both}
#splash p{margin-top:8px;color:var(--text2);font-size:13px;animation:fadeUp 0.7s ease 0.7s both}
.splash-bar{width:180px;height:3px;background:var(--border);border-radius:3px;margin-top:36px;overflow:hidden}
.splash-fill{height:100%;width:0;border-radius:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));animation:fillBar 2.2s ease 1s forwards}
@keyframes zoomIn{from{opacity:0;transform:scale(0.7)}to{opacity:1;transform:scale(1)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes fillBar{to{width:100%}}

#auth{display:none;position:fixed;inset:0;background:var(--bg);z-index:100;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto}
#auth.show{display:flex}
.auth-card{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:30px 26px;width:100%;max-width:370px;box-shadow:var(--shadow);animation:fadeUp 0.4s ease;margin:auto}
.auth-logo{text-align:center;margin-bottom:24px}
.auth-logo img{width:65px;height:65px;border-radius:50%;border:2px solid var(--accent);margin-bottom:10px}
.auth-logo h2{font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-logo p{color:var(--text2);font-size:12px;margin-top:3px}
.auth-tabs{display:flex;gap:4px;background:var(--bg3);padding:4px;border-radius:var(--radius-sm);margin-bottom:20px}
.auth-tab{flex:1;padding:8px;text-align:center;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text2);transition:var(--transition)}
.auth-tab.active{background:var(--accent);color:#000}
.fg{margin-bottom:14px}
.fg label{display:block;font-size:11px;color:var(--text2);margin-bottom:5px;font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
.fg input{width:100%;padding:10px 13px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:14px;outline:none;transition:var(--transition)}
.fg input:focus{border-color:var(--accent)}
.fg .hint{font-size:11px;color:var(--text2);margin-top:4px}
.pfp-row{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.pfp-circle{width:50px;height:50px;border-radius:50%;background:var(--bg3);border:2px solid var(--border);cursor:pointer;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:22px}
.pfp-circle img{width:100%;height:100%;object-fit:cover}
.pfp-label{font-size:12px;color:var(--accent);cursor:pointer;display:block}
.pfp-hint{font-size:11px;color:var(--text2);margin-top:2px}
.btn{width:100%;padding:11px;border:none;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:var(--transition)}
.btn:active{transform:scale(0.98)}
.btn:disabled{opacity:0.6;cursor:not-allowed}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-danger{background:var(--danger);color:#fff}
.err{color:var(--danger);font-size:12px;margin-top:8px;display:none;word-break:break-word;line-height:1.4}

#main{display:none;height:100%}
#main.show{display:flex}
.app-wrap{display:flex;height:100%;width:100%;overflow:hidden}

.sidebar{width:320px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;transition:transform var(--transition)}
.s-header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
.s-header h2{font-size:17px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr-actions{display:flex;gap:6px;align-items:center}
.ibtn{width:34px;height:34px;border-radius:50%;background:var(--bg3);border:none;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);font-size:15px;position:relative;flex-shrink:0}
.ibtn:hover{background:var(--border);color:var(--text)}

.status-row{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;overflow-x:auto;flex-shrink:0;scrollbar-width:none}
.status-row::-webkit-scrollbar{display:none}
.st-item{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;flex-shrink:0}
.st-ring{width:46px;height:46px;border-radius:50%;border:2.5px solid var(--accent);padding:2px;position:relative;flex-shrink:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
.st-ring img{width:100%;height:100%;border-radius:50%;object-fit:cover}
.st-ring.add-btn{border-color:var(--border);background:var(--bg3);font-size:20px;color:var(--accent)}
.st-mine{border-color:var(--accent2)}
.st-item span{font-size:10px;color:var(--text2);max-width:52px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}

.s-search{padding:8px 14px;flex-shrink:0}
.search-wrap{display:flex;align-items:center;background:var(--bg3);border-radius:var(--radius-sm);padding:0 11px;gap:7px}
.search-wrap input{flex:1;background:none;border:none;color:var(--text);font-family:inherit;font-size:13px;padding:9px 0;outline:none}
.search-wrap input::placeholder{color:var(--text2)}

.sidebar-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.stab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:500;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;transition:var(--transition);position:relative}
.stab.active{color:var(--accent);border-bottom-color:var(--accent)}
.stab-badge{position:absolute;top:6px;right:calc(50% - 22px);background:var(--danger);color:#fff;font-size:9px;font-weight:700;border-radius:10px;padding:1px 5px;min-width:14px;text-align:center;display:none}
.stab-badge.show{display:block}

.tab-pane{display:none;flex:1;overflow-y:auto;flex-direction:column}
.tab-pane.active{display:flex}

.ci{display:flex;align-items:center;gap:11px;padding:11px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:var(--transition);position:relative}
.ci:hover,.ci.active{background:var(--bg3)}
.ci-av{width:44px;height:44px;border-radius:50%;object-fit:cover;flex-shrink:0;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:600;color:var(--accent);overflow:hidden}
.ci-av img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.ci-info{flex:1;min-width:0}
.ci-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ci-last{font-size:12px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.ci-meta{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}
.ci-time{font-size:10px;color:var(--text2)}
.ci-badge{background:var(--accent);color:#000;font-size:10px;font-weight:700;border-radius:10px;padding:2px 6px;min-width:17px;text-align:center}

.req-item{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)}
.req-info{flex:1;min-width:0}
.req-name{font-size:13px;font-weight:600}
.req-user{font-size:11px;color:var(--text2)}
.req-actions{display:flex;gap:6px;flex-shrink:0}
.req-btn{padding:5px 10px;border-radius:var(--radius-sm);border:none;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:var(--transition)}
.req-btn.accept{background:var(--accent);color:#000}
.req-btn.decline{background:var(--bg3);color:var(--text2);border:1px solid var(--border)}

.chat-area{flex:1;display:flex;flex-direction:column;background:var(--bg);overflow:hidden;min-width:0}
.no-chat{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text2);gap:10px}
.no-chat .big{font-size:60px;opacity:0.25}

.ch-header{display:flex;align-items:center;gap:11px;padding:11px 14px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;min-height:60px}
.ch-info{flex:1;min-width:0}
.ch-name{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ch-sub{font-size:11px;color:var(--text2)}
.back-btn{display:none;background:none;border:none;color:var(--text2);font-size:22px;cursor:pointer;padding:4px;flex-shrink:0}

.msgs{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:4px;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.msgs::-webkit-scrollbar{width:4px}
.msgs::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

.mw{display:flex;flex-direction:column;max-width:72%;position:relative}
.mw.out{align-self:flex-end;align-items:flex-end}
.mw.in{align-self:flex-start;align-items:flex-start}
.mb{padding:8px 12px;border-radius:16px;font-size:14px;line-height:1.5;word-break:break-word;cursor:pointer}
.mw.out .mb{background:rgba(0,212,170,0.13);border:1px solid rgba(0,212,170,0.2);border-bottom-right-radius:4px}
.mw.in .mb{background:var(--bg3);border-bottom-left-radius:4px}
.mb.deleted{opacity:0.5;font-style:italic;color:var(--text2)}
.mb.edited::after{content:' (edited)';font-size:10px;color:var(--text2);font-style:italic}
.m-time{font-size:10px;color:var(--text2);margin-top:2px;padding:0 3px}
.m-sender{font-size:11px;color:var(--accent);font-weight:600;margin-bottom:2px}
.m-img{max-width:200px;border-radius:10px;cursor:pointer;display:block}
.m-audio audio{width:210px;border-radius:8px}
.m-reactions{display:flex;gap:3px;flex-wrap:wrap;margin-top:3px}
.rpill{background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:2px 7px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:2px}
.rpill.mine{border-color:var(--accent)}
.rpill .rc{font-size:10px;color:var(--text2)}
.tag-highlight{color:var(--accent);font-weight:600}
.edit-timer{font-size:10px;color:var(--warn);margin-top:2px;padding:0 3px}

.msg-ctx-menu{display:none;position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:6px;z-index:300;min-width:160px;box-shadow:var(--shadow);animation:fadeUp 0.15s ease}
.msg-ctx-menu.show{display:block}
.ctx-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:var(--radius-sm);cursor:pointer;font-size:13px;transition:var(--transition)}
.ctx-item:hover{background:var(--bg3)}

.emoji-picker{display:none;position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:8px;gap:4px;z-index:301;box-shadow:var(--shadow);flex-wrap:wrap;width:200px}
.emoji-picker.show{display:flex}
.emoji-picker button{background:none;border:none;font-size:20px;cursor:pointer;padding:3px;border-radius:6px;transition:var(--transition)}
.emoji-picker button:hover{background:var(--bg3);transform:scale(1.2)}

.chat-input-area{padding:10px 14px;background:var(--bg2);border-top:1px solid var(--border);display:flex;align-items:flex-end;gap:8px;flex-shrink:0}
.iw{flex:1;background:var(--bg3);border-radius:var(--radius);padding:9px 12px;display:flex;align-items:flex-end;gap:7px;min-height:42px}
.iw textarea{flex:1;background:none;border:none;color:var(--text);font-family:inherit;font-size:14px;resize:none;outline:none;max-height:110px;line-height:1.5;min-height:21px}
.iw textarea::placeholder{color:var(--text2)}
.iw-actions{display:flex;align-items:center;gap:6px;flex-shrink:0}
.send-btn{width:42px;height:42px;border-radius:50%;border:none;flex-shrink:0;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;transition:var(--transition)}
.send-btn:active{transform:scale(0.92)}

.vn-bar{display:none;align-items:center;gap:9px;flex:1;background:var(--bg3);border-radius:var(--radius);padding:9px 12px}
.vn-bar.show{display:flex}
.rec-dot{width:9px;height:9px;border-radius:50%;background:var(--danger);animation:pulse 1s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.rec-time{font-size:14px;font-weight:600;flex:1}
.rec-cancel{background:none;border:none;color:var(--text2);cursor:pointer;font-size:19px}

.edit-bar{display:none;background:rgba(0,212,170,0.08);border-top:1px solid rgba(0,212,170,0.15);padding:6px 14px;font-size:12px;color:var(--accent);align-items:center;gap:8px;flex-shrink:0}
.edit-bar.show{display:flex}
.edit-bar span{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.edit-bar button{background:none;border:none;color:var(--text2);cursor:pointer;font-size:16px}

.tag-suggest{display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;z-index:100;max-height:160px;overflow-y:auto}
.tag-suggest.show{display:block}
.tag-opt{padding:8px 12px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px;transition:var(--transition)}
.tag-opt:hover{background:var(--bg3)}
.tag-opt img{width:28px;height:28px;border-radius:50%;object-fit:cover}
.tag-opt .tag-av{width:28px;height:28px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--accent);font-weight:600}

.gc-rules-banner{background:rgba(0,212,170,0.07);border:1px solid rgba(0,212,170,0.13);border-radius:var(--radius-sm);padding:8px 12px;margin:8px 14px 0;font-size:12px;color:var(--text2);display:none;flex-shrink:0}
.gc-rules-banner.show{display:block}
.gc-rules-banner strong{color:var(--accent);display:block;margin-bottom:3px;font-size:11px}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.78);z-index:200;align-items:center;justify-content:center;padding:18px}
.overlay.show{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:22px;width:100%;max-width:390px;max-height:90vh;overflow-y:auto;animation:fadeUp 0.3s ease}
.modal h3{font-size:16px;font-weight:700;margin-bottom:18px}
.mfooter{display:flex;gap:9px;margin-top:18px}
.mfooter .btn{flex:1}

.rules-list{list-style:none;display:flex;flex-direction:column;gap:7px}
.rule-item{display:flex;align-items:center;gap:8px;background:var(--bg3);padding:9px 11px;border-radius:var(--radius-sm);font-size:13px}
.rule-item button{background:none;border:none;color:var(--danger);cursor:pointer;margin-left:auto;font-size:15px}
.members-list{display:flex;flex-direction:column;gap:7px;max-height:220px;overflow-y:auto}
.member-item{display:flex;align-items:center;gap:9px;padding:8px;border-radius:var(--radius-sm);background:var(--bg3)}
.member-item .m-av{width:32px;height:32px;border-radius:50%;overflow:hidden;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--accent);font-weight:600;flex-shrink:0}
.member-item .m-av img{width:100%;height:100%;object-fit:cover}
.member-item span{flex:1;font-size:13px;min-width:0;overflow:hidden;text-overflow:ellipsis}
.member-item .badge{font-size:10px;background:var(--accent);color:#000;padding:2px 6px;border-radius:10px;font-weight:600;flex-shrink:0}

.pmenu{display:none;position:fixed;top:58px;right:14px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:7px;z-index:150;min-width:170px;box-shadow:var(--shadow);animation:fadeUp 0.2s ease}
.pmenu.show{display:block}
.pmi{display:flex;align-items:center;gap:9px;padding:9px 11px;border-radius:var(--radius-sm);cursor:pointer;font-size:13px;transition:var(--transition)}
.pmi:hover{background:var(--bg3)}

.toast{position:fixed;bottom:76px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 16px;font-size:13px;z-index:9998;opacity:0;transition:all 0.3s ease;pointer-events:none;max-width:88vw;text-align:center;cursor:pointer}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.img-viewer{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:500;align-items:center;justify-content:center}
.img-viewer.show{display:flex}
.img-viewer img{max-width:90%;max-height:90%;border-radius:var(--radius);object-fit:contain}
.img-viewer-close{position:absolute;top:20px;right:20px;background:var(--bg3);border:none;color:var(--text);font-size:22px;cursor:pointer;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center}

.sv{display:none;position:fixed;inset:0;background:#000;z-index:400;flex-direction:column}
.sv.show{display:flex}
.sv-header{padding:14px 16px;position:absolute;top:0;left:0;right:0;z-index:1;background:linear-gradient(to bottom,rgba(0,0,0,0.85),transparent)}
.sv-bars{display:flex;gap:4px;margin-bottom:10px}
.sv-bar{height:3px;flex:1;background:rgba(255,255,255,0.3);border-radius:3px;overflow:hidden}
.sv-fill{height:100%;background:#fff;border-radius:3px;width:0}
.sv-meta{display:flex;align-items:center;gap:8px}
.sv-av{width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;background:var(--bg3)}
.sv-name{font-size:13px;font-weight:600;color:#fff;flex:1}
.sv-time{font-size:11px;color:rgba(255,255,255,0.6);flex-shrink:0}
.sv-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;flex-shrink:0;padding:0 4px}
.sv-delete{background:rgba(239,68,68,0.2);border:1px solid var(--danger);color:var(--danger);font-size:12px;padding:4px 10px;border-radius:var(--radius-sm);cursor:pointer;font-family:inherit;flex-shrink:0}
.sv-media{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000}
.sv-media img{width:100%;height:100%;object-fit:contain}
.sv-media video{width:100%;height:100%;object-fit:contain}
.sv-footer{position:absolute;bottom:0;left:0;right:0;padding:16px 16px 28px;background:linear-gradient(to top,rgba(0,0,0,0.8),transparent);display:flex;flex-direction:column;gap:6px}
.sv-viewers{font-size:12px;color:rgba(255,255,255,0.85);display:flex;align-items:center;gap:4px}
.sv-viewer-names{font-size:11px;color:rgba(255,255,255,0.6)}
.sv-caption{font-size:13px;color:#fff}

.empty-list{text-align:center;padding:36px 20px;color:var(--text2);font-size:13px;line-height:1.6}
.empty-list .ei{font-size:36px;margin-bottom:8px}

.user-search-result{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border-radius:var(--radius-sm);margin-top:10px}
.usr-av{width:40px;height:40px;border-radius:50%;flex-shrink:0;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--accent);font-weight:600;overflow:hidden}
.usr-av img{width:100%;height:100%;object-fit:cover}

@media(max-width:680px){
  .sidebar{position:fixed;inset:0;width:100%;z-index:10}
  .sidebar.hidden{transform:translateX(-100%)}
  .back-btn{display:block}
}
</style>
</head>
<body>

<div id="splash">
  <img src="https://image2url.com/r2/default/images/1772295169769-b92423f9-499f-4178-942f-409c094d9380.jpg" alt="2k26_DSA" onerror="this.style.display='none'"/>
  <h1>2k26_DSA</h1>
  <p>Welcome to 2k26_DSA üî•</p>
  <div class="splash-bar"><div class="splash-fill"></div></div>
</div>

<div id="auth">
  <div class="auth-card">
    <div class="auth-logo">
      <img src="https://image2url.com/r2/default/images/1772295169769-b92423f9-499f-4178-942f-409c094d9380.jpg" alt="logo"/>
      <h2>2k26_DSA</h2>
      <p>Connect. Chat. Vibe.</p>
    </div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')">Login</div>
      <div class="auth-tab" onclick="switchTab('signup')">Sign Up</div>
    </div>
    <div id="login-form">
      <div class="fg"><label>Email</label><input type="email" id="login-email" placeholder="you@email.com" autocomplete="email"/></div>
      <div class="fg"><label>Password</label><input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
      <p class="err" id="login-err"></p>
      <button class="btn" id="login-btn" onclick="doLogin()">Login</button>
    </div>
    <div id="signup-form" style="display:none">
      <div class="pfp-row">
        <div class="pfp-circle" id="pfp-preview" onclick="document.getElementById('pfp-file').click()">üë§</div>
        <div>
          <label class="pfp-label" for="pfp-file">Choose Profile Pic</label>
          <p class="pfp-hint">Optional</p>
        </div>
        <input type="file" id="pfp-file" accept="image/*" style="display:none" onchange="previewPfp(this)"/>
      </div>
      <div class="fg">
        <label>Username</label>
        <input type="text" id="su-username" placeholder="e.g. godswill_dsa" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9_]/g,'')"/>
        <p class="hint">Lowercase, numbers and _ only</p>
      </div>
      <div class="fg"><label>Display Name</label><input type="text" id="su-name" placeholder="Your name"/></div>
      <div class="fg"><label>Email</label><input type="email" id="su-email" placeholder="you@email.com"/></div>
      <div class="fg"><label>Password</label><input type="password" id="su-pass" placeholder="Min 6 characters"/></div>
      <p class="err" id="su-err"></p>
      <button class="btn" id="su-btn" onclick="doSignup()">Create Account</button>
    </div>
  </div>
</div>

<div id="main">
  <div class="app-wrap">
    <div class="sidebar" id="sidebar">
      <div class="s-header">
        <h2>2k26_DSA</h2>
        <div class="hdr-actions">
          <button class="ibtn" onclick="openGcModal()" title="New Group">üë•</button>
          <button class="ibtn" onclick="openStatusModal()" title="Post Status">üì∏</button>
          <button class="ibtn" onclick="openFindUser()" title="Find User">üîç</button>
          <button class="ibtn" onclick="toggleProfileMenu()" id="profile-btn">
            <img id="header-pfp" style="width:28px;height:28px;border-radius:50%;object-fit:cover;display:none"/>
            <span id="header-pfp-ph">üë§</span>
          </button>
        </div>
      </div>
      <div class="status-row" id="status-row">
        <div class="st-item" onclick="openStatusModal()">
          <div class="st-ring add-btn">Ôºã</div>
          <span>My Status</span>
        </div>
      </div>
      <div class="s-search">
        <div class="search-wrap">
          <span style="color:var(--text2);font-size:14px">üîç</span>
          <input type="text" placeholder="Search chats..." oninput="filterChats(this.value)"/>
        </div>
      </div>
      <div class="sidebar-tabs">
        <div class="stab active" onclick="switchSideTab('chats',this)">Chats</div>
        <div class="stab" onclick="switchSideTab('groups',this)">Groups</div>
        <div class="stab" onclick="switchSideTab('requests',this)">Requests<span class="stab-badge" id="req-badge"></span></div>
      </div>
      <div class="tab-pane active" id="pane-chats"></div>
      <div class="tab-pane" id="pane-groups"></div>
      <div class="tab-pane" id="pane-requests"></div>
    </div>

    <div class="chat-area">
      <div class="no-chat" id="no-chat" style="display:flex">
        <div class="big">üí¨</div>
        <p>Select a chat to start messaging</p>
      </div>
      <div id="active-chat" style="display:none;flex-direction:column;height:100%;overflow:hidden">
        <div class="ch-header">
          <button class="back-btn" onclick="closeChat()">‚Äπ</button>
          <div id="ch-avatar" class="ci-av" style="width:40px;height:40px;font-size:16px;flex-shrink:0"></div>
          <div class="ch-info">
            <div class="ch-name" id="ch-name"></div>
            <div class="ch-sub" id="ch-sub"></div>
          </div>
          <button class="ibtn" onclick="openChatInfo()">‚ÑπÔ∏è</button>
        </div>
        <div class="gc-rules-banner" id="gc-rules-banner"><strong>üìã Group Rules</strong><div id="gc-rules-text"></div></div>
        <div class="msgs" id="msgs"></div>
        <div class="edit-bar" id="edit-bar">
          <span>‚úèÔ∏è Editing: <span id="edit-preview"></span></span>
          <button onclick="cancelEdit()">‚úï</button>
        </div>
        <div style="position:relative">
          <div class="tag-suggest" id="tag-suggest"></div>
        </div>
        <div class="chat-input-area">
          <div class="iw" id="normal-iw">
            <textarea id="msg-txt" placeholder="Type a message..." rows="1" oninput="handleInput(this)" onkeydown="handleEnter(event)"></textarea>
            <div class="iw-actions">
              <label style="cursor:pointer;font-size:17px;color:var(--text2)">
                üñºÔ∏è<input type="file" accept="image/*,video/*" style="display:none" onchange="sendMedia(this)"/>
              </label>
            </div>
          </div>
          <div class="vn-bar" id="vn-bar">
            <div class="rec-dot"></div>
            <span class="rec-time" id="rec-time">0:00</span>
            <button class="rec-cancel" onclick="cancelVN()">‚úï</button>
            <button class="ibtn" onclick="stopAndSendVN()" style="background:var(--accent);color:#000;width:34px;height:34px">‚úì</button>
          </div>
          <button class="ibtn" id="vn-btn" onclick="toggleVN()" style="width:42px;height:42px;font-size:18px">üé§</button>
          <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="pmenu" id="pmenu">
  <div class="pmi" onclick="openProfileEdit()">‚úèÔ∏è Edit Profile</div>
  <div class="pmi" onclick="openFindUser()">üîç Find User</div>
  <div class="pmi" onclick="doLogout()" style="color:var(--danger)">üö™ Logout</div>
</div>

<div class="msg-ctx-menu" id="msg-ctx-menu">
  <div class="ctx-item" onclick="showEmojiFromCtx()">üòä React</div>
  <div class="ctx-item" id="ctx-edit" onclick="startEdit()">‚úèÔ∏è Edit</div>
  <div class="ctx-item" id="ctx-delete" onclick="deleteMsg()" style="color:var(--danger)">üóëÔ∏è Delete</div>
  <div class="ctx-item" id="ctx-admin-delete" onclick="adminDeleteMsg()" style="color:var(--danger);display:none">üóëÔ∏è Admin Delete</div>
</div>
<div class="emoji-picker" id="global-ep"></div>

<div class="overlay" id="gc-overlay">
  <div class="modal">
    <h3>Create Group</h3>
    <div class="fg"><label>Group Name</label><input type="text" id="gc-name" placeholder="e.g. Squad 2k26"/></div>
    <div class="fg"><label>Description</label><input type="text" id="gc-desc" placeholder="What's this group about?"/></div>
    <div class="fg">
      <label>Group Icon</label>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="pfp-circle" id="gc-icon-preview" onclick="document.getElementById('gc-icon-file').click()">üë•</div>
        <input type="file" id="gc-icon-file" accept="image/*" style="display:none" onchange="previewGcIcon(this)"/>
        <label class="pfp-label" for="gc-icon-file">Upload Icon</label>
      </div>
    </div>
    <div class="fg">
      <label>Add Members by Username</label>
      <div style="display:flex;gap:7px">
        <input type="text" id="gc-member-input" placeholder="@username" style="flex:1;padding:9px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:13px;outline:none" oninput="this.value=this.value.replace(/[^a-z0-9_@]/g,'').toLowerCase()"/>
        <button class="ibtn" onclick="addGcMember()" style="width:auto;padding:0 12px;border-radius:var(--radius-sm)">Add</button>
      </div>
      <div id="gc-members-list" style="margin-top:8px;display:flex;flex-direction:column;gap:5px"></div>
    </div>
    <div class="fg">
      <label>Group Rules</label>
      <div style="display:flex;gap:7px">
        <input type="text" id="gc-rule-input" placeholder="e.g. No spam" style="flex:1;padding:9px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:13px;outline:none"/>
        <button class="ibtn" onclick="addRuleInput()" style="width:auto;padding:0 12px;border-radius:var(--radius-sm)">+</button>
      </div>
      <ul class="rules-list" id="rules-preview" style="margin-top:8px"></ul>
    </div>
    <p class="err" id="gc-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('gc-overlay')">Cancel</button>
      <button class="btn" onclick="createGroup()">Create Group</button>
    </div>
  </div>
</div>

<div class="overlay" id="find-overlay">
  <div class="modal">
    <h3>üîç Find User</h3>
    <div class="fg">
      <label>Search by Username</label>
      <div style="display:flex;gap:7px">
        <input type="text" id="find-input" placeholder="@username" style="flex:1;padding:9px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:13px;outline:none" oninput="this.value=this.value.replace(/[^a-z0-9_@]/g,'').toLowerCase()"/>
        <button class="ibtn" onclick="findUser()" style="width:auto;padding:0 12px;border-radius:var(--radius-sm)">Search</button>
      </div>
    </div>
    <div id="find-result"></div>
    <p class="err" id="find-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('find-overlay')">Close</button>
    </div>
  </div>
</div>

<div class="overlay" id="status-overlay">
  <div class="modal">
    <h3>Post Status</h3>
    <div class="fg">
      <label>Image or Video</label>
      <label style="display:flex;align-items:center;gap:10px;background:var(--bg3);padding:12px;border-radius:var(--radius-sm);cursor:pointer;border:1px dashed var(--border)">
        <span>üìé</span><span style="font-size:13px;color:var(--text2)">Tap to choose media</span>
        <input type="file" id="status-file" accept="image/*,video/*" style="display:none" onchange="previewStatus(this)"/>
      </label>
      <div id="status-preview" style="margin-top:8px"></div>
    </div>
    <div class="fg"><label>Caption (optional)</label><input type="text" id="status-caption" placeholder="What's on your mind?"/></div>
    <p class="err" id="status-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('status-overlay')">Cancel</button>
      <button class="btn" id="status-post-btn" onclick="postStatus()">Post Status</button>
    </div>
  </div>
</div>

<div class="overlay" id="chatinfo-overlay">
  <div class="modal">
    <h3 id="chatinfo-title">Info</h3>
    <div id="chatinfo-content"></div>
    <div class="mfooter" id="chatinfo-footer">
      <button class="btn btn-ghost" onclick="closeModal('chatinfo-overlay')">Close</button>
    </div>
  </div>
</div>

<div class="overlay" id="profile-overlay">
  <div class="modal">
    <h3>Edit Profile</h3>
    <div class="pfp-row">
      <div class="pfp-circle" id="edit-pfp-preview" onclick="document.getElementById('edit-pfp-file').click()">üë§</div>
      <div>
        <label class="pfp-label" for="edit-pfp-file">Change Photo</label>
        <p class="pfp-hint">Uploads to Cloudinary</p>
      </div>
      <input type="file" id="edit-pfp-file" accept="image/*" style="display:none" onchange="previewEditPfp(this)"/>
    </div>
    <div class="fg"><label>Display Name</label><input type="text" id="edit-name"/></div>
    <div class="fg"><label>Status Text</label><input type="text" id="edit-status-text" placeholder="Hey there!"/></div>
    <p class="err" id="edit-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('profile-overlay')">Cancel</button>
      <button class="btn" onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>

<div class="sv" id="sv">
  <div class="sv-header">
    <div class="sv-bars" id="sv-bars"></div>
    <div class="sv-meta">
      <img class="sv-av" id="sv-av" src="" onerror="this.style.display='none'"/>
      <span class="sv-name" id="sv-name"></span>
      <span class="sv-time" id="sv-time"></span>
      <button class="sv-delete" id="sv-delete-btn" onclick="deleteStatus()" style="display:none">Delete</button>
      <button class="sv-close" onclick="closeSV()">‚úï</button>
    </div>
  </div>
  <div class="sv-media" id="sv-media"></div>
  <div class="sv-footer">
    <div class="sv-viewers" id="sv-viewers"></div>
    <div class="sv-viewer-names" id="sv-viewer-names"></div>
    <div class="sv-caption" id="sv-caption"></div>
  </div>
</div>

<div class="img-viewer" id="img-viewer">
  <button class="img-viewer-close" onclick="closeImgViewer()">‚úï</button>
  <img id="viewer-img" src="" alt=""/>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged, updateProfile, deleteUser
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc,
  onSnapshot, query, where, orderBy, updateDoc, deleteDoc,
  arrayUnion, arrayRemove, serverTimestamp, Timestamp, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const FB={
  apiKey:"AIzaSyBzUELxbbaL6Wb_M1uNhjwlZHVTorN9XJs",
  authDomain:"my-whatsapp-2c1af.firebaseapp.com",
  projectId:"my-whatsapp-2c1af",
  storageBucket:"my-whatsapp-2c1af.firebasestorage.app",
  messagingSenderId:"1089455460888",
  appId:"1:1089455460888:web:15bd0820546c813febe96d"
};
const CLOUD_NAME="dzxckgbzp",CLOUD_PRESET="Odegaard";
const app=initializeApp(FB);
const auth=getAuth(app);
const db=getFirestore(app);

let CU=null,CUD=null;
let activeChatId=null,activeChatType=null,activeChatData=null;
let msgsUnsub=null,chatsUnsub=null,reqUnsub=null;
let mediaRecorder=null,recChunks=[],recTimer=null,recSeconds=0;
let pendingPfpFile=null,pendingGcIconFile=null,pendingEditPfpFile=null,pendingStatusFile=null;
let gcMembersToAdd=[],gcRulesArr=[];
let ctxMsgId=null,ctxMsgData=null,editingMsgId=null;
let editTimers={};
let svStatuses=[],svIdx=0,svProg=null;
let gcMembers=[];
const EMOJIS=['‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üëç','üî•','üéâ','üòç','üíØ','üôè'];

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg,dur=2800,cb){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');t.onclick=cb||null;
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),dur);
}
function showErr(id,msg){const e=document.getElementById(id);if(e){e.textContent=msg;e.style.display='block';}}
function hideErr(id){const e=document.getElementById(id);if(e)e.style.display='none';}
function fmtTime(ts){
  if(!ts)return'just now';
  try{
    const d=ts.toDate?ts.toDate():new Date(ts);
    if(isNaN(d.getTime()))return'just now';
    const now=new Date(),diff=now-d;
    if(diff<60000)return'just now';
    if(diff<3600000)return Math.floor(diff/60000)+'m ago';
    if(d.toDateString()===now.toDateString())return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    return d.toLocaleDateString([],{day:'2-digit',month:'short'});
  }catch(e){return'just now';}
}
function chatId(a,b){return[a,b].sort().join('_');}
function secsLeft(ts){
  if(!ts)return 0;
  try{const d=ts.toDate?ts.toDate():new Date(ts);return Math.max(0,120-Math.floor((Date.now()-d.getTime())/1000));}
  catch(e){return 0;}
}
async function uploadCloud(file,folder='2k26dsa'){
  const fd=new FormData();
  fd.append('file',file);fd.append('upload_preset',CLOUD_PRESET);fd.append('folder',folder);
  const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,{method:'POST',body:fd});
  if(!res.ok)throw new Error('Upload failed');
  const d=await res.json();
  if(d.error)throw new Error(d.error.message);
  if(!d.secure_url)throw new Error('No URL returned');
  return d.secure_url;
}

setTimeout(()=>{
  document.getElementById('splash').classList.add('hide');
  setTimeout(()=>{document.getElementById('splash').style.display='none';checkAuth();},650);
},3200);

function checkAuth(){
  onAuthStateChanged(auth,async u=>{
    if(u){
      CU=u;
      try{await loadCUD(u.uid);}catch(e){
        CUD={name:CU.displayName||'User',pfp:'',username:'',statusText:''};
        updateHeaderPfp();
      }
      showMain();
    }else{showAuth();}
  },()=>showAuth());
}
async function loadCUD(uid){
  const s=await getDoc(doc(db,'users',uid));
  CUD=s.exists()?s.data():{name:CU.displayName||'User',pfp:'',username:'',statusText:''};
  updateHeaderPfp();
}
function updateHeaderPfp(){
  const img=document.getElementById('header-pfp'),ph=document.getElementById('header-pfp-ph');
  if(CUD?.pfp){img.src=CUD.pfp;img.style.display='block';ph.style.display='none';}
  else{img.style.display='none';ph.style.display='block';}
}
function showAuth(){document.getElementById('auth').classList.add('show');}
function hideAuth(){document.getElementById('auth').classList.remove('show');}
function showMain(){
  hideAuth();
  document.getElementById('main').classList.add('show');
  loadChats();loadStatuses();listenRequests();listenNotifications();
}

window.switchTab=function(t){
  document.getElementById('login-form').style.display=t==='login'?'block':'none';
  document.getElementById('signup-form').style.display=t==='signup'?'block':'none';
  document.querySelectorAll('.auth-tab').forEach((el,i)=>el.classList.toggle('active',(t==='login'&&i===0)||(t==='signup'&&i===1)));
};
window.previewPfp=function(i){pendingPfpFile=i.files[0];if(pendingPfpFile)document.getElementById('pfp-preview').innerHTML=`<img src="${URL.createObjectURL(pendingPfpFile)}"/>`;};
window.previewGcIcon=function(i){pendingGcIconFile=i.files[0];if(pendingGcIconFile)document.getElementById('gc-icon-preview').innerHTML=`<img src="${URL.createObjectURL(pendingGcIconFile)}"/>`;};
window.previewEditPfp=function(i){pendingEditPfpFile=i.files[0];if(pendingEditPfpFile)document.getElementById('edit-pfp-preview').innerHTML=`<img src="${URL.createObjectURL(pendingEditPfpFile)}"/>`;};
window.previewStatus=function(i){
  pendingStatusFile=i.files[0];
  if(!pendingStatusFile)return;
  const url=URL.createObjectURL(pendingStatusFile);
  document.getElementById('status-preview').innerHTML=pendingStatusFile.type.startsWith('video')
    ?`<video src="${url}" style="max-width:100%;border-radius:8px;max-height:160px" controls playsinline></video>`
    :`<img src="${url}" style="max-width:100%;border-radius:8px;max-height:160px"/>`;
};

window.doLogin=async function(){
  const email=document.getElementById('login-email').value.trim();
  const pass=document.getElementById('login-pass').value;
  hideErr('login-err');
  if(!email||!pass){showErr('login-err','Fill all fields.');return;}
  const btn=document.getElementById('login-btn');
  btn.disabled=true;btn.textContent='Logging in...';
  try{
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){
    const m={'auth/user-not-found':'No account with this email.','auth/wrong-password':'Wrong password.','auth/invalid-credential':'Wrong email or password.','auth/network-request-failed':'No internet connection.','auth/invalid-email':'Invalid email address.','auth/too-many-requests':'Too many attempts. Try again later.'};
    showErr('login-err',m[e.code]||e.message);
  }finally{
    btn.disabled=false;btn.textContent='Login';
  }
};

window.doSignup=async function(){
  const username=document.getElementById('su-username').value.trim();
  const name=document.getElementById('su-name').value.trim();
  const email=document.getElementById('su-email').value.trim();
  const pass=document.getElementById('su-pass').value;
  hideErr('su-err');
  if(!username||username.length<3){showErr('su-err','Username must be 3+ characters.');return;}
  if(!name||!email||!pass){showErr('su-err','Fill all fields.');return;}
  if(pass.length<6){showErr('su-err','Password min 6 characters.');return;}
  const btn=document.getElementById('su-btn');
  btn.disabled=true;btn.textContent='Checking username...';
  let cred=null;
  try{
    const usnap=await getDocs(query(collection(db,'users'),where('username','==',username)));
    if(!usnap.empty){
      showErr('su-err','Username already taken. Try another.');
      btn.disabled=false;btn.textContent='Create Account';
      return;
    }
    btn.textContent='Creating account...';
    cred=await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    let pfpUrl='';
    if(pendingPfpFile){
      btn.textContent='Uploading photo...';
      try{pfpUrl=await uploadCloud(pendingPfpFile,'pfps');await updateProfile(cred.user,{photoURL:pfpUrl});}catch(ue){console.warn('PFP skip',ue);}
    }
    btn.textContent='Saving profile...';
    await setDoc(doc(db,'users',cred.user.uid),{uid:cred.user.uid,name,email:email.toLowerCase(),username,pfp:pfpUrl,statusText:'Hey there! I am on 2k26_DSA',createdAt:serverTimestamp(),friends:[]});
    toast('Welcome to 2k26_DSA! üéâ');
  }catch(e){
    if(cred?.user){try{await deleteUser(cred.user);}catch(de){}}
    const m={'auth/email-already-in-use':'Email already registered.','auth/weak-password':'Password too weak.','auth/invalid-email':'Invalid email.','auth/network-request-failed':'No internet.'};
    showErr('su-err',m[e.code]||e.message);
    btn.disabled=false;btn.textContent='Create Account';
  }
};

window.doLogout=async function(){
  if(chatsUnsub)chatsUnsub();if(reqUnsub)reqUnsub();if(msgsUnsub)msgsUnsub();
  try{await signOut(auth);}catch(e){}
  CU=null;CUD=null;activeChatId=null;
  document.getElementById('main').classList.remove('show');
  document.getElementById('pmenu').classList.remove('show');
  showAuth();
};

window.toggleProfileMenu=function(){document.getElementById('pmenu').classList.toggle('show');};
document.addEventListener('click',e=>{
  if(!e.target.closest('#pmenu')&&!e.target.closest('#profile-btn'))document.getElementById('pmenu').classList.remove('show');
  if(!e.target.closest('#msg-ctx-menu')&&!e.target.closest('.mb'))hideCtxMenu();
  if(!e.target.closest('#global-ep')&&!e.target.closest('.mb'))document.getElementById('global-ep').classList.remove('show');
});

window.openProfileEdit=function(){
  document.getElementById('pmenu').classList.remove('show');
  if(CUD?.pfp)document.getElementById('edit-pfp-preview').innerHTML=`<img src="${CUD.pfp}"/>`;
  document.getElementById('edit-name').value=CUD?.name||'';
  document.getElementById('edit-status-text').value=CUD?.statusText||'';
  document.getElementById('profile-overlay').classList.add('show');
};
window.saveProfile=async function(){
  hideErr('edit-err');
  const name=document.getElementById('edit-name').value.trim();
  const statusText=document.getElementById('edit-status-text').value.trim();
  if(!name){showErr('edit-err','Name cannot be empty.');return;}
  const btn=document.querySelector('#profile-overlay .btn:not(.btn-ghost)');
  btn.disabled=true;btn.textContent='Saving...';
  try{
    let pfp=CUD?.pfp||'';
    if(pendingEditPfpFile){pfp=await uploadCloud(pendingEditPfpFile,'pfps');pendingEditPfpFile=null;}
    await updateProfile(CU,{displayName:name,photoURL:pfp||null});
    await setDoc(doc(db,'users',CU.uid),{name,statusText,pfp},{merge:true});
    CUD={...CUD,name,statusText,pfp};updateHeaderPfp();
    closeModal('profile-overlay');toast('Profile updated ‚úÖ');
  }catch(e){showErr('edit-err',e.message);}
  finally{btn.disabled=false;btn.textContent='Save';}
};

window.openFindUser=function(){
  document.getElementById('pmenu').classList.remove('show');
  document.getElementById('find-input').value='';
  document.getElementById('find-result').innerHTML='';
  hideErr('find-err');
  document.getElementById('find-overlay').classList.add('show');
};
window.findUser=async function(){
  const uname=document.getElementById('find-input').value.trim().replace('@','');
  hideErr('find-err');
  if(!uname){showErr('find-err','Enter a username.');return;}
  if(uname===CUD?.username){showErr('find-err',"That's you!");return;}
  document.getElementById('find-result').innerHTML='<p style="color:var(--text2);font-size:13px;margin-top:8px">Searching...</p>';
  try{
    const snap=await getDocs(query(collection(db,'users'),where('username','==',uname)));
    if(snap.empty){document.getElementById('find-result').innerHTML='<p style="color:var(--text2);font-size:13px;margin-top:8px">No user found.</p>';return;}
    const u=snap.docs[0].data();
    const isFriend=(CUD?.friends||[]).includes(u.uid);
    let alreadySent=false;
    try{const reqSnap=await getDoc(doc(db,'requests',CU.uid+'_'+u.uid));alreadySent=reqSnap.exists();}catch(re){}
    document.getElementById('find-result').innerHTML=`
      <div class="user-search-result">
        <div class="usr-av">${u.pfp?`<img src="${u.pfp}"/>`:(u.name||'?')[0].toUpperCase()}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:600">${esc(u.name)}</div>
          <div style="font-size:11px;color:var(--text2)">@${esc(u.username)}</div>
        </div>
        ${isFriend
          ?`<button class="req-btn accept" onclick="openDMWithUid('${u.uid}','${esc(u.name)}','${u.pfp||''}','${esc(u.username)}')">üí¨ Chat</button>`
          :alreadySent
            ?`<button class="req-btn decline" disabled>‚úì Sent</button>`
            :`<button class="req-btn accept" onclick="sendFriendReq('${u.uid}','${esc(u.name)}','${u.pfp||''}','${esc(u.username)}')">‚ûï Add</button>`
        }
      </div>`;
  }catch(e){showErr('find-err',e.message);}
};
window.sendFriendReq=async function(toUid,toName,toPfp,toUsername){
  try{
    await setDoc(doc(db,'requests',CU.uid+'_'+toUid),{from:CU.uid,fromName:CUD?.name||CU.displayName,fromPfp:CUD?.pfp||'',fromUsername:CUD?.username||'',to:toUid,toName,toPfp,toUsername,status:'pending',createdAt:serverTimestamp()});
    toast('Friend request sent to @'+toUsername+' ‚úÖ');window.findUser();
  }catch(e){toast('‚ùå '+e.message);}
};
window.openDMWithUid=async function(uid,name,pfp,username){
  const cid=chatId(CU.uid,uid);
  await setDoc(doc(db,'chats',cid),{type:'private',members:[CU.uid,uid],memberData:{[CU.uid]:{name:CUD?.name||CU.displayName,pfp:CUD?.pfp||'',username:CUD?.username||''},[uid]:{name,pfp,username}},lastMsg:'',lastTime:serverTimestamp(),unread:{}},{merge:true});
  closeModal('find-overlay');openChat(cid,'private');
};

function listenRequests(){
  if(reqUnsub)reqUnsub();
  const q=query(collection(db,'requests'),where('to','==',CU.uid),where('status','==','pending'));
  reqUnsub=onSnapshot(q,snap=>{
    const reqs=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderRequests(reqs);
    const badge=document.getElementById('req-badge');
    if(reqs.length){badge.textContent=reqs.length;badge.classList.add('show');}
    else badge.classList.remove('show');
  });
}
function renderRequests(reqs){
  const pane=document.getElementById('pane-requests');
  if(!reqs.length){pane.innerHTML='<div class="empty-list"><div class="ei">üëã</div>No pending requests</div>';return;}
  pane.innerHTML=reqs.map(r=>`
    <div class="req-item">
      <div class="ci-av" style="width:40px;height:40px;flex-shrink:0">${r.fromPfp?`<img src="${r.fromPfp}"/>`:(r.fromName||'?')[0].toUpperCase()}</div>
      <div class="req-info"><div class="req-name">${esc(r.fromName)}</div><div class="req-user">@${esc(r.fromUsername)}</div></div>
      <div class="req-actions">
        <button class="req-btn accept" onclick="acceptReq('${r.id}','${r.from}','${esc(r.fromName)}','${r.fromPfp||''}','${esc(r.fromUsername)}')">‚úì Accept</button>
        <button class="req-btn decline" onclick="declineReq('${r.id}')">‚úï</button>
      </div>
    </div>`).join('');
}
window.acceptReq=async function(reqId,fromUid,fromName,fromPfp,fromUsername){
  try{
    await updateDoc(doc(db,'requests',reqId),{status:'accepted'});
    await updateDoc(doc(db,'users',CU.uid),{friends:arrayUnion(fromUid)});
    await updateDoc(doc(db,'users',fromUid),{friends:arrayUnion(CU.uid)});
    const cid=chatId(CU.uid,fromUid);
    await setDoc(doc(db,'chats',cid),{type:'private',members:[CU.uid,fromUid],memberData:{[CU.uid]:{name:CUD?.name||CU.displayName,pfp:CUD?.pfp||'',username:CUD?.username||''},[fromUid]:{name:fromName,pfp:fromPfp,username:fromUsername}},lastMsg:'',lastTime:serverTimestamp(),unread:{}},{merge:true});
    CUD={...CUD,friends:[...(CUD?.friends||[]),fromUid]};
    toast('You and @'+fromUsername+' are now friends! üéâ');
  }catch(e){toast('‚ùå '+e.message);}
};
window.declineReq=async function(reqId){
  try{await updateDoc(doc(db,'requests',reqId),{status:'declined'});toast('Request declined');}
  catch(e){toast('‚ùå '+e.message);}
};

function loadChats(){
  if(chatsUnsub)chatsUnsub();
  const q=query(collection(db,'chats'),where('members','array-contains',CU.uid));
  chatsUnsub=onSnapshot(q,snap=>{
    const all=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderChatPane('pane-chats',all.filter(i=>i.type==='private'));
    renderChatPane('pane-groups',all.filter(i=>i.type==='group'));
  });
}
function renderChatPane(paneId,items){
  const pane=document.getElementById(paneId);
  const isGroup=paneId==='pane-groups';
  if(!items.length){pane.innerHTML=`<div class="empty-list"><div class="ei">${isGroup?'üë•':'üí¨'}</div>${isGroup?'No groups yet':'No chats yet. Add a friend!'}</div>`;return;}
  items.sort((a,b)=>(b.lastTime?.seconds||0)-(a.lastTime?.seconds||0));
  pane.innerHTML=items.map(item=>{
    let name='',pfp='',last=item.lastMsg||'';
    if(item.type==='group'){name=item.name||'Group';pfp=item.icon||'';}
    else{const other=item.members?.find(m=>m!==CU.uid);const od=item.memberData?.[other]||{};name=od.name||'Unknown';pfp=od.pfp||'';}
    const unread=item.unread?.[CU.uid]||0;
    const av=pfp?`<div class="ci-av"><img src="${pfp}" onerror="this.style.display='none'"/></div>`:`<div class="ci-av">${(name[0]||'?').toUpperCase()}</div>`;
    return`<div class="ci${activeChatId===item.id?' active':''}" onclick="openChat('${item.id}','${item.type||'private'}')" data-id="${item.id}">
      ${av}
      <div class="ci-info"><div class="ci-name">${esc(name)}</div><div class="ci-last">${esc(last)}</div></div>
      <div class="ci-meta"><span class="ci-time">${fmtTime(item.lastTime)}</span>${unread?`<span class="ci-badge">${unread}</span>`:''}</div>
    </div>`;
  }).join('');
}
window.filterChats=function(val){
  document.querySelectorAll('.ci').forEach(el=>{
    el.style.display=el.querySelector('.ci-name').textContent.toLowerCase().includes(val.toLowerCase())?'':'none';
  });
};
window.switchSideTab=function(tab,el){
  document.querySelectorAll('.stab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.getElementById('pane-'+tab).classList.add('active');
};

window.openChat=async function(cid,type){
  if(msgsUnsub){msgsUnsub();msgsUnsub=null;}
  document.getElementById('msgs').innerHTML='';
  // FIX Bug 3: Reset all UI immediately before any awaits to prevent stale UI leaking between chats
  document.getElementById('gc-rules-banner').classList.remove('show');
  document.getElementById('gc-rules-text').textContent='';
  document.getElementById('ch-name').textContent='Loading...';
  document.getElementById('ch-sub').textContent='';
  document.getElementById('ch-avatar').innerHTML='';
  hideTagSuggest();
  cancelEdit();

  activeChatId=cid;activeChatType=type;
  document.getElementById('sidebar').classList.add('hidden');
  document.getElementById('no-chat').style.display='none';
  document.getElementById('active-chat').style.display='flex';
  document.querySelectorAll('.ci').forEach(el=>el.classList.toggle('active',el.dataset.id===cid));
  const gcBanner=document.getElementById('gc-rules-banner');
  try{
    const snap=await getDoc(doc(db,'chats',cid));
    if(!snap.exists())return;
    activeChatData={id:snap.id,...snap.data()};
    const d=activeChatData;
    const chAv=document.getElementById('ch-avatar');
    if(type==='group'){
      document.getElementById('ch-name').textContent=d.name||'Group';
      document.getElementById('ch-sub').textContent=(d.members||[]).length+' members';
      chAv.innerHTML=d.icon?`<img src="${d.icon}"/>`:(d.name||'G')[0].toUpperCase();
      gcMembers=d.members||[];
      if(d.rules?.length){gcBanner.classList.add('show');document.getElementById('gc-rules-text').textContent=d.rules.join(' ‚Ä¢ ');}
      else gcBanner.classList.remove('show');
    }else{
      gcBanner.classList.remove('show');
      gcMembers=[];
      const other=d.members?.find(m=>m!==CU.uid);
      const od=d.memberData?.[other]||{};
      document.getElementById('ch-name').textContent=od.name||'User';
      document.getElementById('ch-sub').textContent=od.username?'@'+od.username:'Private chat';
      chAv.innerHTML=od.pfp?`<img src="${od.pfp}"/>`:(od.name||'U')[0].toUpperCase();
    }
    try{await updateDoc(doc(db,'chats',cid),{[`unread.${CU.uid}`]:0});}catch(e){}
  }catch(e){console.error('openChat',e);}
  loadMessages(cid);
};
window.closeChat=function(){
  document.getElementById('sidebar').classList.remove('hidden');
  document.getElementById('active-chat').style.display='none';
  document.getElementById('no-chat').style.display='flex';
  if(msgsUnsub){msgsUnsub();msgsUnsub=null;}
  document.getElementById('msgs').innerHTML='';
  activeChatId=null;activeChatType=null;activeChatData=null;
  gcMembers=[];cancelEdit();hideTagSuggest();
};

const _msgCache={};
function loadMessages(cid){
  if(msgsUnsub){msgsUnsub();msgsUnsub=null;}
  document.getElementById('msgs').innerHTML='';
  // FIX Bug 4: Capture chatType at load time so switching chats can't corrupt message rendering
  const capturedType=activeChatType;
  const q=query(collection(db,'chats',cid,'messages'),orderBy('timestamp','asc'));
  msgsUnsub=onSnapshot(q,snap=>{
    if(activeChatId!==cid)return;
    snap.docs.forEach(d=>{_msgCache[d.id]={id:d.id,...d.data()};});
    renderMsgs(snap.docs.map(d=>({id:d.id,...d.data()})),capturedType);
    snap.docChanges().forEach(ch=>{
      if(ch.type==='added'){
        const m={id:ch.doc.id,...ch.doc.data()};
        if(m.senderId!==CU.uid&&m.tags?.includes(CU.uid)){
          toast(`@${m.senderUsername||m.senderName} tagged you!`,3500,()=>{
            document.getElementById('msg_'+m.id)?.scrollIntoView({behavior:'smooth',block:'center'});
          });
        }
      }
    });
  });
}
function renderMsgs(msgs,chatType){
  const c=document.getElementById('msgs');
  const atBot=c.scrollHeight-c.scrollTop-c.clientHeight<150;
  c.innerHTML=msgs.map(m=>renderMsg(m,chatType)).join('');
  if(atBot||msgs.length<=2)c.scrollTop=c.scrollHeight;
  msgs.forEach(m=>{
    if(m.senderId===CU.uid&&!m.deleted&&!m.edited&&m.timestamp){
      const sl=secsLeft(m.timestamp);
      if(sl>0){
        const el=document.getElementById('etimer_'+m.id);
        if(el){
          clearInterval(editTimers[m.id]);
          editTimers[m.id]=setInterval(()=>{
            const e=document.getElementById('etimer_'+m.id);
            if(!e){clearInterval(editTimers[m.id]);return;}
            const s=secsLeft(m.timestamp);
            if(s>0)e.textContent='‚úèÔ∏è '+s+'s';
            else{e.style.display='none';clearInterval(editTimers[m.id]);}
          },1000);
        }
      }
    }
  });
}
function renderMsg(m,chatType){
  const isOut=m.senderId===CU.uid;
  if(m.deleted)return`<div class="mw ${isOut?'out':'in'}"><div class="mb deleted">üö´ Deleted</div><span class="m-time">${fmtTime(m.timestamp)}</span></div>`;
  const sl=secsLeft(m.timestamp);
  const attr=`oncontextmenu="showCtx(event,'${m.id}')" ondblclick="showCtx(event,'${m.id}')" id="msg_${m.id}"`;
  let content='';
  if(m.type==='text')content=`<div class="mb${m.edited?' edited':''}" ${attr}>${formatText(esc(m.text||''))}</div>`;
  else if(m.type==='image')content=`<div class="mb" ${attr}><img class="m-img" src="${m.url}" onclick="openImgViewer('${m.url}')"/></div>`;
  else if(m.type==='audio')content=`<div class="mb m-audio" ${attr}><audio controls src="${m.url}" style="width:210px"></audio></div>`;
  const reactions=m.reactions||{};
  const rHtml=Object.entries(reactions).filter(([,v])=>v?.length).map(([e,u])=>
    `<div class="rpill${u.includes(CU.uid)?' mine':''}" onclick="reactMsg('${m.id}','${e}')">${e}<span class="rc">${u.length}</span></div>`).join('');
  // FIX Bug 4: Use captured chatType param instead of global activeChatType
  const sName=!isOut&&chatType==='group'?`<div class="m-sender">${esc(m.senderName||'')}</div>`:'';
  const timerHtml=isOut&&!m.edited&&sl>0?`<span class="edit-timer" id="etimer_${m.id}">‚úèÔ∏è ${sl}s</span>`:'';
  return`<div class="mw ${isOut?'out':'in'}">${sName}${content}${rHtml?`<div class="m-reactions">${rHtml}</div>`:''}<span class="m-time">${fmtTime(m.timestamp)}</span>${timerHtml}</div>`;
}
function formatText(txt){return txt.replace(/@(\w+)/g,'<span class="tag-highlight">@$1</span>');}

window.sendMessage=async function(){
  if(!activeChatId)return;
  const ta=document.getElementById('msg-txt');
  const txt=ta.value.trim();if(!txt)return;
  if(editingMsgId){
    try{
      const mRef=doc(db,'chats',activeChatId,'messages',editingMsgId);
      const snap=await getDoc(mRef);
      if(!snap.exists()||snap.data().senderId!==CU.uid){toast('‚ùå Cannot edit');cancelEdit();return;}
      if(secsLeft(snap.data().timestamp)===0){toast('‚è∞ Edit window closed');cancelEdit();return;}
      await updateDoc(mRef,{text:txt,edited:true,editedAt:serverTimestamp()});
    }catch(e){toast('‚ùå '+e.message);}
    cancelEdit();ta.value='';autoResize(ta);return;
  }
  let tags=[];
  if(activeChatType==='group'){
    const tagMatches=[...txt.matchAll(/@(\w+)/g)].map(m=>m[1]);
    for(const uname of tagMatches){
      try{const s=await getDocs(query(collection(db,'users'),where('username','==',uname)));if(!s.empty)tags.push(s.docs[0].data().uid);}catch(e){}
    }
  }
  ta.value='';autoResize(ta);
  try{
    await addDoc(collection(db,'chats',activeChatId,'messages'),{type:'text',text:txt,senderId:CU.uid,senderName:CUD?.name||CU.displayName||'User',senderUsername:CUD?.username||'',timestamp:serverTimestamp(),reactions:{},tags,deleted:false,edited:false});
    await updateChatMeta(txt);
  }catch(e){toast('‚ùå '+e.message);}
};
window.handleEnter=function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}};
async function updateChatMeta(lastMsg){
  if(!activeChatId)return;
  try{
    const snap=await getDoc(doc(db,'chats',activeChatId));
    const d=snap.data()||{};
    const unread={...d.unread||{}};
    (d.members||[]).forEach(m=>{if(m!==CU.uid)unread[m]=(unread[m]||0)+1;});
    await updateDoc(doc(db,'chats',activeChatId),{lastMsg,lastTime:serverTimestamp(),unread});
  }catch(e){}
}
window.sendMedia=async function(input){
  if(!activeChatId||!input.files[0])return;
  const file=input.files[0];toast('Uploading... üì§');
  try{
    const url=await uploadCloud(file,'media');
    await addDoc(collection(db,'chats',activeChatId,'messages'),{type:'image',url,senderId:CU.uid,senderName:CUD?.name||CU.displayName||'User',timestamp:serverTimestamp(),reactions:{},tags:[],deleted:false,edited:false});
    await updateChatMeta(file.type.startsWith('video')?'üé• Video':'üì∑ Photo');
    toast('Sent ‚úÖ');
  }catch(e){toast('‚ùå '+e.message);}
  input.value='';
};

window.toggleVN=async function(){
  if(mediaRecorder&&mediaRecorder.state==='recording'){stopAndSendVN();return;}
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const targetChatId=activeChatId;
    mediaRecorder=new MediaRecorder(stream);recChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recChunks.push(e.data);};
    mediaRecorder.onstop=async()=>{
      stream.getTracks().forEach(t=>t.stop());
      if(!recChunks.length||!targetChatId)return;
      const blob=new Blob(recChunks,{type:'audio/webm'});
      const file=new File([blob],`vn_${Date.now()}.webm`,{type:'audio/webm'});
      toast('Sending voice note...');
      try{
        const url=await uploadCloud(file,'voicenotes');
        await addDoc(collection(db,'chats',targetChatId,'messages'),{type:'audio',url,senderId:CU.uid,senderName:CUD?.name||CU.displayName||'User',timestamp:serverTimestamp(),reactions:{},tags:[],deleted:false,edited:false});
        const snapMeta=await getDoc(doc(db,'chats',targetChatId));
        const dMeta=snapMeta.data()||{};
        const unreadMeta={...dMeta.unread||{}};
        (dMeta.members||[]).forEach(m=>{if(m!==CU.uid)unreadMeta[m]=(unreadMeta[m]||0)+1;});
        await updateDoc(doc(db,'chats',targetChatId),{lastMsg:'üé§ Voice note',lastTime:serverTimestamp(),unread:unreadMeta});
        toast('Sent ‚úÖ');
      }catch(e){toast('‚ùå VN failed: '+e.message);}
    };
    mediaRecorder.start();startRecTimer();
    document.getElementById('normal-iw').style.display='none';
    document.getElementById('vn-bar').classList.add('show');
    document.getElementById('vn-btn').style.display='none';
  }catch(e){
    resetVNUI();
    toast('‚ùå Mic access denied');
  }
};
window.stopAndSendVN=function(){if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();stopRecTimer();resetVNUI();};
window.cancelVN=function(){
  if(mediaRecorder&&mediaRecorder.state==='recording'){mediaRecorder.onstop=()=>{};mediaRecorder.stop();}
  recChunks=[];stopRecTimer();resetVNUI();
};
function resetVNUI(){
  mediaRecorder=null;
  document.getElementById('normal-iw').style.display='flex';
  document.getElementById('vn-bar').classList.remove('show');
  document.getElementById('vn-btn').style.display='flex';
}
function startRecTimer(){
  recSeconds=0;document.getElementById('rec-time').textContent='0:00';
  recTimer=setInterval(()=>{recSeconds++;document.getElementById('rec-time').textContent=Math.floor(recSeconds/60)+':'+(recSeconds%60+'').padStart(2,'0');},1000);
}
function stopRecTimer(){clearInterval(recTimer);recTimer=null;recSeconds=0;}

window.showCtx=function(e,msgId){
  e.preventDefault();
  ctxMsgId=msgId;
  ctxMsgData=_msgCache[msgId]||null;
  if(!ctxMsgData)return;
  const menu=document.getElementById('msg-ctx-menu');
  const isOwn=ctxMsgData.senderId===CU.uid;
  const isAdmin=activeChatType==='group'&&activeChatData?.admins?.includes(CU.uid);
  const canEdit=isOwn&&!ctxMsgData.deleted&&!ctxMsgData.edited&&secsLeft(ctxMsgData.timestamp)>0&&ctxMsgData.type==='text';
  document.getElementById('ctx-edit').style.display=canEdit?'flex':'none';
  document.getElementById('ctx-delete').style.display=isOwn&&!ctxMsgData.deleted?'flex':'none';
  document.getElementById('ctx-admin-delete').style.display=isAdmin&&!isOwn&&!ctxMsgData.deleted?'flex':'none';
  menu.style.left=Math.min(e.clientX,window.innerWidth-170)+'px';
  menu.style.top=Math.min(e.clientY,window.innerHeight-180)+'px';
  menu.classList.add('show');
};
function hideCtxMenu(){document.getElementById('msg-ctx-menu').classList.remove('show');ctxMsgId=null;ctxMsgData=null;}
window.showEmojiFromCtx=function(){
  if(!ctxMsgId)return;
  const menu=document.getElementById('msg-ctx-menu');
  const ep=document.getElementById('global-ep');
  ep.innerHTML=EMOJIS.map(e=>`<button onclick="reactMsg('${ctxMsgId}','${e}');document.getElementById('global-ep').classList.remove('show')">${e}</button>`).join('');
  ep.style.left=menu.style.left;ep.style.top=(parseInt(menu.style.top)-68)+'px';
  ep.classList.add('show');hideCtxMenu();
};
window.startEdit=function(){
  if(!ctxMsgId||!ctxMsgData)return;
  if(ctxMsgData.senderId!==CU.uid){hideCtxMenu();return;}
  if(secsLeft(ctxMsgData.timestamp)===0){toast('‚è∞ Edit window closed');hideCtxMenu();return;}
  editingMsgId=ctxMsgId;
  document.getElementById('msg-txt').value=ctxMsgData.text||'';
  document.getElementById('edit-preview').textContent=ctxMsgData.text||'';
  document.getElementById('edit-bar').classList.add('show');
  document.getElementById('msg-txt').focus();
  hideCtxMenu();
};
window.cancelEdit=function(){editingMsgId=null;document.getElementById('edit-bar').classList.remove('show');document.getElementById('msg-txt').value='';};

window.deleteMsg=async function(){
  if(!ctxMsgId||!activeChatId)return;
  hideCtxMenu();
  try{
    const mRef=doc(db,'chats',activeChatId,'messages',ctxMsgId);
    const snap=await getDoc(mRef);
    if(!snap.exists())return;
    await updateDoc(mRef,{deleted:true,text:'',url:''});
    toast('Message deleted');
  }catch(e){toast('‚ùå '+e.message);}
};
window.adminDeleteMsg=async function(){
  if(!ctxMsgId||!activeChatId)return;
  hideCtxMenu();
  try{
    const mRef=doc(db,'chats',activeChatId,'messages',ctxMsgId);
    const snap=await getDoc(mRef);
    if(!snap.exists())return;
    await updateDoc(mRef,{deleted:true,text:'',url:''});
    toast('Deleted');
  }catch(e){toast('‚ùå '+e.message);}
};
window.reactMsg=async function(msgId,emoji){
  if(!activeChatId)return;
  try{
    const mRef=doc(db,'chats',activeChatId,'messages',msgId);
    const snap=await getDoc(mRef);if(!snap.exists())return;
    const users=snap.data().reactions?.[emoji]||[];
    if(users.includes(CU.uid))await updateDoc(mRef,{[`reactions.${emoji}`]:arrayRemove(CU.uid)});
    else await updateDoc(mRef,{[`reactions.${emoji}`]:arrayUnion(CU.uid)});
  }catch(e){}
};

window.handleInput=function(el){
  autoResize(el);
  const before=el.value.slice(0,el.selectionStart);
  const match=before.match(/@(\w*)$/);
  if(match&&activeChatType==='group')showTagSuggest(match[1]);
  else hideTagSuggest();
};
async function showTagSuggest(partial){
  if(!gcMembers.length){hideTagSuggest();return;}
  const sug=document.getElementById('tag-suggest');
  const matches=[];
  const memberData=activeChatData?.memberData||{};
  for(const uid of gcMembers){
    if(uid===CU.uid)continue;
    const u=memberData[uid];
    if(!u)continue;
    if(!partial||u.username?.startsWith(partial)||u.name?.toLowerCase().startsWith(partial.toLowerCase()))
      matches.push({...u,uid});
    if(matches.length>=5)break;
  }
  if(!matches.length){hideTagSuggest();return;}
  sug.innerHTML=matches.map(u=>`
    <div class="tag-opt" onclick="insertTag('${u.username}')">
      ${u.pfp?`<img src="${u.pfp}"/>`:`<div class="tag-av">${(u.name||'?')[0]}</div>`}
      <span>@${esc(u.username)} <span style="color:var(--text2);font-size:11px">${esc(u.name)}</span></span>
    </div>`).join('');
  sug.classList.add('show');
}
function hideTagSuggest(){document.getElementById('tag-suggest').classList.remove('show');}
window.insertTag=function(username){
  const ta=document.getElementById('msg-txt');
  const cursor=ta.selectionStart;
  const before=ta.value.slice(0,cursor).replace(/@\w*$/,'@'+username+' ');
  ta.value=before+ta.value.slice(cursor);
  ta.focus();ta.selectionStart=ta.selectionEnd=before.length;
  hideTagSuggest();
};

window.openGcModal=function(){
  gcMembersToAdd=[];gcRulesArr=[];
  document.getElementById('gc-name').value='';document.getElementById('gc-desc').value='';
  document.getElementById('gc-members-list').innerHTML='';document.getElementById('rules-preview').innerHTML='';
  document.getElementById('gc-icon-preview').innerHTML='üë•';pendingGcIconFile=null;hideErr('gc-err');
  document.getElementById('gc-overlay').classList.add('show');
};
window.addGcMember=async function(){
  const uname=document.getElementById('gc-member-input').value.trim().replace('@','');
  if(!uname||uname===CUD?.username||gcMembersToAdd.find(m=>m.username===uname))return;
  try{
    const snap=await getDocs(query(collection(db,'users'),where('username','==',uname)));
    if(snap.empty){toast('@'+uname+' not found.');return;}
    gcMembersToAdd.push(snap.docs[0].data());
    document.getElementById('gc-member-input').value='';renderGcMembers();
  }catch(e){toast('‚ùå '+e.message);}
};
function renderGcMembers(){
  document.getElementById('gc-members-list').innerHTML=gcMembersToAdd.map((m,i)=>
    `<div style="display:flex;align-items:center;gap:8px;background:var(--bg3);padding:7px 10px;border-radius:var(--radius-sm)">
      <span style="font-size:12px;flex:1">${esc(m.name)} @${esc(m.username)}</span>
      <button onclick="removeGcMember(${i})" style="background:none;border:none;color:var(--danger);cursor:pointer">‚úï</button>
    </div>`).join('');
}
window.removeGcMember=function(i){gcMembersToAdd.splice(i,1);renderGcMembers();};
window.addRuleInput=function(){
  const rule=document.getElementById('gc-rule-input').value.trim();if(!rule)return;
  gcRulesArr.push(rule);document.getElementById('gc-rule-input').value='';
  document.getElementById('rules-preview').innerHTML=gcRulesArr.map((r,i)=>`<li class="rule-item">üìå ${esc(r)}<button onclick="removeRule(${i})">‚úï</button></li>`).join('');
};
window.removeRule=function(i){gcRulesArr.splice(i,1);document.getElementById('rules-preview').innerHTML=gcRulesArr.map((r,j)=>`<li class="rule-item">üìå ${esc(r)}<button onclick="removeRule(${j})">‚úï</button></li>`).join('');};
window.createGroup=async function(){
  const name=document.getElementById('gc-name').value.trim();
  if(!name){showErr('gc-err','Group name required.');return;}
  const btn=document.querySelector('#gc-overlay .btn:not(.btn-ghost)');
  btn.disabled=true;btn.textContent='Creating...';
  try{
    let icon='';
    if(pendingGcIconFile){icon=await uploadCloud(pendingGcIconFile,'group-icons');pendingGcIconFile=null;}
    const allMembers=[CU.uid,...gcMembersToAdd.map(m=>m.uid)];
    const memberData={[CU.uid]:{name:CUD?.name||CU.displayName,pfp:CUD?.pfp||'',username:CUD?.username||''}};
    gcMembersToAdd.forEach(m=>{memberData[m.uid]={name:m.name,pfp:m.pfp||'',username:m.username||''};});
    const gcDoc=await addDoc(collection(db,'chats'),{type:'group',name,description:document.getElementById('gc-desc').value.trim(),icon,members:allMembers,memberData,admins:[CU.uid],rules:gcRulesArr,lastMsg:'Group created',lastTime:serverTimestamp(),unread:{}});
    closeModal('gc-overlay');toast('"'+name+'" created! üéâ');openChat(gcDoc.id,'group');
  }catch(e){showErr('gc-err',e.message);}
  finally{btn.disabled=false;btn.textContent='Create Group';}
};

window.openChatInfo=async function(){
  if(!activeChatId)return;
  const title=document.getElementById('chatinfo-title');
  const content=document.getElementById('chatinfo-content');
  const footer=document.getElementById('chatinfo-footer');
  try{
    if(activeChatType==='group'){
      const snap=await getDoc(doc(db,'chats',activeChatId));
      const d=snap.data()||{};
      title.textContent=d.name||'Group Info';
      const isAdmin=d.admins?.includes(CU.uid);
      const membersHtml=Object.entries(d.memberData||{}).map(([uid,m])=>`
        <div class="member-item">
          <div class="m-av">${m.pfp?`<img src="${m.pfp}"/>`:(m.name||'?')[0]}</div>
          <span>${esc(m.name)} ${m.username?`<span style="color:var(--text2);font-size:11px">@${esc(m.username)}</span>`:''}</span>
          ${d.admins?.includes(uid)?'<span class="badge">Admin</span>':''}
          ${isAdmin&&uid!==CU.uid?`<button onclick="adminRemoveMember('${uid}')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:12px;padding:2px 6px">Remove</button>`:''}
        </div>`).join('');
      const rulesHtml=d.rules?.length?`<div style="margin-top:14px"><strong style="font-size:12px;color:var(--accent)">üìã Rules</strong><ul class="rules-list" style="margin-top:6px">${d.rules.map(r=>`<li class="rule-item">üìå ${esc(r)}</li>`).join('')}</ul></div>`:'';
      const adminHtml=isAdmin?`<div style="margin-top:16px"><strong style="font-size:12px;color:var(--accent)">‚öôÔ∏è Admin Tools</strong>
        <div style="display:flex;gap:7px;margin-top:8px">
          <input type="text" id="admin-add-input" placeholder="@username to add" style="flex:1;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:12px;outline:none" oninput="this.value=this.value.replace(/[^a-z0-9_@]/g,'').toLowerCase()"/>
          <button class="ibtn" onclick="adminAddMember()" style="width:auto;padding:0 10px;border-radius:var(--radius-sm)">Add</button>
        </div>
        <div style="display:flex;gap:7px;margin-top:8px">
          <input type="text" id="admin-rule-input" placeholder="Add rule..." style="flex:1;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:12px;outline:none"/>
          <button class="ibtn" onclick="adminAddRule()" style="width:auto;padding:0 10px;border-radius:var(--radius-sm)">+</button>
        </div></div>`:'';
      content.innerHTML=`<p style="font-size:12px;color:var(--text2);margin-bottom:12px">${esc(d.description||'')}</p><div class="members-list">${membersHtml}</div>${rulesHtml}${adminHtml}`;
      footer.innerHTML=`<button class="btn btn-ghost" onclick="closeModal('chatinfo-overlay')">Close</button><button class="btn btn-danger" onclick="leaveGroup()">Leave</button>`;
    }else{
      const d=activeChatData||{};
      const other=d.members?.find(m=>m!==CU.uid);
      const od=d.memberData?.[other]||{};
      title.textContent='Contact Info';
      content.innerHTML=`<div style="text-align:center;padding:16px 0">
        ${od.pfp?`<img src="${od.pfp}" style="width:72px;height:72px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)"/>`:`<div class="ci-av" style="width:72px;height:72px;font-size:28px;margin:0 auto">${(od.name||'?')[0]}</div>`}
        <div style="font-size:16px;font-weight:600;margin-top:10px">${esc(od.name||'')}</div>
        ${od.username?`<div style="font-size:12px;color:var(--text2);margin-top:4px">@${esc(od.username)}</div>`:''}
      </div>`;
      footer.innerHTML=`<button class="btn btn-ghost" onclick="closeModal('chatinfo-overlay')">Close</button>`;
    }
  }catch(e){content.innerHTML='<p style="color:var(--danger)">Failed to load.</p>';}
  document.getElementById('chatinfo-overlay').classList.add('show');
};
window.adminAddMember=async function(){
  const uname=document.getElementById('admin-add-input')?.value.trim().replace('@','');
  if(!uname||!activeChatId)return;
  try{
    const snap=await getDocs(query(collection(db,'users'),where('username','==',uname)));
    if(snap.empty){toast('@'+uname+' not found.');return;}
    const u=snap.docs[0].data();
    if(activeChatData?.members?.includes(u.uid)){toast('Already a member.');return;}
    await updateDoc(doc(db,'chats',activeChatId),{members:arrayUnion(u.uid),[`memberData.${u.uid}`]:{name:u.name,pfp:u.pfp||'',username:u.username||''}});
    toast('@'+uname+' added ‚úÖ');openChatInfo();
  }catch(e){toast('‚ùå '+e.message);}
};
window.adminRemoveMember=async function(uid){
  if(!activeChatId)return;
  try{await updateDoc(doc(db,'chats',activeChatId),{members:arrayRemove(uid),[`memberData.${uid}`]:deleteField()});toast('Member removed');openChatInfo();}
  catch(e){toast('‚ùå '+e.message);}
};
window.adminAddRule=async function(){
  const rule=document.getElementById('admin-rule-input')?.value.trim();
  if(!rule||!activeChatId)return;
  try{await updateDoc(doc(db,'chats',activeChatId),{rules:arrayUnion(rule)});toast('Rule added ‚úÖ');openChatInfo();}
  catch(e){toast('‚ùå '+e.message);}
};
window.leaveGroup=async function(){
  if(!activeChatId)return;
  try{await updateDoc(doc(db,'chats',activeChatId),{members:arrayRemove(CU.uid),[`memberData.${CU.uid}`]:deleteField()});closeModal('chatinfo-overlay');closeChat();toast('You left the group');}
  catch(e){toast('‚ùå '+e.message);}
};

function listenNotifications(){
  if(!CU)return;
  const q=query(collection(db,'notifications'),where('to','==',CU.uid),where('read','==',false));
  onSnapshot(q,snap=>{
    snap.docs.forEach(async d=>{
      const n=d.data();
      if(n.type==='added_to_group')toast('Added to "'+n.groupName+'" üéâ',4000);
      else if(n.type==='removed_from_group')toast('Removed from "'+n.groupName+'"',4000);
      await updateDoc(d.ref,{read:true});
    });
  });
}

window.openStatusModal=function(){
  pendingStatusFile=null;
  document.getElementById('status-preview').innerHTML='';
  document.getElementById('status-caption').value='';
  hideErr('status-err');
  document.getElementById('status-overlay').classList.add('show');
};
window.postStatus=async function(){
  hideErr('status-err');
  if(!pendingStatusFile){showErr('status-err','Choose a photo or video.');return;}
  const btn=document.getElementById('status-post-btn');
  btn.disabled=true;btn.textContent='Uploading...';
  try{
    const url=await uploadCloud(pendingStatusFile,'statuses');
    await addDoc(collection(db,'statuses'),{
      uid:CU.uid,name:CUD?.name||CU.displayName||'User',pfp:CUD?.pfp||'',
      url,caption:document.getElementById('status-caption').value.trim(),
      mediaType:pendingStatusFile.type.startsWith('video')?'video':'image',
      timestamp:serverTimestamp(),
      expiresAt:Timestamp.fromMillis(Date.now()+24*3600*1000),
      viewers:[],viewerNames:[]
    });
    closeModal('status-overlay');pendingStatusFile=null;
    toast('Status posted! ‚úÖ');loadStatuses();
  }catch(e){showErr('status-err',e.message);}
  finally{btn.disabled=false;btn.textContent='Post Status';}
};

async function loadStatuses(){
  try{
    const snap=await getDocs(collection(db,'statuses'));
    const now=Date.now();
    const all=snap.docs.map(d=>({id:d.id,...d.data()})).filter(s=>{
      if(!s.expiresAt)return false;
      try{const exp=s.expiresAt.toDate?s.expiresAt.toDate():new Date(s.expiresAt);return exp.getTime()>now;}
      catch(e){return false;}
    });
    renderStatuses(all);
  }catch(e){console.error('loadStatuses',e);}
}
function renderStatuses(all){
  const row=document.getElementById('status-row');
  const mine=all.filter(s=>s.uid===CU.uid);
  const byUser={};
  all.filter(s=>s.uid!==CU.uid).forEach(s=>{if(!byUser[s.uid])byUser[s.uid]=[];byUser[s.uid].push(s);});
  const myAv=CUD?.pfp?`<img src="${CUD.pfp}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`:(CUD?.name?.[0]?.toUpperCase()||'üë§');
  const myClick=mine.length?`viewStatus(${JSON.stringify(mine).replace(/"/g,'&quot;')})`:'openStatusModal()';
  const myHtml=`<div class="st-item" onclick="${myClick}">
    <div class="st-ring${mine.length?' st-mine':' add-btn'}">${mine.length?myAv:'Ôºã'}</div>
    <span>${mine.length?'My Status':'Add Status'}</span>
  </div>`;
  const othersHtml=Object.entries(byUser).map(([uid,statuses])=>{
    const s=statuses[0];
    return`<div class="st-item" onclick='viewStatus(${JSON.stringify(statuses).replace(/'/g,"&#39;")})'>
      <div class="st-ring">${s.pfp?`<img src="${s.pfp}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`:(s.name||'?')[0].toUpperCase()}</div>
      <span>${esc(s.name||'')}</span>
    </div>`;
  }).join('');
  row.innerHTML=myHtml+othersHtml;
}

window.viewStatus=function(statuses){
  svStatuses=Array.isArray(statuses)?statuses:JSON.parse(statuses);
  svIdx=0;document.getElementById('sv').classList.add('show');showSVAt(0);
};

async function showSVAt(i){
  if(i>=svStatuses.length){closeSV();return;}
  svIdx=i;const s=svStatuses[i];
  const mediaEl=document.getElementById('sv-media');
  if(s.url){
    if(s.mediaType==='video'){
      mediaEl.innerHTML=`<video src="${s.url}" autoplay playsinline style="width:100%;height:100%;object-fit:contain;background:#000"></video>`;
    }else{
      mediaEl.innerHTML=`<img src="${s.url}" style="width:100%;height:100%;object-fit:contain"/>`;
    }
  }else{mediaEl.innerHTML='';}
  document.getElementById('sv-name').textContent=s.name||'';
  const avEl=document.getElementById('sv-av');
  if(s.pfp){avEl.src=s.pfp;avEl.style.display='block';}else{avEl.style.display='none';}
  document.getElementById('sv-time').textContent=fmtTime(s.timestamp);
  document.getElementById('sv-caption').textContent=s.caption||'';
  const isMine=s.uid===CU.uid;
  document.getElementById('sv-delete-btn').style.display=isMine?'inline-block':'none';
  const viewersEl=document.getElementById('sv-viewers');
  const viewerNamesEl=document.getElementById('sv-viewer-names');
  if(isMine){
    try{
      const freshSnap=await getDoc(doc(db,'statuses',s.id));
      if(freshSnap.exists()){
        const fresh=freshSnap.data();
        const viewerIds=fresh.viewers||[];
        const storedNames=fresh.viewerNames||[];
        const cnt=viewerIds.length;
        viewersEl.innerHTML=`üëÅ ${cnt} viewer${cnt!==1?'s':''}`;
        if(storedNames.length>0){
          viewerNamesEl.textContent='Viewed by: '+storedNames.slice(0,5).join(', ')+(cnt>5?` +${cnt-5} more`:'');
        }else if(cnt>0){
          const names=[];
          for(const uid of viewerIds.slice(0,5)){
            try{const usnap=await getDoc(doc(db,'users',uid));if(usnap.exists())names.push(usnap.data().name||'Unknown');}catch(e){}
          }
          viewerNamesEl.textContent='Viewed by: '+names.join(', ')+(cnt>5?` +${cnt-5} more`:'');
        }else{
          viewerNamesEl.textContent='No views yet';
        }
      }
    }catch(e){
      const cnt=s.viewers?.length||0;
      viewersEl.innerHTML=`üëÅ ${cnt} viewer${cnt!==1?'s':''}`;
      viewerNamesEl.textContent='';
    }
  }else{
    viewersEl.innerHTML='';
    viewerNamesEl.textContent='';
    try{
      const alreadyViewed=(s.viewers||[]).includes(CU.uid);
      if(!alreadyViewed){
        await updateDoc(doc(db,'statuses',s.id),{
          viewers:arrayUnion(CU.uid),
          viewerNames:arrayUnion(CUD?.name||CU.displayName||'Someone')
        });
      }
    }catch(e){}
  }
  const bars=document.getElementById('sv-bars');
  bars.innerHTML=svStatuses.map((_,j)=>`<div class="sv-bar"><div class="sv-fill" id="svfill_${j}" style="width:${j<i?'100':'0'}%"></div></div>`).join('');
  clearTimeout(svProg);
  if(s.mediaType==='video'){
    const vid=mediaEl.querySelector('video');
    if(vid){
      vid.onloadedmetadata=()=>{
        const duration=vid.duration||15;
        const fill=document.getElementById('svfill_'+i);
        if(fill){fill.style.transition=`width ${duration}s linear`;fill.style.width='100%';}
        svProg=setTimeout(()=>showSVAt(i+1),duration*1000+100);
      };
      vid.onerror=()=>{
        const fill=document.getElementById('svfill_'+i);
        if(fill){fill.style.transition='width 15s linear';fill.style.width='100%';}
        svProg=setTimeout(()=>showSVAt(i+1),15100);
      };
    }
  }else{
    requestAnimationFrame(()=>{
      const fill=document.getElementById('svfill_'+i);
      if(fill){fill.style.transition='width 8s linear';fill.style.width='100%';}
    });
    svProg=setTimeout(()=>showSVAt(i+1),8100);
  }
}

window.closeSV=function(){
  clearTimeout(svProg);
  document.getElementById('sv').classList.remove('show');
  document.getElementById('sv-media').innerHTML='';
  document.getElementById('sv-viewers').innerHTML='';
  document.getElementById('sv-viewer-names').textContent='';
};
window.deleteStatus=async function(){
  const s=svStatuses[svIdx];
  if(!s||s.uid!==CU.uid)return;
  try{
    await deleteDoc(doc(db,'statuses',s.id));
    svStatuses.splice(svIdx,1);
    if(svStatuses.length)showSVAt(Math.min(svIdx,svStatuses.length-1));
    else closeSV();
    toast('Status deleted ‚úÖ');loadStatuses();
  }catch(e){toast('‚ùå '+e.message);}
};

window.openImgViewer=function(url){document.getElementById('viewer-img').src=url;document.getElementById('img-viewer').classList.add('show');};
window.closeImgViewer=function(){document.getElementById('img-viewer').classList.remove('show');};
document.getElementById('img-viewer').addEventListener('click',function(e){if(e.target===this)closeImgViewer();});

window.closeModal=function(id){document.getElementById(id).classList.remove('show');};
document.querySelectorAll('.overlay').forEach(ov=>ov.addEventListener('click',function(e){if(e.target===this)closeModal(this.id);}));
window.autoResize=function(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';};

async function setOnline(){if(!CU)return;try{await setDoc(doc(db,'users',CU.uid),{lastSeen:serverTimestamp()},{merge:true});}catch(e){}}
setInterval(setOnline,30000);
document.addEventListener('visibilitychange',()=>{if(!document.hidden)setOnline();});
</script>
</body>
</html>
