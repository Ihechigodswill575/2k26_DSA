<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="theme-color" content="#0a0f1e"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="mobile-web-app-capable" content="yes"/>
<title>2k26_DSA</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#0a0f1e;--bg2:#111827;--bg3:#1f2937;--bg4:#263045;
  --accent:#00d4aa;--accent2:#0099ff;
  --text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;
  --border:#1e293b;--danger:#ef4444;--warn:#f59e0b;--success:#10b981;
  --radius:14px;--radius-sm:10px;--radius-xs:6px;
  --transition:0.2s ease;--shadow:0 8px 32px rgba(0,0,0,0.5);
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}

/* SPLASH */
#splash{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.7s ease}
#splash.hide{opacity:0;pointer-events:none}
#splash img{width:110px;height:110px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);box-shadow:0 0 0 8px rgba(0,212,170,0.08),0 0 60px rgba(0,212,170,0.2);animation:splashPop 0.8s cubic-bezier(0.34,1.56,0.64,1) 0.2s both}
#splash h1{margin-top:20px;font-size:28px;font-weight:800;letter-spacing:3px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:fadeUp 0.7s ease 0.6s both}
#splash p{margin-top:6px;color:var(--text2);font-size:13px;animation:fadeUp 0.7s ease 0.8s both}
.splash-bar{width:160px;height:3px;background:var(--border);border-radius:3px;margin-top:40px;overflow:hidden;animation:fadeUp 0.5s ease 1s both}
.splash-fill{height:100%;width:0;border-radius:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));animation:fillBar 2s ease 1.2s forwards}
@keyframes splashPop{from{opacity:0;transform:scale(0.4)}to{opacity:1;transform:scale(1)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fillBar{to{width:100%}}
@keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-16px)}to{opacity:1;transform:translateX(0)}}
@keyframes popIn{from{opacity:0;transform:scale(0.82)}to{opacity:1;transform:scale(1)}}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
@keyframes devAppear{0%{opacity:0;letter-spacing:6px;transform:translateY(8px)}100%{opacity:1;letter-spacing:2px;transform:translateY(0)}}
@keyframes devGlow{0%,100%{text-shadow:0 0 8px rgba(0,212,170,0.4)}50%{text-shadow:0 0 20px rgba(0,212,170,0.9),0 0 40px rgba(0,153,255,0.4)}}
.splash-credit{margin-top:10px;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--accent);text-transform:uppercase;animation:devAppear 0.8s cubic-bezier(0.34,1.2,0.64,1) 1.8s both,devGlow 2s ease 2.6s infinite;opacity:0}

/* AUTH */
#auth{display:none;position:fixed;inset:0;background:var(--bg);z-index:100;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;padding-top:calc(24px + var(--safe-top))}
#auth.show{display:flex}
.auth-card{background:var(--bg2);border:1px solid var(--border);border-radius:22px;padding:32px 26px;width:100%;max-width:390px;box-shadow:var(--shadow);animation:slideUp 0.5s cubic-bezier(0.34,1.2,0.64,1);margin:auto}
.auth-logo{text-align:center;margin-bottom:26px}
.auth-logo img{width:72px;height:72px;border-radius:50%;border:2.5px solid var(--accent);box-shadow:0 0 24px rgba(0,212,170,0.2);margin-bottom:12px}
.auth-logo h2{font-size:22px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-logo p{color:var(--text2);font-size:12px;margin-top:4px}
.auth-tabs{display:flex;gap:4px;background:var(--bg3);padding:4px;border-radius:var(--radius-sm);margin-bottom:22px}
.auth-tab{flex:1;padding:9px;text-align:center;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;color:var(--text2);transition:all 0.25s}
.auth-tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;box-shadow:0 4px 12px rgba(0,212,170,0.25)}
.fg{margin-bottom:15px;position:relative}
.fg label{display:block;font-size:11px;color:var(--text2);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:0.7px}
.fg input{width:100%;padding:11px 14px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:14px;outline:none;transition:all 0.2s}
.fg input:focus{border-color:var(--accent);background:rgba(0,212,170,0.04);box-shadow:0 0 0 3px rgba(0,212,170,0.08)}
.fg .hint{font-size:11px;color:var(--text3);margin-top:4px}
.pw-wrap{position:relative}
.pw-wrap input{padding-right:44px!important}
.eye-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text3);cursor:pointer;font-size:17px;padding:4px;display:flex;align-items:center;justify-content:center;transition:color 0.2s}
.eye-btn:hover{color:var(--text2)}
.pfp-row{display:flex;align-items:center;gap:14px;margin-bottom:16px}
.pfp-circle{width:54px;height:54px;border-radius:50%;background:var(--bg3);border:2px dashed var(--border);cursor:pointer;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:22px;transition:all 0.2s}
.pfp-circle:hover{border-color:var(--accent);transform:scale(1.05)}
.pfp-circle img{width:100%;height:100%;object-fit:cover}
.pfp-label{font-size:12px;color:var(--accent);cursor:pointer;display:block;font-weight:600}
.pfp-hint{font-size:11px;color:var(--text3);margin-top:3px}
.btn{width:100%;padding:12px;border:none;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;overflow:hidden}
.btn:active{transform:scale(0.97)}
.btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.btn-ghost{background:transparent;border:1.5px solid var(--border);color:var(--text2)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.err{color:var(--danger);font-size:12px;margin-top:8px;display:none;word-break:break-word;line-height:1.5;padding:8px 12px;background:rgba(239,68,68,0.07);border-radius:var(--radius-xs);border-left:3px solid var(--danger)}

/* MAIN */
#main{display:none;height:100%;padding-top:var(--safe-top)}
#main.show{display:flex}
.app-wrap{display:flex;height:100%;width:100%;overflow:hidden}

/* SIDEBAR */
.sidebar{width:330px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;transition:transform 0.3s cubic-bezier(0.4,0,0.2,1)}
.s-header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
.s-header h2{font-size:18px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr-actions{display:flex;gap:5px;align-items:center}
.ibtn{width:36px;height:36px;border-radius:50%;background:var(--bg3);border:none;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;font-size:15px;position:relative;flex-shrink:0}
.ibtn:hover{background:var(--border);color:var(--text);transform:scale(1.06)}
.ibtn:active{transform:scale(0.91)}

/* STATUS ROW */
.status-row{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:12px;overflow-x:auto;flex-shrink:0;scrollbar-width:none}
.status-row::-webkit-scrollbar{display:none}
.st-item{display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;flex-shrink:0;transition:transform 0.15s}
.st-item:active{transform:scale(0.92)}
.st-ring{width:50px;height:50px;border-radius:50%;border:2.5px solid var(--accent);padding:2.5px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0}
.st-ring img{width:100%;height:100%;border-radius:50%;object-fit:cover}
.st-ring.add-btn{border-color:var(--border);background:var(--bg3);font-size:20px;color:var(--accent);border-style:dashed}
.st-mine{border-color:var(--accent2)}
.st-item span{font-size:10px;color:var(--text2);max-width:54px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center;font-weight:500}

/* SEARCH */
.s-search{padding:10px 14px;flex-shrink:0}
.search-wrap{display:flex;align-items:center;background:var(--bg3);border-radius:var(--radius);padding:0 12px;gap:8px;border:1.5px solid transparent;transition:all 0.2s}
.search-wrap:focus-within{border-color:rgba(0,212,170,0.3)}
.search-wrap input{flex:1;background:none;border:none;color:var(--text);font-family:inherit;font-size:13px;padding:10px 0;outline:none}
.search-wrap input::placeholder{color:var(--text3)}

/* TABS */
.sidebar-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.stab{flex:1;padding:11px 6px;text-align:center;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer;border-bottom:2.5px solid transparent;transition:all 0.2s;position:relative}
.stab.active{color:var(--accent);border-bottom-color:var(--accent)}
.stab-badge{position:absolute;top:7px;right:calc(50% - 24px);background:var(--danger);color:#fff;font-size:9px;font-weight:700;border-radius:10px;padding:1px 5px;min-width:15px;text-align:center;display:none;animation:popIn 0.2s ease}
.stab-badge.show{display:block}
.tab-pane{display:none;flex:1;overflow-y:auto;flex-direction:column;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.tab-pane.active{display:flex}
.tab-pane::-webkit-scrollbar{width:3px}
.tab-pane::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* CHAT ITEMS */
.ci{display:flex;align-items:center;gap:12px;padding:12px 14px;cursor:pointer;border-bottom:1px solid rgba(30,41,59,0.5);transition:background 0.15s;position:relative;animation:slideIn 0.25s ease}
.ci:hover,.ci.active{background:var(--bg3)}
.ci-av{width:46px;height:46px;border-radius:50%;flex-shrink:0;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--accent);overflow:hidden}
.ci-av img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.ci-info{flex:1;min-width:0}
.ci-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ci-last{font-size:12px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.ci-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.ci-time{font-size:10px;color:var(--text3)}
.ci-badge{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;font-size:10px;font-weight:700;border-radius:10px;padding:2px 7px;min-width:18px;text-align:center;animation:popIn 0.2s ease}

/* REQUESTS */
.req-item{display:flex;align-items:center;gap:11px;padding:13px 14px;border-bottom:1px solid rgba(30,41,59,0.5);animation:slideIn 0.25s ease}
.req-info{flex:1;min-width:0}
.req-name{font-size:13px;font-weight:600}
.req-user{font-size:11px;color:var(--text2)}
.req-actions{display:flex;gap:7px;flex-shrink:0}
.req-btn{padding:6px 12px;border-radius:var(--radius-sm);border:none;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s}
.req-btn.accept{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000}
.req-btn.accept:active{transform:scale(0.95)}
.req-btn.decline{background:var(--bg3);color:var(--text2);border:1px solid var(--border)}

/* CHAT AREA */
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--bg);overflow:hidden;min-width:0}
.no-chat{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text2);gap:12px}
.no-chat .big{font-size:72px;opacity:0.12;animation:pulse 3s ease infinite}
.no-chat p{font-size:14px;color:var(--text3)}

/* CHAT HEADER */
.ch-header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;min-height:62px}
.ch-info{flex:1;min-width:0}
.ch-name{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ch-sub{font-size:11px;color:var(--text2)}
.back-btn{display:none;background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;padding:4px;flex-shrink:0;transition:color 0.2s}
.back-btn:hover{color:var(--accent)}

/* MESSAGES */
.msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:3px;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.msgs::-webkit-scrollbar{width:3px}
.msgs::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.mw{display:flex;flex-direction:column;max-width:75%;position:relative;animation:msgIn 0.2s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.mw.out{align-self:flex-end;align-items:flex-end}
.mw.in{align-self:flex-start;align-items:flex-start}
.mb{padding:9px 13px;border-radius:18px;font-size:14px;line-height:1.55;word-break:break-word;cursor:pointer;transition:opacity 0.15s}
.mb:active{opacity:0.8}
.mw.out .mb{background:rgba(0,212,170,0.12);border:1px solid rgba(0,212,170,0.2);border-bottom-right-radius:4px}
.mw.in .mb{background:var(--bg3);border:1px solid var(--border);border-bottom-left-radius:4px}
.mb.deleted{opacity:0.4;font-style:italic;color:var(--text2);background:transparent!important;border-style:dashed!important}
.mb.edited::after{content:' (edited)';font-size:10px;color:var(--text3);font-style:italic}
.m-time{font-size:10px;color:var(--text3);margin-top:3px;padding:0 4px}
.m-sender{font-size:11px;font-weight:700;margin-bottom:3px}
.m-img{max-width:220px;border-radius:12px;cursor:pointer;display:block}
.m-img:hover{opacity:0.92}
.m-audio audio{width:220px;border-radius:10px;outline:none}
.m-reactions{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.rpill{background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:3px 8px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:3px;transition:all 0.15s}
.rpill:hover{border-color:var(--accent);transform:scale(1.06)}
.rpill.mine{border-color:var(--accent);background:rgba(0,212,170,0.08)}
.rpill .rc{font-size:10px;color:var(--text2);font-weight:600}
.tag-highlight{color:var(--accent);font-weight:600}
.edit-timer{font-size:10px;color:var(--warn);margin-top:2px;padding:0 4px}

/* CTX MENU */
.msg-ctx-menu{display:none;position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:6px;z-index:300;min-width:165px;box-shadow:var(--shadow);animation:popIn 0.15s ease}
.msg-ctx-menu.show{display:block}
.ctx-item{display:flex;align-items:center;gap:9px;padding:9px 11px;border-radius:var(--radius-xs);cursor:pointer;font-size:13px;font-weight:500;transition:background 0.15s}
.ctx-item:hover{background:var(--bg3)}

/* EMOJI PICKER */
.emoji-picker{display:none;position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:10px;gap:4px;z-index:301;box-shadow:var(--shadow);flex-wrap:wrap;width:210px;animation:popIn 0.15s ease}
.emoji-picker.show{display:flex}
.emoji-picker button{background:none;border:none;font-size:22px;cursor:pointer;padding:4px;border-radius:8px;transition:all 0.15s}
.emoji-picker button:hover{background:var(--bg3);transform:scale(1.25)}

/* INPUT AREA */
.chat-input-area{padding:10px 12px;padding-bottom:calc(10px + var(--safe-bot));background:var(--bg2);border-top:1px solid var(--border);display:flex;align-items:flex-end;gap:8px;flex-shrink:0}
.iw{flex:1;background:var(--bg3);border-radius:var(--radius);padding:9px 12px;display:flex;align-items:flex-end;gap:8px;min-height:44px;border:1.5px solid transparent;transition:border-color 0.2s}
.iw:focus-within{border-color:rgba(0,212,170,0.25)}
.iw textarea{flex:1;background:none;border:none;color:var(--text);font-family:inherit;font-size:14px;resize:none;outline:none;max-height:120px;line-height:1.55;min-height:22px}
.iw textarea::placeholder{color:var(--text3)}
.iw-actions{display:flex;align-items:center;gap:6px;flex-shrink:0}
.send-btn{width:44px;height:44px;border-radius:50%;border:none;flex-shrink:0;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:all 0.2s;box-shadow:0 4px 14px rgba(0,212,170,0.3)}
.send-btn:hover{transform:scale(1.06)}
.send-btn:active{transform:scale(0.91)}
.vn-bar{display:none;align-items:center;gap:9px;flex:1;background:var(--bg3);border-radius:var(--radius);padding:9px 12px}
.vn-bar.show{display:flex}
.rec-dot{width:10px;height:10px;border-radius:50%;background:var(--danger);animation:pulse 1s infinite;flex-shrink:0}
.rec-time{font-size:14px;font-weight:600;flex:1}
.rec-cancel{background:none;border:none;color:var(--text2);cursor:pointer;font-size:20px}
.edit-bar{display:none;background:rgba(0,212,170,0.06);border-top:1px solid rgba(0,212,170,0.12);padding:8px 14px;font-size:12px;color:var(--accent);align-items:center;gap:9px;flex-shrink:0}
.edit-bar.show{display:flex}
.edit-bar span{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.edit-bar button{background:none;border:none;color:var(--text3);cursor:pointer;font-size:17px}
.tag-suggest{display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;z-index:100;max-height:170px;overflow-y:auto;box-shadow:var(--shadow)}
.tag-suggest.show{display:block}
.tag-opt{padding:9px 13px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:9px;transition:background 0.15s}
.tag-opt:hover{background:var(--bg3)}
.tag-opt img{width:30px;height:30px;border-radius:50%;object-fit:cover}
.tag-opt .tag-av{width:30px;height:30px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--accent);font-weight:700}
.gc-rules-banner{background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.12);border-radius:var(--radius-sm);padding:9px 13px;margin:8px 14px 0;font-size:12px;color:var(--text2);display:none;flex-shrink:0}
.gc-rules-banner.show{display:block}
.gc-rules-banner strong{color:var(--accent);display:block;margin-bottom:3px;font-size:11px;font-weight:700}

/* OVERLAY & MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.82);z-index:200;align-items:center;justify-content:center;padding:18px;backdrop-filter:blur(4px)}
.overlay.show{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:24px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto;animation:slideUp 0.35s cubic-bezier(0.34,1.2,0.64,1)}
.modal h3{font-size:17px;font-weight:700;margin-bottom:20px}
.mfooter{display:flex;gap:9px;margin-top:20px}
.mfooter .btn{flex:1}
.rules-list{list-style:none;display:flex;flex-direction:column;gap:7px}
.rule-item{display:flex;align-items:center;gap:9px;background:var(--bg3);padding:10px 12px;border-radius:var(--radius-sm);font-size:13px}
.rule-item button{background:none;border:none;color:var(--danger);cursor:pointer;margin-left:auto;font-size:16px;opacity:0.7}
.members-list{display:flex;flex-direction:column;gap:7px;max-height:240px;overflow-y:auto}
.member-item{display:flex;align-items:center;gap:10px;padding:9px;border-radius:var(--radius-sm);background:var(--bg3)}
.member-item .m-av{width:34px;height:34px;border-radius:50%;overflow:hidden;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--accent);font-weight:700;flex-shrink:0}
.member-item .m-av img{width:100%;height:100%;object-fit:cover}
.member-item span{flex:1;font-size:13px;min-width:0;overflow:hidden;text-overflow:ellipsis}
.member-item .badge{font-size:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;padding:2px 7px;border-radius:10px;font-weight:700;flex-shrink:0}

/* TOGGLE */
.perm-row{display:flex;align-items:center;gap:12px;padding:13px 0;border-bottom:1px solid var(--border)}
.perm-row:last-child{border-bottom:none}
.perm-info{flex:1}
.perm-label{font-size:13px;font-weight:600}
.perm-desc{font-size:11px;color:var(--text2);margin-top:2px}
.toggle-btn{width:46px;height:26px;border-radius:13px;background:var(--border);position:relative;cursor:pointer;transition:background 0.25s;flex-shrink:0;border:none;outline:none}
.toggle-btn.on{background:var(--accent)}
.toggle-btn::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:transform 0.25s;box-shadow:0 2px 5px rgba(0,0,0,0.3)}
.toggle-btn.on::after{transform:translateX(20px)}

/* PROFILE MENU */
.pmenu{display:none;position:fixed;top:calc(58px + var(--safe-top));right:14px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:7px;z-index:150;min-width:175px;box-shadow:var(--shadow);animation:popIn 0.2s ease}
.pmenu.show{display:block}
.pmi{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-xs);cursor:pointer;font-size:13px;font-weight:500;transition:background 0.15s}
.pmi:hover{background:var(--bg3)}

/* PROFILE INFO SECTION */
.profile-section{background:var(--bg3);border-radius:var(--radius-sm);padding:14px;margin-bottom:14px}
.profile-section label{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:0.7px;display:block;margin-bottom:4px}
.profile-section .val{font-size:14px;color:var(--text);font-weight:500}

/* TOAST */
.toast{position:fixed;bottom:calc(80px + var(--safe-bot));left:50%;transform:translateX(-50%) translateY(10px);background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 18px;font-size:13px;z-index:9998;opacity:0;transition:all 0.3s ease;pointer-events:none;max-width:88vw;text-align:center;cursor:pointer;font-weight:500}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* IMG VIEWER */
.img-viewer{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:500;align-items:center;justify-content:center}
.img-viewer.show{display:flex}
.img-viewer img{max-width:90%;max-height:90%;border-radius:var(--radius);object-fit:contain}
.img-viewer-close{position:absolute;top:20px;right:20px;background:var(--bg3);border:none;color:var(--text);font-size:22px;cursor:pointer;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center}

/* STATUS VIEWER - MODERN */
.sv{display:none;position:fixed;inset:0;background:#000;z-index:400;flex-direction:column;touch-action:pan-y}
.sv.show{display:flex}
.sv-header{padding:calc(14px + var(--safe-top)) 16px 14px;position:absolute;top:0;left:0;right:0;z-index:5;background:linear-gradient(to bottom,rgba(0,0,0,0.8) 0%,transparent 100%)}
.sv-bars{display:flex;gap:5px;margin-bottom:12px}
.sv-bar{height:3px;flex:1;background:rgba(255,255,255,0.25);border-radius:3px;overflow:hidden}
.sv-fill{height:100%;background:#fff;border-radius:3px;width:0;transition:none}
.sv-meta{display:flex;align-items:center;gap:10px;position:relative;z-index:10}
.sv-av{width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;background:var(--bg3);border:2px solid rgba(255,255,255,0.3)}
.sv-name{font-size:14px;font-weight:700;color:#fff;flex:1}
.sv-time{font-size:11px;color:rgba(255,255,255,0.6);flex-shrink:0}
.sv-close{background:rgba(0,0,0,0.4);border:none;color:#fff;font-size:22px;cursor:pointer;flex-shrink:0;padding:0;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:10;position:relative}
.sv-delete{background:rgba(239,68,68,0.25);border:1px solid rgba(239,68,68,0.5);color:#ef4444;font-size:12px;padding:5px 12px;border-radius:var(--radius-sm);cursor:pointer;font-family:inherit;font-weight:600;flex-shrink:0;z-index:10;position:relative}
.sv-media{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:1}
.sv-media img{width:100%;height:100%;object-fit:contain}
.sv-media video{width:100%;height:100%;object-fit:contain}
.sv-tap-left{position:absolute;left:0;top:0;bottom:0;width:35%;z-index:3;cursor:pointer}
.sv-tap-right{position:absolute;right:0;top:0;bottom:0;width:35%;z-index:3;cursor:pointer}
.sv-footer{position:absolute;bottom:0;left:0;right:0;padding:16px 16px calc(28px + var(--safe-bot));background:linear-gradient(to top,rgba(0,0,0,0.9) 0%,transparent 100%);display:flex;flex-direction:column;gap:8px;z-index:5}
.sv-viewers-wrap{display:flex;align-items:center;gap:8px}
.sv-eye-icon{width:32px;height:32px;background:rgba(255,255,255,0.12);backdrop-filter:blur(6px);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;border:1px solid rgba(255,255,255,0.15);flex-shrink:0}
.sv-viewers-info{}
.sv-viewers-count{font-size:14px;font-weight:700;color:#fff;line-height:1.2}
.sv-viewers-names{font-size:11px;color:rgba(255,255,255,0.6);margin-top:1px}
.sv-caption{font-size:14px;color:#fff;font-weight:500;line-height:1.5}

/* MISC */
.empty-list{text-align:center;padding:40px 20px;color:var(--text2);font-size:13px;line-height:1.6}
.empty-list .ei{font-size:38px;margin-bottom:8px}
.user-search-result{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg3);border-radius:var(--radius-sm);margin-top:10px}
.usr-av{width:42px;height:42px;border-radius:50%;flex-shrink:0;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--accent);font-weight:700;overflow:hidden}
.usr-av img{width:100%;height:100%;object-fit:cover}
.info-row{display:flex;gap:8px;margin-bottom:10px}
.info-chip{background:var(--bg3);border-radius:var(--radius-xs);padding:8px 12px;flex:1;min-width:0}
.info-chip .ic-label{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px}
.info-chip .ic-val{font-size:13px;color:var(--text);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

@media(max-width:680px){
  .sidebar{position:fixed;inset:0;width:100%;z-index:10}
  .sidebar.hidden{transform:translateX(-100%)}
  .back-btn{display:block}
}
</style>
</head>
<body>

<div id="splash">
  <img src="https://image2url.com/r2/default/images/1772295169769-b92423f9-499f-4178-942f-409c094d9380.jpg" onerror="this.style.display='none'" alt=""/>
  <h1>2k26_DSA</h1>
  <p>Connect. Chat. Vibe.</p>
  <div class="splash-bar"><div class="splash-fill"></div></div>
  <div class="splash-credit">‚ú¶ Created by DEVGODSWILL ‚ú¶</div>
</div>

<div id="auth">
  <div class="auth-card">
    <div class="auth-logo">
      <img src="https://image2url.com/r2/default/images/1772295169769-b92423f9-499f-4178-942f-409c094d9380.jpg" onerror="this.style.display='none'" alt=""/>
      <h2>2k26_DSA</h2>
      <p>Connect. Chat. Vibe.</p>
    </div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')">Login</div>
      <div class="auth-tab" onclick="switchTab('signup')">Sign Up</div>
    </div>
    <div id="login-form">
      <div class="fg"><label>Email</label><input type="email" id="login-email" placeholder="you@email.com" autocomplete="email"/></div>
      <div class="fg"><label>Password</label>
        <div class="pw-wrap">
          <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
          <button class="eye-btn" type="button" onclick="toggleEye('login-pass',this)">üëÅ</button>
        </div>
      </div>
      <p class="err" id="login-err"></p>
      <button class="btn" id="login-btn" onclick="doLogin()">Login</button>
    </div>
    <div id="signup-form" style="display:none">
      <div class="pfp-row">
        <div class="pfp-circle" id="pfp-preview" onclick="document.getElementById('pfp-file').click()">üë§</div>
        <div>
          <label class="pfp-label" for="pfp-file">Choose Profile Pic</label>
          <p class="pfp-hint">Optional</p>
        </div>
        <input type="file" id="pfp-file" accept="image/*" style="display:none" onchange="previewPfp(this)"/>
      </div>
      <div class="fg">
        <label>Username</label>
        <input type="text" id="su-username" placeholder="e.g. godswill_dsa" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9_]/g,'')"/>
        <p class="hint">Lowercase, numbers and _ only</p>
      </div>
      <div class="fg"><label>Display Name</label><input type="text" id="su-name" placeholder="Your name"/></div>
      <div class="fg"><label>Email</label><input type="email" id="su-email" placeholder="you@email.com"/></div>
      <div class="fg"><label>Password</label>
        <div class="pw-wrap">
          <input type="password" id="su-pass" placeholder="Min 6 characters"/>
          <button class="eye-btn" type="button" onclick="toggleEye('su-pass',this)">üëÅ</button>
        </div>
      </div>
      <p class="err" id="su-err"></p>
      <button class="btn" id="su-btn" onclick="doSignup()">Create Account</button>
    </div>
  </div>
</div>

<div id="main">
  <div class="app-wrap">
    <div class="sidebar" id="sidebar">
      <div class="s-header">
        <h2>2k26_DSA</h2>
        <div class="hdr-actions">
          <button class="ibtn" onclick="openGcModal()" title="New Group">üë•</button>
          <button class="ibtn" onclick="openStatusModal()" title="Post Status">üì∏</button>
          <button class="ibtn" onclick="openFindUser()" title="Find User">üîç</button>
          <button class="ibtn" onclick="toggleProfileMenu()" id="profile-btn">
            <img id="header-pfp" style="width:28px;height:28px;border-radius:50%;object-fit:cover;display:none"/>
            <span id="header-pfp-ph">üë§</span>
          </button>
        </div>
      </div>
      <div class="status-row" id="status-row">
        <div class="st-item" onclick="openStatusModal()">
          <div class="st-ring add-btn">Ôºã</div>
          <span>My Status</span>
        </div>
      </div>
      <div class="s-search">
        <div class="search-wrap">
          <span style="color:var(--text3);font-size:14px">üîç</span>
          <input type="text" placeholder="Search chats..." oninput="filterChats(this.value)"/>
        </div>
      </div>
      <div class="sidebar-tabs">
        <div class="stab active" onclick="switchSideTab('chats',this)">Chats</div>
        <div class="stab" onclick="switchSideTab('groups',this)">Groups</div>
        <div class="stab" onclick="switchSideTab('requests',this)">Requests<span class="stab-badge" id="req-badge"></span></div>
      </div>
      <div class="tab-pane active" id="pane-chats"></div>
      <div class="tab-pane" id="pane-groups"></div>
      <div class="tab-pane" id="pane-requests"></div>
    </div>

    <div class="chat-area">
      <div class="no-chat" id="no-chat" style="display:flex">
        <div class="big">üí¨</div>
        <p>Select a chat to start messaging</p>
      </div>
      <div id="active-chat" style="display:none;flex-direction:column;height:100%;overflow:hidden">
        <div class="ch-header">
          <button class="back-btn" onclick="closeChat()">‚Äπ</button>
          <div id="ch-avatar" class="ci-av" style="width:42px;height:42px;font-size:16px;flex-shrink:0"></div>
          <div class="ch-info">
            <div class="ch-name" id="ch-name"></div>
            <div class="ch-sub" id="ch-sub"></div>
          </div>
          <button class="ibtn" onclick="openChatInfo()">‚ÑπÔ∏è</button>
        </div>
        <div class="gc-rules-banner" id="gc-rules-banner"><strong>üìã Group Rules</strong><div id="gc-rules-text"></div></div>
        <div class="msgs" id="msgs"></div>
        <div class="edit-bar" id="edit-bar">
          <span>‚úèÔ∏è Editing: <span id="edit-preview"></span></span>
          <button onclick="cancelEdit()">‚úï</button>
        </div>
        <div style="position:relative">
          <div class="tag-suggest" id="tag-suggest"></div>
        </div>
        <div class="chat-input-area">
          <div class="iw" id="normal-iw">
            <textarea id="msg-txt" placeholder="Type a message..." rows="1" oninput="handleInput(this)" onkeydown="handleEnter(event)"></textarea>
            <div class="iw-actions">
              <label style="cursor:pointer;font-size:17px;color:var(--text2)">
                üñºÔ∏è<input type="file" accept="image/*,video/*" style="display:none" onchange="sendMedia(this)"/>
              </label>
            </div>
          </div>
          <div class="vn-bar" id="vn-bar">
            <div class="rec-dot"></div>
            <span class="rec-time" id="rec-time">0:00</span>
            <button class="rec-cancel" onclick="cancelVN()">‚úï</button>
            <button class="ibtn" onclick="stopAndSendVN()" style="background:var(--accent);color:#000">‚úì</button>
          </div>
          <button class="ibtn" id="vn-btn" onclick="toggleVN()" style="width:44px;height:44px;font-size:18px">üé§</button>
          <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="pmenu" id="pmenu">
  <div class="pmi" onclick="openProfileEdit()">‚úèÔ∏è My Profile</div>
  <div class="pmi" onclick="openFindUser()">üîç Find User</div>
  <div class="pmi" onclick="doLogout()" style="color:var(--danger)">üö™ Logout</div>
</div>

<div class="msg-ctx-menu" id="msg-ctx-menu">
  <div class="ctx-item" onclick="showEmojiFromCtx()">üòä React</div>
  <div class="ctx-item" id="ctx-edit" onclick="startEdit()">‚úèÔ∏è Edit</div>
  <div class="ctx-item" id="ctx-delete" onclick="deleteMsg()" style="color:var(--danger)">üóëÔ∏è Delete</div>
  <div class="ctx-item" id="ctx-admin-delete" onclick="adminDeleteMsg()" style="color:var(--danger);display:none">üóëÔ∏è Admin Delete</div>
</div>
<div class="emoji-picker" id="global-ep"></div>

<!-- GROUP CREATE -->
<div class="overlay" id="gc-overlay">
  <div class="modal">
    <h3>üë• Create Group</h3>
    <div class="fg"><label>Group Name</label><input type="text" id="gc-name" placeholder="e.g. Squad 2k26"/></div>
    <div class="fg"><label>Description</label><input type="text" id="gc-desc" placeholder="What's this group about?"/></div>
    <div class="fg">
      <label>Group Icon</label>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="pfp-circle" id="gc-icon-preview" onclick="document.getElementById('gc-icon-file').click()">üë•</div>
        <input type="file" id="gc-icon-file" accept="image/*" style="display:none" onchange="previewGcIcon(this)"/>
        <label class="pfp-label" for="gc-icon-file">Upload Icon</label>
      </div>
    </div>
    <div class="fg">
      <label>Add Members</label>
      <div style="display:flex;gap:7px">
        <input type="text" id="gc-member-input" placeholder="@username" style="flex:1;padding:9px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:13px;outline:none" oninput="this.value=this.value.replace(/[^a-z0-9_@]/g,'').toLowerCase()"/>
        <button class="ibtn" onclick="addGcMember()" style="width:auto;padding:0 12px;border-radius:var(--radius-sm)">Add</button>
      </div>
      <div id="gc-members-list" style="margin-top:8px;display:flex;flex-direction:column;gap:5px"></div>
    </div>
    <div class="fg">
      <label>Group Rules</label>
      <div style="display:flex;gap:7px">
        <input type="text" id="gc-rule-input" placeholder="e.g. No spam" style="flex:1;padding:9px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:13px;outline:none"/>
        <button class="ibtn" onclick="addRuleInput()" style="width:auto;padding:0 12px;border-radius:var(--radius-sm)">+</button>
      </div>
      <ul class="rules-list" id="rules-preview" style="margin-top:8px"></ul>
    </div>
    <p class="err" id="gc-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('gc-overlay')">Cancel</button>
      <button class="btn" onclick="createGroup()">Create</button>
    </div>
  </div>
</div>

<!-- FIND USER -->
<div class="overlay" id="find-overlay">
  <div class="modal">
    <h3>üîç Find User</h3>
    <div class="fg">
      <label>Search by Username</label>
      <div style="display:flex;gap:7px">
        <input type="text" id="find-input" placeholder="@username" style="flex:1;padding:9px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:13px;outline:none" oninput="this.value=this.value.replace(/[^a-z0-9_@]/g,'').toLowerCase()"/>
        <button class="ibtn" onclick="findUser()" style="width:auto;padding:0 12px;border-radius:var(--radius-sm)">Search</button>
      </div>
    </div>
    <div id="find-result"></div>
    <p class="err" id="find-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('find-overlay')">Close</button>
    </div>
  </div>
</div>

<!-- STATUS POST -->
<div class="overlay" id="status-overlay">
  <div class="modal">
    <h3>üì∏ Post Status</h3>
    <div class="fg">
      <label>Photo or Video</label>
      <label style="display:flex;align-items:center;gap:10px;background:var(--bg3);padding:14px;border-radius:var(--radius-sm);cursor:pointer;border:1.5px dashed var(--border);transition:border-color 0.2s">
        <span style="font-size:22px">üìé</span><span style="font-size:13px;color:var(--text2)">Tap to choose media</span>
        <input type="file" id="status-file" accept="image/*,video/*" style="display:none" onchange="previewStatus(this)"/>
      </label>
      <div id="status-preview" style="margin-top:10px"></div>
    </div>
    <div class="fg"><label>Caption (optional)</label><input type="text" id="status-caption" placeholder="What's on your mind?"/></div>
    <p class="err" id="status-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('status-overlay')">Cancel</button>
      <button class="btn" id="status-post-btn" onclick="postStatus()">Post</button>
    </div>
  </div>
</div>

<!-- CHAT INFO -->
<div class="overlay" id="chatinfo-overlay">
  <div class="modal">
    <h3 id="chatinfo-title">Info</h3>
    <div id="chatinfo-content"></div>
    <div class="mfooter" id="chatinfo-footer">
      <button class="btn btn-ghost" onclick="closeModal('chatinfo-overlay')">Close</button>
    </div>
  </div>
</div>

<!-- PROFILE EDIT -->
<div class="overlay" id="profile-overlay">
  <div class="modal">
    <h3>üë§ My Profile</h3>
    <div id="profile-view-section"></div>
    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0"/>
    <p style="font-size:12px;color:var(--text2);margin-bottom:14px;font-weight:600">‚úèÔ∏è EDIT PROFILE</p>
    <div class="pfp-row">
      <div class="pfp-circle" id="edit-pfp-preview" onclick="document.getElementById('edit-pfp-file').click()">üë§</div>
      <div>
        <label class="pfp-label" for="edit-pfp-file">Change Photo</label>
        <p class="pfp-hint">Tap to upload</p>
      </div>
      <input type="file" id="edit-pfp-file" accept="image/*" style="display:none" onchange="previewEditPfp(this)"/>
    </div>
    <div class="fg"><label>Display Name</label><input type="text" id="edit-name"/></div>
    <div class="fg"><label>Status Text</label><input type="text" id="edit-status-text" placeholder="Hey there!"/></div>
    <p class="err" id="edit-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('profile-overlay')">Cancel</button>
      <button class="btn" onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>

<!-- STATUS VIEWER -->
<div class="sv" id="sv">
  <div class="sv-header">
    <div class="sv-bars" id="sv-bars"></div>
    <div class="sv-meta">
      <img class="sv-av" id="sv-av" src="" onerror="this.style.display='none'"/>
      <span class="sv-name" id="sv-name"></span>
      <span class="sv-time" id="sv-time"></span>
      <button class="sv-delete" id="sv-delete-btn" onclick="deleteStatus()" style="display:none">Delete</button>
      <button class="sv-close" onclick="closeSV()">‚úï</button>
    </div>
  </div>
  <div class="sv-media" id="sv-media"></div>
  <!-- TAP ZONES -->
  <div class="sv-tap-left" onclick="svTapLeft()"></div>
  <div class="sv-tap-right" onclick="svTapRight()"></div>
  <div class="sv-footer">
    <div class="sv-viewers-wrap" id="sv-viewers-wrap" style="display:none">
      <div class="sv-eye-icon">üëÅ</div>
      <div class="sv-viewers-info">
        <div class="sv-viewers-count" id="sv-viewers"></div>
        <div class="sv-viewers-names" id="sv-viewer-names"></div>
      </div>
    </div>
    <div class="sv-caption" id="sv-caption"></div>
  </div>
</div>

<div class="img-viewer" id="img-viewer">
  <button class="img-viewer-close" onclick="closeImgViewer()">‚úï</button>
  <img id="viewer-img" src="" alt=""/>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged, updateProfile, deleteUser
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc,
  onSnapshot, query, where, orderBy, updateDoc, deleteDoc,
  arrayUnion, arrayRemove, serverTimestamp, Timestamp, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const FB={
  apiKey:"AIzaSyBzUELxbbaL6Wb_M1uNhjwlZHVTorN9XJs",
  authDomain:"my-whatsapp-2c1af.firebaseapp.com",
  projectId:"my-whatsapp-2c1af",
  storageBucket:"my-whatsapp-2c1af.firebasestorage.app",
  messagingSenderId:"1089455460888",
  appId:"1:1089455460888:web:15bd0820546c813febe96d"
};
const CLOUD_NAME="dzxckgbzp",CLOUD_PRESET="Odegaard";
const app=initializeApp(FB);
const auth=getAuth(app);
const db=getFirestore(app);

let CU=null,CUD=null;
let activeChatId=null,activeChatType=null,activeChatData=null;
let msgsUnsub=null,chatsUnsub=null,reqUnsub=null;
let mediaRecorder=null,recChunks=[],recTimer=null,recSeconds=0;
let pendingPfpFile=null,pendingGcIconFile=null,pendingEditPfpFile=null,pendingStatusFile=null;
let gcMembersToAdd=[],gcRulesArr=[];
let ctxMsgId=null,ctxMsgData=null,editingMsgId=null;
let editTimers={};
let svStatuses=[],svIdx=0,svProg=null;
let gcMembers=[];
const EMOJIS=['‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üëç','üî•','üéâ','üòç','üíØ','üôè'];

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg,dur=2800,cb){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');t.onclick=cb||null;
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),dur);
}
function showErr(id,msg){const e=document.getElementById(id);if(e){e.textContent=msg;e.style.display='block';}}
function hideErr(id){const e=document.getElementById(id);if(e)e.style.display='none';}

function fmtTime(ts,clientTs){
  let d;
  if(!ts){if(clientTs){d=new Date(clientTs);}else return'just now';}
  else{try{d=ts.toDate?ts.toDate():new Date(ts);}catch(e){d=clientTs?new Date(clientTs):null;}}
  if(!d||isNaN(d.getTime())){return clientTs?new Date(clientTs).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'just now';}
  const now=new Date(),diff=now-d;
  if(diff<60000)return'just now';
  if(diff<3600000)return Math.floor(diff/60000)+'m ago';
  if(d.toDateString()===now.toDateString())return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  return d.toLocaleDateString([],{day:'2-digit',month:'short'});
}
function chatId(a,b){return[a,b].sort().join('_');}
function secsLeft(ts){
  if(!ts)return 0;
  try{const d=ts.toDate?ts.toDate():new Date(ts);return Math.max(0,120-Math.floor((Date.now()-d.getTime())/1000));}
  catch(e){return 0;}
}
async function uploadCloud(file,folder='2k26dsa'){
  const fd=new FormData();
  fd.append('file',file);fd.append('upload_preset',CLOUD_PRESET);fd.append('folder',folder);
  const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,{method:'POST',body:fd});
  if(!res.ok)throw new Error('Upload failed');
  const d=await res.json();
  if(d.error)throw new Error(d.error.message);
  if(!d.secure_url)throw new Error('No URL returned');
  return d.secure_url;
}

// ‚îÄ‚îÄ EYE TOGGLE ‚îÄ‚îÄ
window.toggleEye=function(inputId,btn){
  const inp=document.getElementById(inputId);
  if(!inp)return;
  if(inp.type==='password'){inp.type='text';btn.textContent='üôà';}
  else{inp.type='password';btn.textContent='üëÅ';}
};

// ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ
setTimeout(()=>{
  document.getElementById('splash').classList.add('hide');
  setTimeout(()=>{document.getElementById('splash').style.display='none';checkAuth();},700);
},3200);

function checkAuth(){
  onAuthStateChanged(auth,async u=>{
    if(u){
      CU=u;
      try{await loadCUD(u.uid);}catch(e){
        CUD={name:CU.displayName||'User',pfp:'',username:'',statusText:'',email:CU.email||''};
        updateHeaderPfp();
      }
      showMain();
    }else{showAuth();}
  },()=>showAuth());
}
async function loadCUD(uid){
  const s=await getDoc(doc(db,'users',uid));
  CUD=s.exists()?{...s.data(),email:CU.email||s.data().email||''}:{name:CU.displayName||'User',pfp:'',username:'',statusText:'',email:CU.email||''};
  updateHeaderPfp();
}
function updateHeaderPfp(){
  const img=document.getElementById('header-pfp'),ph=document.getElementById('header-pfp-ph');
  if(CUD?.pfp){img.src=CUD.pfp;img.style.display='block';ph.style.display='none';}
  else{img.style.display='none';ph.style.display='block';}
}
function showAuth(){document.getElementById('auth').classList.add('show');}
function hideAuth(){document.getElementById('auth').classList.remove('show');}
function showMain(){
  hideAuth();
  document.getElementById('main').classList.add('show');
  loadChats();loadStatuses();listenRequests();listenNotifications();
}

window.switchTab=function(t){
  document.getElementById('login-form').style.display=t==='login'?'block':'none';
  document.getElementById('signup-form').style.display=t==='signup'?'block':'none';
  document.querySelectorAll('.auth-tab').forEach((el,i)=>el.classList.toggle('active',(t==='login'&&i===0)||(t==='signup'&&i===1)));
};
window.previewPfp=function(i){pendingPfpFile=i.files[0];if(pendingPfpFile)document.getElementById('pfp-preview').innerHTML=`<img src="${URL.createObjectURL(pendingPfpFile)}"/>`;};
window.previewGcIcon=function(i){pendingGcIconFile=i.files[0];if(pendingGcIconFile)document.getElementById('gc-icon-preview').innerHTML=`<img src="${URL.createObjectURL(pendingGcIconFile)}"/>`;};
window.previewEditPfp=function(i){pendingEditPfpFile=i.files[0];if(pendingEditPfpFile)document.getElementById('edit-pfp-preview').innerHTML=`<img src="${URL.createObjectURL(pendingEditPfpFile)}"/>`;};
window.previewStatus=function(i){
  pendingStatusFile=i.files[0];
  if(!pendingStatusFile)return;
  const url=URL.createObjectURL(pendingStatusFile);
  document.getElementById('status-preview').innerHTML=pendingStatusFile.type.startsWith('video')
    ?`<video src="${url}" style="max-width:100%;border-radius:10px;max-height:160px" controls playsinline></video>`
    :`<img src="${url}" style="max-width:100%;border-radius:10px;max-height:160px"/>`;
};

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
window.doLogin=async function(){
  const email=document.getElementById('login-email').value.trim();
  const pass=document.getElementById('login-pass').value;
  hideErr('login-err');
  if(!email||!pass){showErr('login-err','Fill all fields.');return;}
  const btn=document.getElementById('login-btn');
  btn.disabled=true;btn.textContent='Logging in...';
  try{
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){
    const m={'auth/user-not-found':'No account with this email.','auth/wrong-password':'Wrong password.','auth/invalid-credential':'Wrong email or password.','auth/network-request-failed':'No internet.','auth/invalid-email':'Invalid email.','auth/too-many-requests':'Too many attempts. Try later.'};
    showErr('login-err',m[e.code]||e.message);
  }finally{btn.disabled=false;btn.textContent='Login';}
};

// ‚îÄ‚îÄ SIGNUP ‚îÄ‚îÄ
window.doSignup=async function(){
  const username=document.getElementById('su-username').value.trim();
  const name=document.getElementById('su-name').value.trim();
  const email=document.getElementById('su-email').value.trim();
  const pass=document.getElementById('su-pass').value;
  hideErr('su-err');
  if(!username||username.length<3){showErr('su-err','Username must be 3+ characters.');return;}
  if(!name||!email||!pass){showErr('su-err','Fill all fields.');return;}
  if(pass.length<6){showErr('su-err','Password min 6 characters.');return;}
  const btn=document.getElementById('su-btn');
  btn.disabled=true;btn.textContent='Checking username...';
  let cred=null;
  try{
    const usnap=await getDocs(query(collection(db,'users'),where('username','==',username)));
    if(!usnap.empty){showErr('su-err','Username taken. Try another.');btn.disabled=false;btn.textContent='Create Account';return;}
    btn.textContent='Creating account...';
    cred=await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    let pfpUrl='';
    if(pendingPfpFile){
      btn.textContent='Uploading photo...';
      try{pfpUrl=await uploadCloud(pendingPfpFile,'pfps');await updateProfile(cred.user,{photoURL:pfpUrl});}catch(ue){}
    }
    btn.textContent='Saving profile...';
    await setDoc(doc(db,'users',cred.user.uid),{uid:cred.user.uid,name,email:email.toLowerCase(),username,pfp:pfpUrl,statusText:'Hey there! I am on 2k26_DSA',createdAt:serverTimestamp(),friends:[]});
    toast('Welcome to 2k26_DSA! üéâ');
  }catch(e){
    if(cred?.user){try{await deleteUser(cred.user);}catch(de){}}
    const m={'auth/email-already-in-use':'Email already registered.','auth/weak-password':'Password too weak.','auth/invalid-email':'Invalid email.','auth/network-request-failed':'No internet.'};
    showErr('su-err',m[e.code]||e.message);
    btn.disabled=false;btn.textContent='Create Account';
  }
};

window.doLogout=async function(){
  if(chatsUnsub)chatsUnsub();if(reqUnsub)reqUnsub();if(msgsUnsub)msgsUnsub();
  try{await signOut(auth);}catch(e){}
  CU=null;CUD=null;activeChatId=null;
  document.getElementById('main').classList.remove('show');
  document.getElementById('pmenu').classList.remove('show');
  showAuth();
};

window.toggleProfileMenu=function(){document.getElementById('pmenu').classList.toggle('show');};
document.addEventListener('click',e=>{
  if(!e.target.closest('#pmenu')&&!e.target.closest('#profile-btn'))document.getElementById('pmenu').classList.remove('show');
  if(!e.target.closest('#msg-ctx-menu')&&!e.target.closest('.mb'))hideCtxMenu();
  if(!e.target.closest('#global-ep')&&!e.target.closest('.mb'))document.getElementById('global-ep').classList.remove('show');
});

// ‚îÄ‚îÄ PROFILE (show all info + edit) ‚îÄ‚îÄ
window.openProfileEdit=function(){
  document.getElementById('pmenu').classList.remove('show');
  // Show current info
  const sec=document.getElementById('profile-view-section');
  sec.innerHTML=`
    <div style="text-align:center;margin-bottom:18px">
      ${CUD?.pfp?`<img src="${CUD.pfp}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2.5px solid var(--accent);box-shadow:0 0 20px rgba(0,212,170,0.2)"/>`
      :`<div style="width:80px;height:80px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto">${(CUD?.name||'U')[0]}</div>`}
    </div>
    <div class="info-row">
      <div class="info-chip"><div class="ic-label">Display Name</div><div class="ic-val">${esc(CUD?.name||'')}</div></div>
      <div class="info-chip"><div class="ic-label">Username</div><div class="ic-val">@${esc(CUD?.username||'')}</div></div>
    </div>
    <div class="info-row">
      <div class="info-chip"><div class="ic-label">Email</div><div class="ic-val">${esc(CUD?.email||CU?.email||'')}</div></div>
    </div>
    <div class="info-row">
      <div class="info-chip"><div class="ic-label">Status Text</div><div class="ic-val">${esc(CUD?.statusText||'')}</div></div>
    </div>
    <div class="info-row">
      <div class="info-chip"><div class="ic-label">Friends</div><div class="ic-val">${(CUD?.friends||[]).length} friends</div></div>
      <div class="info-chip"><div class="ic-label">Member Since</div><div class="ic-val">${CUD?.createdAt?fmtTime(CUD.createdAt):'‚Äî'}</div></div>
    </div>`;
  if(CUD?.pfp)document.getElementById('edit-pfp-preview').innerHTML=`<img src="${CUD.pfp}"/>`;
  document.getElementById('edit-name').value=CUD?.name||'';
  document.getElementById('edit-status-text').value=CUD?.statusText||'';
  document.getElementById('profile-overlay').classList.add('show');
};
window.saveProfile=async function(){
  hideErr('edit-err');
  const name=document.getElementById('edit-name').value.trim();
  const statusText=document.getElementById('edit-status-text').value.trim();
  if(!name){showErr('edit-err','Name cannot be empty.');return;}
  const btn=document.querySelector('#profile-overlay .btn:not(.btn-ghost)');
  btn.disabled=true;btn.textContent='Saving...';
  try{
    let pfp=CUD?.pfp||'';
    if(pendingEditPfpFile){pfp=await uploadCloud(pendingEditPfpFile,'pfps');pendingEditPfpFile=null;}
    await updateProfile(CU,{displayName:name,photoURL:pfp||null});
    await setDoc(doc(db,'users',CU.uid),{name,statusText,pfp},{merge:true});
    CUD={...CUD,name,statusText,pfp};updateHeaderPfp();
    closeModal('profile-overlay');toast('Profile updated ‚úÖ');
  }catch(e){showErr('edit-err',e.message);}
  finally{btn.disabled=false;btn.textContent='Save';}
};

// ‚îÄ‚îÄ FIND USER ‚îÄ‚îÄ
window.openFindUser=function(){
  document.getElementById('pmenu').classList.remove('show');
  document.getElementById('find-input').value='';
  document.getElementById('find-result').innerHTML='';
  hideErr('find-err');
  document.getElementById('find-overlay').classList.add('show');
};
window.findUser=async function(){
  const uname=document.getElementById('find-input').value.trim().replace('@','');
  hideErr('find-err');
  if(!uname){showErr('find-err','Enter a username.');return;}
  if(uname===CUD?.username){showErr('find-err',"That's you!");return;}
  document.getElementById('find-result').innerHTML='<p style="color:var(--text2);font-size:13px;margin-top:8px">Searching...</p>';
  try{
    const snap=await getDocs(query(collection(db,'users'),where('username','==',uname)));
    if(snap.empty){document.getElementById('find-result').innerHTML='<p style="color:var(--text2);font-size:13px;margin-top:8px">No user found.</p>';return;}
    const u=snap.docs[0].data();
    const isFriend=(CUD?.friends||[]).includes(u.uid);
    let alreadySent=false;
    try{const reqSnap=await getDoc(doc(db,'requests',CU.uid+'_'+u.uid));alreadySent=reqSnap.exists()&&reqSnap.data().status==='pending';}catch(re){}
    document.getElementById('find-result').innerHTML=`
      <div class="user-search-result">
        <div class="usr-av">${u.pfp?`<img src="${u.pfp}"/>`:(u.name||'?')[0].toUpperCase()}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:600">${esc(u.name)}</div>
          <div style="font-size:11px;color:var(--text2)">@${esc(u.username)}</div>
        </div>
        ${isFriend
          ?`<button class="req-btn accept" onclick="openDMWithUid('${u.uid}','${esc(u.name)}','${u.pfp||''}','${esc(u.username)}')">üí¨ Chat</button>`
          :alreadySent
            ?`<button class="req-btn decline" disabled>‚úì Sent</button>`
            :`<button class="req-btn accept" onclick="sendFriendReq('${u.uid}','${esc(u.name)}','${u.pfp||''}','${esc(u.username)}')">‚ûï Add</button>`
        }
      </div>`;
  }catch(e){showErr('find-err',e.message);}
};
window.sendFriendReq=async function(toUid,toName,toPfp,toUsername){
  try{
    await setDoc(doc(db,'requests',CU.uid+'_'+toUid),{from:CU.uid,fromName:CUD?.name||CU.displayName,fromPfp:CUD?.pfp||'',fromUsername:CUD?.username||'',to:toUid,toName,toPfp,toUsername,status:'pending',createdAt:serverTimestamp()});
    toast('Friend request sent to @'+toUsername+' ‚úÖ');window.findUser();
  }catch(e){toast('‚ùå '+e.message);}
};
window.openDMWithUid=async function(uid,name,pfp,username){
  const cid=chatId(CU.uid,uid);
  await setDoc(doc(db,'chats',cid),{type:'private',members:[CU.uid,uid],memberData:{[CU.uid]:{name:CUD?.name||CU.displayName,pfp:CUD?.pfp||'',username:CUD?.username||''},[uid]:{name,pfp,username}},lastMsg:'',lastTime:serverTimestamp(),unread:{}},{merge:true});
  closeModal('find-overlay');openChat(cid,'private');
};

// ‚îÄ‚îÄ REQUESTS ‚îÄ‚îÄ
function listenRequests(){
  if(reqUnsub)reqUnsub();
  const q=query(collection(db,'requests'),where('to','==',CU.uid),where('status','==','pending'));
  reqUnsub=onSnapshot(q,snap=>{
    const reqs=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderRequests(reqs);
    const badge=document.getElementById('req-badge');
    if(reqs.length){badge.textContent=reqs.length;badge.classList.add('show');}
    else badge.classList.remove('show');
  });
}
function renderRequests(reqs){
  const pane=document.getElementById('pane-requests');
  if(!reqs.length){pane.innerHTML='<div class="empty-list"><div class="ei">üëã</div>No pending requests</div>';return;}
  pane.innerHTML=reqs.map(r=>`
    <div class="req-item">
      <div class="ci-av" style="width:42px;height:42px;flex-shrink:0">${r.fromPfp?`<img src="${r.fromPfp}"/>`:(r.fromName||'?')[0].toUpperCase()}</div>
      <div class="req-info"><div class="req-name">${esc(r.fromName)}</div><div class="req-user">@${esc(r.fromUsername)}</div></div>
      <div class="req-actions">
        <button class="req-btn accept" onclick="acceptReq('${r.id}','${r.from}','${esc(r.fromName)}','${r.fromPfp||''}','${esc(r.fromUsername)}')">‚úì Accept</button>
        <button class="req-btn decline" onclick="declineReq('${r.id}')">‚úï</button>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ ACCEPT REQUEST (fixed to properly update friends and open chat) ‚îÄ‚îÄ
window.acceptReq=async function(reqId,fromUid,fromName,fromPfp,fromUsername){
  try{
    await updateDoc(doc(db,'requests',reqId),{status:'accepted'});
    await updateDoc(doc(db,'users',CU.uid),{friends:arrayUnion(fromUid)});
    await updateDoc(doc(db,'users',fromUid),{friends:arrayUnion(CU.uid)});
    // Update local CUD
    CUD={...CUD,friends:[...(CUD?.friends||[]),fromUid]};
    const cid=chatId(CU.uid,fromUid);
    await setDoc(doc(db,'chats',cid),{
      type:'private',members:[CU.uid,fromUid],
      memberData:{
        [CU.uid]:{name:CUD?.name||CU.displayName,pfp:CUD?.pfp||'',username:CUD?.username||''},
        [fromUid]:{name:fromName,pfp:fromPfp,username:fromUsername}
      },
      lastMsg:'',lastTime:serverTimestamp(),unread:{}
    },{merge:true});
    toast('You and @'+fromUsername+' are now friends! üéâ');
  }catch(e){toast('‚ùå '+e.message);}
};
window.declineReq=async function(reqId){
  try{await updateDoc(doc(db,'requests',reqId),{status:'declined'});toast('Request declined');}
  catch(e){toast('‚ùå '+e.message);}
};

// ‚îÄ‚îÄ CHATS ‚îÄ‚îÄ
function loadChats(){
  if(chatsUnsub)chatsUnsub();
  const q=query(collection(db,'chats'),where('members','array-contains',CU.uid));
  chatsUnsub=onSnapshot(q,snap=>{
    const all=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderChatPane('pane-chats',all.filter(i=>i.type==='private'));
    renderChatPane('pane-groups',all.filter(i=>i.type==='group'));
  });
}
function renderChatPane(paneId,items){
  const pane=document.getElementById(paneId);
  const isGroup=paneId==='pane-groups';
  if(!items.length){pane.innerHTML=`<div class="empty-list"><div class="ei">${isGroup?'üë•':'üí¨'}</div>${isGroup?'No groups yet':'No chats yet. Add a friend!'}</div>`;return;}
  items.sort((a,b)=>(b.lastTime?.seconds||0)-(a.lastTime?.seconds||0));
  pane.innerHTML=items.map(item=>{
    let name='',pfp='',last=item.lastMsg||'';
    if(item.type==='group'){name=item.name||'Group';pfp=item.icon||'';}
    else{const other=item.members?.find(m=>m!==CU.uid);const od=item.memberData?.[other]||{};name=od.name||'Unknown';pfp=od.pfp||'';}
    const unread=item.unread?.[CU.uid]||0;
    const av=pfp?`<div class="ci-av"><img src="${pfp}" onerror="this.style.display='none'"/></div>`:`<div class="ci-av">${(name[0]||'?').toUpperCase()}</div>`;
    return`<div class="ci${activeChatId===item.id?' active':''}" onclick="openChat('${item.id}','${item.type||'private'}')" data-id="${item.id}">
      ${av}
      <div class="ci-info"><div class="ci-name">${esc(name)}</div><div class="ci-last">${esc(last)}</div></div>
      <div class="ci-meta"><span class="ci-time">${fmtTime(item.lastTime)}</span>${unread?`<span class="ci-badge">${unread}</span>`:''}</div>
    </div>`;
  }).join('');
}
window.filterChats=function(val){
  document.querySelectorAll('.ci').forEach(el=>{
    const nameEl=el.querySelector('.ci-name');
    if(nameEl)el.style.display=nameEl.textContent.toLowerCase().includes(val.toLowerCase())?'':'none';
  });
};
window.switchSideTab=function(tab,el){
  document.querySelectorAll('.stab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.getElementById('pane-'+tab).classList.add('active');
};

// ‚îÄ‚îÄ OPEN CHAT ‚îÄ‚îÄ
window.openChat=async function(cid,type){
  if(msgsUnsub){msgsUnsub();msgsUnsub=null;}
  document.getElementById('msgs').innerHTML='';
  document.getElementById('gc-rules-banner').classList.remove('show');
  document.getElementById('gc-rules-text').textContent='';
  document.getElementById('ch-name').textContent='Loading...';
  document.getElementById('ch-sub').textContent='';
  document.getElementById('ch-avatar').innerHTML='';
  hideTagSuggest();cancelEdit();
  activeChatId=cid;activeChatType=type;
  document.getElementById('sidebar').classList.add('hidden');
  document.getElementById('no-chat').style.display='none';
  document.getElementById('active-chat').style.display='flex';
  document.querySelectorAll('.ci').forEach(el=>el.classList.toggle('active',el.dataset.id===cid));
  const gcBanner=document.getElementById('gc-rules-banner');
  try{
    const snap=await getDoc(doc(db,'chats',cid));
    if(!snap.exists())return;
    activeChatData={id:snap.id,...snap.data()};
    const d=activeChatData;
    const chAv=document.getElementById('ch-avatar');
    if(type==='group'){
      document.getElementById('ch-name').textContent=d.name||'Group';
      document.getElementById('ch-sub').textContent=(d.members||[]).length+' members';
      chAv.innerHTML=d.icon?`<img src="${d.icon}"/>`:(d.name||'G')[0].toUpperCase();
      gcMembers=d.members||[];
      if(d.rules?.length){gcBanner.classList.add('show');document.getElementById('gc-rules-text').textContent=d.rules.join(' ‚Ä¢ ');}
      else gcBanner.classList.remove('show');
    }else{
      gcBanner.classList.remove('show');gcMembers=[];
      const other=d.members?.find(m=>m!==CU.uid);
      const od=d.memberData?.[other]||{};
      document.getElementById('ch-name').textContent=od.name||'User';
      document.getElementById('ch-sub').textContent=od.username?'@'+od.username:'Private chat';
      chAv.innerHTML=od.pfp?`<img src="${od.pfp}"/>`:(od.name||'U')[0].toUpperCase();
    }
    try{await updateDoc(doc(db,'chats',cid),{[`unread.${CU.uid}`]:0});}catch(e){}
  }catch(e){console.error('openChat',e);}
  loadMessages(cid);
};
window.closeChat=function(){
  document.getElementById('sidebar').classList.remove('hidden');
  document.getElementById('active-chat').style.display='none';
  document.getElementById('no-chat').style.display='flex';
  if(msgsUnsub){msgsUnsub();msgsUnsub=null;}
  document.getElementById('msgs').innerHTML='';
  activeChatId=null;activeChatType=null;activeChatData=null;
  gcMembers=[];cancelEdit();hideTagSuggest();
};

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ
const _msgCache={};
function loadMessages(cid){
  if(msgsUnsub){msgsUnsub();msgsUnsub=null;}
  document.getElementById('msgs').innerHTML='';
  const capturedType=activeChatType;
  const q=query(collection(db,'chats',cid,'messages'),orderBy('timestamp','asc'));
  msgsUnsub=onSnapshot(q,snap=>{
    if(activeChatId!==cid)return;
    snap.docs.forEach(d=>{_msgCache[d.id]={id:d.id,...d.data()};});
    renderMsgs(snap.docs.map(d=>({id:d.id,...d.data()})),capturedType);
    snap.docChanges().forEach(ch=>{
      if(ch.type==='added'){
        const m={id:ch.doc.id,...ch.doc.data()};
        if(m.senderId!==CU.uid){
          if(m.tags?.includes(CU.uid)){
            toast(`@${m.senderUsername||m.senderName} tagged you!`,3500,()=>{
              document.getElementById('msg_'+m.id)?.scrollIntoView({behavior:'smooth',block:'center'});
            });
          }else if(m.text?.includes('@all')&&m.tags?.includes(CU.uid)){
            toast(`üì¢ ${m.senderName||'Admin'} sent an @all message`,3500);
          }
        }
      }
    });
  });
}
function renderMsgs(msgs,chatType){
  const c=document.getElementById('msgs');
  const atBot=c.scrollHeight-c.scrollTop-c.clientHeight<160;
  c.innerHTML=msgs.map(m=>renderMsg(m,chatType)).join('');
  if(atBot||msgs.length<=2)c.scrollTop=c.scrollHeight;
  msgs.forEach(m=>{
    if(m.senderId===CU.uid&&!m.deleted&&!m.edited&&m.timestamp){
      const sl=secsLeft(m.timestamp);
      if(sl>0){
        const el=document.getElementById('etimer_'+m.id);
        if(el){
          clearInterval(editTimers[m.id]);
          editTimers[m.id]=setInterval(()=>{
            const e=document.getElementById('etimer_'+m.id);
            if(!e){clearInterval(editTimers[m.id]);return;}
            const s=secsLeft(m.timestamp);
            if(s>0)e.textContent='‚úèÔ∏è '+s+'s';
            else{e.style.display='none';clearInterval(editTimers[m.id]);}
          },1000);
        }
      }
    }
  });
}
function renderMsg(m,chatType){
  const isOut=m.senderId===CU.uid;
  if(m.deleted)return`<div class="mw ${isOut?'out':'in'}"><div class="mb deleted">üö´ Deleted</div><span class="m-time">${fmtTime(m.timestamp)}</span></div>`;
  const sl=secsLeft(m.timestamp);
  const attr=`oncontextmenu="showCtx(event,'${m.id}')" ondblclick="showCtx(event,'${m.id}')" id="msg_${m.id}"`;
  let content='';
  if(m.type==='text')content=`<div class="mb${m.edited?' edited':''}" ${attr}>${formatText(esc(m.text||''))}</div>`;
  else if(m.type==='image')content=`<div class="mb" ${attr}><img class="m-img" src="${m.url}" onclick="openImgViewer('${m.url}')"/></div>`;
  else if(m.type==='audio')content=`<div class="mb m-audio" ${attr}><audio controls src="${m.url}" style="width:210px"></audio></div>`;
  const reactions=m.reactions||{};
  const rHtml=Object.entries(reactions).filter(([,v])=>v?.length).map(([e,u])=>
    `<div class="rpill${u.includes(CU.uid)?' mine':''}" onclick="reactMsg('${m.id}','${e}')">${e}<span class="rc">${u.length}</span></div>`).join('');
  const sName=!isOut&&chatType==='group'?`<div class="m-sender" style="color:var(--accent)">${esc(m.senderName||'')}</div>`:'';
  const timerHtml=isOut&&!m.edited&&sl>0?`<span class="edit-timer" id="etimer_${m.id}">‚úèÔ∏è ${sl}s</span>`:'';
  return`<div class="mw ${isOut?'out':'in'}">${sName}${content}${rHtml?`<div class="m-reactions">${rHtml}</div>`:''}<span class="m-time">${fmtTime(m.timestamp)}</span>${timerHtml}</div>`;
}
function formatText(txt){return txt.replace(/@all\b/g,'<span class="tag-highlight" style="background:rgba(0,212,170,0.15);padding:1px 5px;border-radius:4px">@all</span>').replace(/@(\w+)/g,'<span class="tag-highlight">@$1</span>');}

// ‚îÄ‚îÄ SEND MESSAGE ‚îÄ‚îÄ
window.sendMessage=async function(){
  if(!activeChatId)return;
  const ta=document.getElementById('msg-txt');
  const txt=ta.value.trim();if(!txt)return;
  if(editingMsgId){
    try{
      const mRef=doc(db,'chats',activeChatId,'messages',editingMsgId);
      const snap=await getDoc(mRef);
      if(!snap.exists()||snap.data().senderId!==CU.uid){toast('‚ùå Cannot edit');cancelEdit();return;}
      if(secsLeft(snap.data().timestamp)===0){toast('‚è∞ Edit window closed');cancelEdit();return;}
      await updateDoc(mRef,{text:txt,edited:true,editedAt:serverTimestamp()});
    }catch(e){toast('‚ùå '+e.message);}
    cancelEdit();ta.value='';autoResize(ta);return;
  }
  let tags=[];
  if(activeChatType==='group'){
    // @all handling
    if(txt.includes('@all')){
      const isAdmin=activeChatData?.admins?.includes(CU.uid);
      const perms=activeChatData?.permissions||{};
      if(perms.adminOnlyAtAll&&!isAdmin){toast('üîí Only admins can use @all');return;}
      tags=[...gcMembers];// tag everyone
    }else{
      const tagMatches=[...txt.matchAll(/@(\w+)/g)].map(m=>m[1]);
      for(const uname of tagMatches){
        try{const s=await getDocs(query(collection(db,'users'),where('username','==',uname)));if(!s.empty)tags.push(s.docs[0].data().uid);}catch(e){}
      }
    }
  }
  ta.value='';autoResize(ta);
  try{
    await addDoc(collection(db,'chats',activeChatId,'messages'),{type:'text',text:txt,senderId:CU.uid,senderName:CUD?.name||CU.displayName||'User',senderUsername:CUD?.username||'',timestamp:serverTimestamp(),reactions:{},tags,deleted:false,edited:false});
    await updateChatMeta(txt);
  }catch(e){toast('‚ùå '+e.message);}
};
window.handleEnter=function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}};

async function updateChatMeta(lastMsg){
  if(!activeChatId)return;
  try{
    const snap=await getDoc(doc(db,'chats',activeChatId));
    const d=snap.data()||{};
    const unread={...d.unread||{}};
    (d.members||[]).forEach(m=>{if(m!==CU.uid)unread[m]=(unread[m]||0)+1;});
    await updateDoc(doc(db,'chats',activeChatId),{lastMsg,lastTime:serverTimestamp(),unread});
  }catch(e){}
}

window.sendMedia=async function(input){
  if(!activeChatId||!input.files[0])return;
  const file=input.files[0];toast('Uploading... üì§');
  try{
    const url=await uploadCloud(file,'media');
    await addDoc(collection(db,'chats',activeChatId,'messages'),{type:'image',url,senderId:CU.uid,senderName:CUD?.name||CU.displayName||'User',timestamp:serverTimestamp(),reactions:{},tags:[],deleted:false,edited:false});
    await updateChatMeta(file.type.startsWith('video')?'üé• Video':'üì∑ Photo');
    toast('Sent ‚úÖ');
  }catch(e){toast('‚ùå '+e.message);}
  input.value='';
};

// ‚îÄ‚îÄ VOICE NOTE ‚îÄ‚îÄ
window.toggleVN=async function(){
  if(mediaRecorder&&mediaRecorder.state==='recording'){stopAndSendVN();return;}
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const targetChatId=activeChatId;
    mediaRecorder=new MediaRecorder(stream);recChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recChunks.push(e.data);};
    mediaRecorder.onstop=async()=>{
      stream.getTracks().forEach(t=>t.stop());
      if(!recChunks.length||!targetChatId)return;
      const blob=new Blob(recChunks,{type:'audio/webm'});
      const file=new File([blob],`vn_${Date.now()}.webm`,{type:'audio/webm'});
      toast('Sending voice note...');
      try{
        const url=await uploadCloud(file,'voicenotes');
        await addDoc(collection(db,'chats',targetChatId,'messages'),{type:'audio',url,senderId:CU.uid,senderName:CUD?.name||CU.displayName||'User',timestamp:serverTimestamp(),reactions:{},tags:[],deleted:false,edited:false});
        const snapMeta=await getDoc(doc(db,'chats',targetChatId));
        const dMeta=snapMeta.data()||{};
        const unreadMeta={...dMeta.unread||{}};
        (dMeta.members||[]).forEach(m=>{if(m!==CU.uid)unreadMeta[m]=(unreadMeta[m]||0)+1;});
        await updateDoc(doc(db,'chats',targetChatId),{lastMsg:'üé§ Voice note',lastTime:serverTimestamp(),unread:unreadMeta});
        toast('Sent ‚úÖ');
      }catch(e){toast('‚ùå VN: '+e.message);}
    };
    mediaRecorder.start();startRecTimer();
    document.getElementById('normal-iw').style.display='none';
    document.getElementById('vn-bar').classList.add('show');
    document.getElementById('vn-btn').style.display='none';
  }catch(e){resetVNUI();toast('‚ùå Mic access denied');}
};
window.stopAndSendVN=function(){if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();stopRecTimer();resetVNUI();};
window.cancelVN=function(){
  if(mediaRecorder&&mediaRecorder.state==='recording'){mediaRecorder.onstop=()=>{};mediaRecorder.stop();}
  recChunks=[];stopRecTimer();resetVNUI();
};
function resetVNUI(){
  mediaRecorder=null;
  document.getElementById('normal-iw').style.display='flex';
  document.getElementById('vn-bar').classList.remove('show');
  document.getElementById('vn-btn').style.display='flex';
}
function startRecTimer(){
  recSeconds=0;document.getElementById('rec-time').textContent='0:00';
  recTimer=setInterval(()=>{recSeconds++;document.getElementById('rec-time').textContent=Math.floor(recSeconds/60)+':'+(recSeconds%60+'').padStart(2,'0');},1000);
}
function stopRecTimer(){clearInterval(recTimer);recTimer=null;recSeconds=0;}

// ‚îÄ‚îÄ CTX MENU ‚îÄ‚îÄ
window.showCtx=function(e,msgId){
  e.preventDefault();
  ctxMsgId=msgId;
  ctxMsgData=_msgCache[msgId]||null;
  if(!ctxMsgData)return;
  const menu=document.getElementById('msg-ctx-menu');
  const isOwn=ctxMsgData.senderId===CU.uid;
  const isAdmin=activeChatType==='group'&&activeChatData?.admins?.includes(CU.uid);
  const canEdit=isOwn&&!ctxMsgData.deleted&&!ctxMsgData.edited&&secsLeft(ctxMsgData.timestamp)>0&&ctxMsgData.type==='text';
  document.getElementById('ctx-edit').style.display=canEdit?'flex':'none';
  document.getElementById('ctx-delete').style.display=isOwn&&!ctxMsgData.deleted?'flex':'none';
  document.getElementById('ctx-admin-delete').style.display=isAdmin&&!isOwn&&!ctxMsgData.deleted?'flex':'none';
  menu.style.left=Math.min(e.clientX,window.innerWidth-175)+'px';
  menu.style.top=Math.min(e.clientY,window.innerHeight-190)+'px';
  menu.classList.add('show');
};
function hideCtxMenu(){document.getElementById('msg-ctx-menu').classList.remove('show');ctxMsgId=null;ctxMsgData=null;}
window.showEmojiFromCtx=function(){
  if(!ctxMsgId)return;
  const savedId=ctxMsgId;
  const menu=document.getElementById('msg-ctx-menu');
  const ep=document.getElementById('global-ep');
  ep.innerHTML=EMOJIS.map(e=>`<button onclick="reactMsg('${savedId}','${e}');document.getElementById('global-ep').classList.remove('show')">${e}</button>`).join('');
  ep.style.left=menu.style.left;ep.style.top=(parseInt(menu.style.top)-72)+'px';
  ep.classList.add('show');hideCtxMenu();
};
window.startEdit=function(){
  if(!ctxMsgId||!ctxMsgData)return;
  if(ctxMsgData.senderId!==CU.uid){hideCtxMenu();return;}
  if(secsLeft(ctxMsgData.timestamp)===0){toast('‚è∞ Edit window closed');hideCtxMenu();return;}
  editingMsgId=ctxMsgId;
  document.getElementById('msg-txt').value=ctxMsgData.text||'';
  document.getElementById('edit-preview').textContent=ctxMsgData.text||'';
  document.getElementById('edit-bar').classList.add('show');
  document.getElementById('msg-txt').focus();
  hideCtxMenu();
};
window.cancelEdit=function(){editingMsgId=null;document.getElementById('edit-bar').classList.remove('show');document.getElementById('msg-txt').value='';};

// ‚îÄ‚îÄ DELETE (FIXED) ‚îÄ‚îÄ
window.deleteMsg=async function(){
  if(!ctxMsgId||!activeChatId)return;
  const msgId=ctxMsgId;
  const cid=activeChatId;
  hideCtxMenu();
  try{
    const mRef=doc(db,'chats',cid,'messages',msgId);
    const snap=await getDoc(mRef);
    if(!snap.exists())return;
    await updateDoc(mRef,{deleted:true,text:'',url:''});
    toast('Message deleted');
  }catch(e){toast('‚ùå '+e.message);}
};
window.adminDeleteMsg=async function(){
  if(!ctxMsgId||!activeChatId)return;
  const msgId=ctxMsgId;
  const cid=activeChatId;
  hideCtxMenu();
  try{
    const mRef=doc(db,'chats',cid,'messages',msgId);
    const snap=await getDoc(mRef);
    if(!snap.exists())return;
    await updateDoc(mRef,{deleted:true,text:'',url:''});
    toast('Deleted');
  }catch(e){toast('‚ùå '+e.message);}
};

// ‚îÄ‚îÄ REACTIONS (FIXED) ‚îÄ‚îÄ
window.reactMsg=async function(msgId,emoji){
  if(!activeChatId)return;
  try{
    const mRef=doc(db,'chats',activeChatId,'messages',msgId);
    const snap=await getDoc(mRef);if(!snap.exists())return;
    const users=snap.data().reactions?.[emoji]||[];
    if(users.includes(CU.uid))await updateDoc(mRef,{[`reactions.${emoji}`]:arrayRemove(CU.uid)});
    else await updateDoc(mRef,{[`reactions.${emoji}`]:arrayUnion(CU.uid)});
  }catch(e){toast('‚ùå React failed: '+e.message);}
};

// ‚îÄ‚îÄ TAG SUGGEST ‚îÄ‚îÄ
window.handleInput=function(el){
  autoResize(el);
  const before=el.value.slice(0,el.selectionStart);
  const match=before.match(/@(\w*)$/);
  if(match&&activeChatType==='group')showTagSuggest(match[1]);
  else hideTagSuggest();
};
async function showTagSuggest(partial){
  if(!gcMembers.length){hideTagSuggest();return;}
  const sug=document.getElementById('tag-suggest');
  const matches=[];
  const isAdmin=activeChatData?.admins?.includes(CU.uid);
  const perms=activeChatData?.permissions||{};
  // Add @all option for admins (or if not restricted)
  if(!partial||'all'.startsWith(partial)){
    if(isAdmin||!perms.adminOnlyAtAll){
      matches.push({username:'all',name:'Notify Everyone',pfp:'',uid:'__all__',special:true});
    }
  }
  const memberData=activeChatData?.memberData||{};
  for(const uid of gcMembers){
    if(uid===CU.uid)continue;
    const u=memberData[uid];if(!u)continue;
    if(!partial||u.username?.startsWith(partial)||u.name?.toLowerCase().startsWith(partial.toLowerCase()))matches.push({...u,uid});
    if(matches.length>=6)break;
  }
  if(!matches.length){hideTagSuggest();return;}
  sug.innerHTML=matches.map(u=>`
    <div class="tag-opt" onclick="insertTag('${u.username}')">
      ${u.special?`<div class="tag-av" style="background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000">@</div>`
      :u.pfp?`<img src="${u.pfp}"/>`:`<div class="tag-av">${(u.name||'?')[0]}</div>`}
      <span>@${esc(u.username)} <span style="color:var(--text2);font-size:11px">${esc(u.name)}</span></span>
    </div>`).join('');
  sug.classList.add('show');
}
function hideTagSuggest(){document.getElementById('tag-suggest').classList.remove('show');}
window.insertTag=function(username){
  const ta=document.getElementById('msg-txt');
  const cursor=ta.selectionStart;
  const before=ta.value.slice(0,cursor).replace(/@\w*$/,'@'+username+' ');
  ta.value=before+ta.value.slice(cursor);
  ta.focus();ta.selectionStart=ta.selectionEnd=before.length;
  hideTagSuggest();
};

// ‚îÄ‚îÄ GROUP CREATE ‚îÄ‚îÄ
window.openGcModal=function(){
  gcMembersToAdd=[];gcRulesArr=[];
  document.getElementById('gc-name').value='';document.getElementById('gc-desc').value='';
  document.getElementById('gc-members-list').innerHTML='';document.getElementById('rules-preview').innerHTML='';
  document.getElementById('gc-icon-preview').innerHTML='üë•';pendingGcIconFile=null;hideErr('gc-err');
  document.getElementById('gc-overlay').classList.add('show');
};
window.addGcMember=async function(){
  const uname=document.getElementById('gc-member-input').value.trim().replace('@','');
  if(!uname||uname===CUD?.username||gcMembersToAdd.find(m=>m.username===uname))return;
  try{
    const snap=await getDocs(query(collection(db,'users'),where('username','==',uname)));
    if(snap.empty){toast('@'+uname+' not found.');return;}
    gcMembersToAdd.push(snap.docs[0].data());
    document.getElementById('gc-member-input').value='';renderGcMembers();
  }catch(e){toast('‚ùå '+e.message);}
};
function renderGcMembers(){
  document.getElementById('gc-members-list').innerHTML=gcMembersToAdd.map((m,i)=>
    `<div style="display:flex;align-items:center;gap:8px;background:var(--bg3);padding:8px 11px;border-radius:var(--radius-sm)">
      <span style="font-size:12px;flex:1">${esc(m.name)} <span style="color:var(--text2)">@${esc(m.username)}</span></span>
      <button onclick="removeGcMember(${i})" style="background:none;border:none;color:var(--danger);cursor:pointer">‚úï</button>
    </div>`).join('');
}
window.removeGcMember=function(i){gcMembersToAdd.splice(i,1);renderGcMembers();};
window.addRuleInput=function(){
  const rule=document.getElementById('gc-rule-input').value.trim();if(!rule)return;
  gcRulesArr.push(rule);document.getElementById('gc-rule-input').value='';
  document.getElementById('rules-preview').innerHTML=gcRulesArr.map((r,i)=>`<li class="rule-item">üìå ${esc(r)}<button onclick="removeRule(${i})">‚úï</button></li>`).join('');
};
window.removeRule=function(i){gcRulesArr.splice(i,1);document.getElementById('rules-preview').innerHTML=gcRulesArr.map((r,j)=>`<li class="rule-item">üìå ${esc(r)}<button onclick="removeRule(${j})">‚úï</button></li>`).join('');};
window.createGroup=async function(){
  const name=document.getElementById('gc-name').value.trim();
  if(!name){showErr('gc-err','Group name required.');return;}
  const btn=document.querySelector('#gc-overlay .btn:not(.btn-ghost)');
  btn.disabled=true;btn.textContent='Creating...';
  try{
    let icon='';
    if(pendingGcIconFile){icon=await uploadCloud(pendingGcIconFile,'group-icons');pendingGcIconFile=null;}
    const allMembers=[CU.uid,...gcMembersToAdd.map(m=>m.uid)];
    const memberData={[CU.uid]:{name:CUD?.name||CU.displayName,pfp:CUD?.pfp||'',username:CUD?.username||''}};
    gcMembersToAdd.forEach(m=>{memberData[m.uid]={name:m.name,pfp:m.pfp||'',username:m.username||''};});
    const gcDoc=await addDoc(collection(db,'chats'),{
      type:'group',name,description:document.getElementById('gc-desc').value.trim(),
      icon,members:allMembers,memberData,admins:[CU.uid],rules:gcRulesArr,
      lastMsg:'Group created',lastTime:serverTimestamp(),unread:{},
      permissions:{membersCanSend:true,membersCanAddMembers:true}
    });
    closeModal('gc-overlay');toast('"'+name+'" created! üéâ');openChat(gcDoc.id,'group');
  }catch(e){showErr('gc-err',e.message);}
  finally{btn.disabled=false;btn.textContent='Create';}
};

// ‚îÄ‚îÄ CHAT INFO + GROUP PERMISSIONS ‚îÄ‚îÄ
window.openChatInfo=async function(){
  if(!activeChatId)return;
  const title=document.getElementById('chatinfo-title');
  const content=document.getElementById('chatinfo-content');
  const footer=document.getElementById('chatinfo-footer');
  try{
    if(activeChatType==='group'){
      const snap=await getDoc(doc(db,'chats',activeChatId));
      const d=snap.data()||{};
      title.textContent=d.name||'Group Info';
      const isAdmin=d.admins?.includes(CU.uid);
      const perms=d.permissions||{membersCanSend:true,membersCanAddMembers:true};
      const membersHtml=Object.entries(d.memberData||{}).map(([uid,m])=>`
        <div class="member-item">
          <div class="m-av">${m.pfp?`<img src="${m.pfp}"/>`:(m.name||'?')[0]}</div>
          <span>${esc(m.name)} ${m.username?`<span style="color:var(--text2);font-size:11px">@${esc(m.username)}</span>`:''}</span>
          ${d.admins?.includes(uid)?'<span class="badge">Admin</span>':''}
          ${isAdmin&&uid!==CU.uid?`<button onclick="adminRemoveMember('${uid}')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:12px;padding:2px 6px">Remove</button>`:''}
        </div>`).join('');
      const rulesHtml=d.rules?.length?`<div style="margin-top:14px"><strong style="font-size:12px;color:var(--accent)">üìã Rules</strong><ul class="rules-list" style="margin-top:8px">${d.rules.map(r=>`<li class="rule-item">üìå ${esc(r)}</li>`).join('')}</ul></div>`:'';
      const adminHtml=isAdmin?`
        <div style="margin-top:16px">
          <strong style="font-size:12px;color:var(--accent)">‚öôÔ∏è Admin Tools</strong>
          <div style="display:flex;gap:7px;margin-top:8px">
            <input type="text" id="admin-add-input" placeholder="@username to add" style="flex:1;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:12px;outline:none" oninput="this.value=this.value.replace(/[^a-z0-9_@]/g,'').toLowerCase()"/>
            <button class="ibtn" onclick="adminAddMember()" style="width:auto;padding:0 10px;border-radius:var(--radius-sm)">Add</button>
          </div>
          <div style="display:flex;gap:7px;margin-top:8px">
            <input type="text" id="admin-promote-input" placeholder="@username to make admin" style="flex:1;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:12px;outline:none" oninput="this.value=this.value.replace(/[^a-z0-9_@]/g,'').toLowerCase()"/>
            <button class="ibtn" onclick="adminPromoteMember()" style="width:auto;padding:0 10px;border-radius:var(--radius-sm);font-size:11px">‚òÖ Admin</button>
          </div>
          <div style="display:flex;gap:7px;margin-top:8px">
            <input type="text" id="admin-rule-input" placeholder="Add rule..." style="flex:1;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:12px;outline:none"/>
            <button class="ibtn" onclick="adminAddRule()" style="width:auto;padding:0 10px;border-radius:var(--radius-sm)">+</button>
          </div>
          <div style="margin-top:14px">
            <strong style="font-size:12px;color:var(--accent)">üîí Permissions</strong>
            <div class="perm-row" style="margin-top:8px">
              <div class="perm-info"><div class="perm-label">Members can send messages</div><div class="perm-desc">Allow all members to chat</div></div>
              <button class="toggle-btn ${perms.membersCanSend?'on':''}" id="perm-send-toggle" onclick="togglePerm('membersCanSend',this)"></button>
            </div>
            <div class="perm-row">
              <div class="perm-info"><div class="perm-label">Members can add members</div><div class="perm-desc">Allow members to invite others</div></div>
              <button class="toggle-btn ${perms.membersCanAddMembers?'on':''}" id="perm-add-toggle" onclick="togglePerm('membersCanAddMembers',this)"></button>
            </div>
            <div class="perm-row">
              <div class="perm-info"><div class="perm-label">@all tag (Admins only)</div><div class="perm-desc">Only admins can use @all to notify everyone</div></div>
              <button class="toggle-btn ${perms.adminOnlyAtAll?'on':''}" id="perm-atall-toggle" onclick="togglePerm('adminOnlyAtAll',this)"></button>
            </div>
          </div>
        </div>`:
        // Non-admin can see permissions
        `<div style="margin-top:14px;padding:10px;background:var(--bg3);border-radius:var(--radius-sm)">
          <div style="font-size:12px;color:var(--text2)">
            ${perms.membersCanSend?'‚úÖ':'‚ùå'} Members can send messages<br/>
            ${perms.membersCanAddMembers?'‚úÖ':'‚ùå'} Members can add members<br/>
            ${perms.adminOnlyAtAll?'üîí':'‚úÖ'} @all tag: ${perms.adminOnlyAtAll?'Admins only':'Everyone'}
          </div>
        </div>`;
      content.innerHTML=`<p style="font-size:12px;color:var(--text2);margin-bottom:12px">${esc(d.description||'')}</p><div class="members-list">${membersHtml}</div>${rulesHtml}${adminHtml}`;
      footer.innerHTML=`<button class="btn btn-ghost" onclick="closeModal('chatinfo-overlay')">Close</button><button class="btn btn-danger" onclick="leaveGroup()">Leave</button>`;
    }else{
      const d=activeChatData||{};
      const other=d.members?.find(m=>m!==CU.uid);
      const od=d.memberData?.[other]||{};
      title.textContent='Contact Info';
      content.innerHTML=`<div style="text-align:center;padding:18px 0">
        ${od.pfp?`<img src="${od.pfp}" style="width:76px;height:76px;border-radius:50%;object-fit:cover;border:2.5px solid var(--accent)"/>`:`<div class="ci-av" style="width:76px;height:76px;font-size:28px;margin:0 auto">${(od.name||'?')[0]}</div>`}
        <div style="font-size:17px;font-weight:700;margin-top:12px">${esc(od.name||'')}</div>
        ${od.username?`<div style="font-size:12px;color:var(--text2);margin-top:4px">@${esc(od.username)}</div>`:''}
      </div>`;
      footer.innerHTML=`<button class="btn btn-ghost" onclick="closeModal('chatinfo-overlay')">Close</button>`;
    }
  }catch(e){content.innerHTML='<p style="color:var(--danger)">Failed to load.</p>';}
  document.getElementById('chatinfo-overlay').classList.add('show');
};

window.togglePerm=async function(permKey,btn){
  if(!activeChatId)return;
  event&&event.stopPropagation&&event.stopPropagation();
  const isOn=btn.classList.contains('on');
  btn.classList.toggle('on',!isOn);
  try{
    await updateDoc(doc(db,'chats',activeChatId),{[`permissions.${permKey}`]:!isOn});
    toast('Permission updated ‚úÖ');
  }catch(e){btn.classList.toggle('on',isOn);toast('‚ùå '+e.message);}
};

window.adminAddMember=async function(){
  const uname=document.getElementById('admin-add-input')?.value.trim().replace('@','');
  if(!uname||!activeChatId)return;
  try{
    const snap=await getDocs(query(collection(db,'users'),where('username','==',uname)));
    if(snap.empty){toast('@'+uname+' not found.');return;}
    const u=snap.docs[0].data();
    if(activeChatData?.members?.includes(u.uid)){toast('Already a member.');return;}
    await updateDoc(doc(db,'chats',activeChatId),{members:arrayUnion(u.uid),[`memberData.${u.uid}`]:{name:u.name,pfp:u.pfp||'',username:u.username||''}});
    toast('@'+uname+' added ‚úÖ');openChatInfo();
  }catch(e){toast('‚ùå '+e.message);}
};
window.adminPromoteMember=async function(){
  const uname=document.getElementById('admin-promote-input')?.value.trim().replace('@','');
  if(!uname||!activeChatId)return;
  try{
    const snap=await getDocs(query(collection(db,'users'),where('username','==',uname)));
    if(snap.empty){toast('@'+uname+' not found.');return;}
    const u=snap.docs[0].data();
    if(!activeChatData?.members?.includes(u.uid)){toast('@'+uname+' is not in this group.');return;}
    if(activeChatData?.admins?.includes(u.uid)){toast('@'+uname+' is already an admin.');return;}
    await updateDoc(doc(db,'chats',activeChatId),{admins:arrayUnion(u.uid)});
    toast('@'+uname+' is now an admin ‚≠ê');openChatInfo();
  }catch(e){toast('‚ùå '+e.message);}
};
window.adminRemoveMember=async function(uid){
  if(!activeChatId)return;
  try{await updateDoc(doc(db,'chats',activeChatId),{members:arrayRemove(uid),[`memberData.${uid}`]:deleteField()});toast('Member removed');openChatInfo();}
  catch(e){toast('‚ùå '+e.message);}
};
window.adminAddRule=async function(){
  const rule=document.getElementById('admin-rule-input')?.value.trim();
  if(!rule||!activeChatId)return;
  try{await updateDoc(doc(db,'chats',activeChatId),{rules:arrayUnion(rule)});toast('Rule added ‚úÖ');openChatInfo();}
  catch(e){toast('‚ùå '+e.message);}
};
window.leaveGroup=async function(){
  if(!activeChatId)return;
  try{await updateDoc(doc(db,'chats',activeChatId),{members:arrayRemove(CU.uid),[`memberData.${CU.uid}`]:deleteField()});closeModal('chatinfo-overlay');closeChat();toast('You left the group');}
  catch(e){toast('‚ùå '+e.message);}
};

function listenNotifications(){
  if(!CU)return;
  const q=query(collection(db,'notifications'),where('to','==',CU.uid),where('read','==',false));
  onSnapshot(q,snap=>{
    snap.docs.forEach(async d=>{
      const n=d.data();
      if(n.type==='added_to_group')toast('Added to "'+n.groupName+'" üéâ',4000);
      else if(n.type==='removed_from_group')toast('Removed from "'+n.groupName+'"',4000);
      await updateDoc(d.ref,{read:true});
    });
  });
}

// ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ
window.openStatusModal=function(){
  pendingStatusFile=null;
  document.getElementById('status-preview').innerHTML='';
  document.getElementById('status-caption').value='';
  hideErr('status-err');
  document.getElementById('status-overlay').classList.add('show');
};
window.postStatus=async function(){
  hideErr('status-err');
  if(!pendingStatusFile){showErr('status-err','Choose a photo or video.');return;}
  const btn=document.getElementById('status-post-btn');
  btn.disabled=true;btn.textContent='Uploading...';
  try{
    const url=await uploadCloud(pendingStatusFile,'statuses');
    await addDoc(collection(db,'statuses'),{
      uid:CU.uid,name:CUD?.name||CU.displayName||'User',pfp:CUD?.pfp||'',
      url,caption:document.getElementById('status-caption').value.trim(),
      mediaType:pendingStatusFile.type.startsWith('video')?'video':'image',
      timestamp:serverTimestamp(),
      clientTs:Date.now(),
      expiresAt:Timestamp.fromMillis(Date.now()+24*3600*1000),
      viewers:[],viewerNames:[]
    });
    closeModal('status-overlay');pendingStatusFile=null;
    toast('Status posted! ‚úÖ');loadStatuses();
  }catch(e){showErr('status-err',e.message);}
  finally{btn.disabled=false;btn.textContent='Post';}
};

// ‚îÄ‚îÄ LOAD STATUSES (friends only) ‚îÄ‚îÄ
async function loadStatuses(){
  try{
    const snap=await getDocs(collection(db,'statuses'));
    const now=Date.now();
    const friends=CUD?.friends||[];
    const all=snap.docs.map(d=>({id:d.id,...d.data()})).filter(s=>{
      if(s.uid!==CU.uid&&!friends.includes(s.uid))return false;
      if(!s.expiresAt)return false;
      try{const exp=s.expiresAt.toDate?s.expiresAt.toDate():new Date(s.expiresAt);return exp.getTime()>now;}
      catch(e){return false;}
    });
    renderStatuses(all);
  }catch(e){console.error('loadStatuses',e);}
}
function renderStatuses(all){
  const row=document.getElementById('status-row');
  const mine=all.filter(s=>s.uid===CU.uid);
  const byUser={};
  all.filter(s=>s.uid!==CU.uid).forEach(s=>{if(!byUser[s.uid])byUser[s.uid]=[];byUser[s.uid].push(s);});
  const myAv=CUD?.pfp?`<img src="${CUD.pfp}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`:(CUD?.name?.[0]?.toUpperCase()||'üë§');
  const myClick=mine.length?`viewStatus(${JSON.stringify(mine).replace(/"/g,'&quot;')})`:'openStatusModal()';
  const myHtml=`<div class="st-item" onclick="${myClick}">
    <div class="st-ring${mine.length?' st-mine':' add-btn'}">${mine.length?myAv:'Ôºã'}</div>
    <span>${mine.length?'My Status':'Add'}</span>
  </div>`;
  const othersHtml=Object.entries(byUser).map(([uid,statuses])=>{
    const s=statuses[0];
    return`<div class="st-item" onclick='viewStatus(${JSON.stringify(statuses).replace(/'/g,"&#39;")})'>
      <div class="st-ring">${s.pfp?`<img src="${s.pfp}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`:(s.name||'?')[0].toUpperCase()}</div>
      <span>${esc(s.name||'')}</span>
    </div>`;
  }).join('');
  row.innerHTML=myHtml+othersHtml;
}

// ‚îÄ‚îÄ STATUS VIEWER (with tap left/right + fixed black screen) ‚îÄ‚îÄ
window.viewStatus=function(statuses){
  svStatuses=Array.isArray(statuses)?statuses:JSON.parse(statuses);
  svIdx=0;document.getElementById('sv').classList.add('show');showSVAt(0);
};

// TAP LEFT = previous, TAP RIGHT = next
window.svTapLeft=function(){
  clearTimeout(svProg);
  if(svIdx>0)showSVAt(svIdx-1);
};
window.svTapRight=function(){
  clearTimeout(svProg);
  showSVAt(svIdx+1);
};

async function showSVAt(i){
  if(i>=svStatuses.length){closeSV();return;}
  if(i<0)i=0;
  svIdx=i;const s=svStatuses[i];
  const mediaEl=document.getElementById('sv-media');

  // Clear old media first to avoid black flash
  mediaEl.innerHTML='<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center"><div style="width:40px;height:40px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite"></div></div>';

  // Build bars immediately
  const bars=document.getElementById('sv-bars');
  bars.innerHTML=svStatuses.map((_,j)=>`<div class="sv-bar"><div class="sv-fill" id="svfill_${j}" style="width:${j<i?'100':'0'}%"></div></div>`).join('');
  clearTimeout(svProg);

  document.getElementById('sv-name').textContent=s.name||'';
  const avEl=document.getElementById('sv-av');
  if(s.pfp){avEl.src=s.pfp;avEl.style.display='block';}else{avEl.style.display='none';}

  // Use timestamp from Firestore (server time) for display
  document.getElementById('sv-time').textContent=fmtTime(s.timestamp,s.clientTs);
  document.getElementById('sv-caption').textContent=s.caption||'';
  const isMine=s.uid===CU.uid;
  document.getElementById('sv-delete-btn').style.display=isMine?'inline-block':'none';

  // Viewers
  const viewersWrap=document.getElementById('sv-viewers-wrap');
  const viewersEl=document.getElementById('sv-viewers');
  const viewerNamesEl=document.getElementById('sv-viewer-names');
  if(isMine){
    viewersWrap.style.display='flex';
    try{
      const freshSnap=await getDoc(doc(db,'statuses',s.id));
      if(freshSnap.exists()){
        const fresh=freshSnap.data();
        const viewerIds=fresh.viewers||[];
        const storedNames=fresh.viewerNames||[];
        const cnt=viewerIds.length;
        viewersEl.textContent=cnt+' viewer'+(cnt!==1?'s':'');
        viewerNamesEl.textContent=storedNames.length>0?'Viewed by: '+storedNames.slice(0,5).join(', ')+(cnt>5?` +${cnt-5} more`:''):cnt>0?'Loading...':'No views yet';
      }
    }catch(e){viewersWrap.style.display='none';}
  }else{
    viewersWrap.style.display='none';
    viewersEl.textContent='';viewerNamesEl.textContent='';
    try{
      if(!(s.viewers||[]).includes(CU.uid)){
        await updateDoc(doc(db,'statuses',s.id),{viewers:arrayUnion(CU.uid),viewerNames:arrayUnion(CUD?.name||CU.displayName||'Someone')});
      }
    }catch(e){}
  }

  // Load media - wait for it to load before showing
  if(s.url){
    if(s.mediaType==='video'){
      const vid=document.createElement('video');
      vid.src=s.url;vid.autoplay=true;vid.playsInline=true;
      vid.style.cssText='width:100%;height:100%;object-fit:contain;background:#000';
      vid.onloadedmetadata=()=>{
        mediaEl.innerHTML='';mediaEl.appendChild(vid);
        const duration=vid.duration||15;
        const fill=document.getElementById('svfill_'+i);
        if(fill){fill.style.transition=`width ${duration}s linear`;fill.style.width='100%';}
        svProg=setTimeout(()=>showSVAt(i+1),duration*1000+200);
      };
      vid.onerror=()=>{
        mediaEl.innerHTML='<p style="color:#fff;text-align:center">Failed to load video</p>';
        svProg=setTimeout(()=>showSVAt(i+1),4000);
      };
    }else{
      const img=new Image();
      img.onload=()=>{
        mediaEl.innerHTML='';
        img.style.cssText='width:100%;height:100%;object-fit:contain';
        mediaEl.appendChild(img);
        const fill=document.getElementById('svfill_'+i);
        if(fill){
          requestAnimationFrame(()=>{fill.style.transition='width 8s linear';fill.style.width='100%';});
        }
        svProg=setTimeout(()=>showSVAt(i+1),8200);
      };
      img.onerror=()=>{
        mediaEl.innerHTML='<p style="color:#fff;text-align:center">Failed to load image</p>';
        svProg=setTimeout(()=>showSVAt(i+1),3000);
      };
      img.src=s.url;
    }
  }else{
    mediaEl.innerHTML='';
    svProg=setTimeout(()=>showSVAt(i+1),4000);
  }
}

// Add spin animation for loader
const styleEl=document.createElement('style');
styleEl.textContent='@keyframes spin{to{transform:rotate(360deg)}}';
document.head.appendChild(styleEl);

window.closeSV=function(){
  clearTimeout(svProg);
  document.getElementById('sv').classList.remove('show');
  document.getElementById('sv-media').innerHTML='';
  document.getElementById('sv-viewers').textContent='';
  document.getElementById('sv-viewer-names').textContent='';
  document.getElementById('sv-viewers-wrap').style.display='none';
};
window.deleteStatus=async function(){
  const s=svStatuses[svIdx];
  if(!s||s.uid!==CU.uid)return;
  try{
    await deleteDoc(doc(db,'statuses',s.id));
    svStatuses.splice(svIdx,1);
    if(svStatuses.length)showSVAt(Math.min(svIdx,svStatuses.length-1));
    else closeSV();
    toast('Status deleted ‚úÖ');loadStatuses();
  }catch(e){toast('‚ùå '+e.message);}
};

// ‚îÄ‚îÄ IMG VIEWER ‚îÄ‚îÄ
window.openImgViewer=function(url){document.getElementById('viewer-img').src=url;document.getElementById('img-viewer').classList.add('show');};
window.closeImgViewer=function(){document.getElementById('img-viewer').classList.remove('show');};
document.getElementById('img-viewer').addEventListener('click',function(e){if(e.target===this)closeImgViewer();});

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
window.closeModal=function(id){document.getElementById(id).classList.remove('show');};
document.querySelectorAll('.overlay').forEach(ov=>ov.addEventListener('click',function(e){if(e.target===this)closeModal(this.id);}));
window.autoResize=function(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';};

async function setOnline(){if(!CU)return;try{await setDoc(doc(db,'users',CU.uid),{lastSeen:serverTimestamp()},{merge:true});}catch(e){}}
setInterval(setOnline,30000);
document.addEventListener('visibilitychange',()=>{if(!document.hidden)setOnline();});
</script>
</body>
</html>
