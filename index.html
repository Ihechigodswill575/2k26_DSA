<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="theme-color" content="#0a0f1e"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>2k26_DSA</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:#0a0f1e; --bg2:#111827; --bg3:#1f2937;
  --accent:#00d4aa; --accent2:#0099ff;
  --text:#f1f5f9; --text2:#94a3b8;
  --border:#1e293b; --danger:#ef4444;
  --radius:12px; --radius-sm:8px;
  --transition:0.2s ease; --shadow:0 4px 24px rgba(0,0,0,0.4);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text)}

/* SPLASH */
#splash{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.6s ease}
#splash.hide{opacity:0;pointer-events:none}
#splash img{width:130px;height:130px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);box-shadow:0 0 40px rgba(0,212,170,0.3);animation:zoomIn 0.7s ease 0.2s both}
#splash h1{margin-top:18px;font-size:26px;font-weight:700;letter-spacing:2px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:fadeUp 0.7s ease 0.5s both}
#splash p{margin-top:8px;color:var(--text2);font-size:13px;animation:fadeUp 0.7s ease 0.7s both}
.splash-bar{width:180px;height:3px;background:var(--border);border-radius:3px;margin-top:36px;overflow:hidden;animation:fadeUp 0s ease 1s both}
.splash-fill{height:100%;width:0;border-radius:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));animation:fillBar 2.2s ease 1s forwards}
@keyframes zoomIn{from{opacity:0;transform:scale(0.7)}to{opacity:1;transform:scale(1)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes fillBar{to{width:100%}}

/* AUTH */
#auth{display:none;position:fixed;inset:0;background:var(--bg);z-index:100;align-items:center;justify-content:center;padding:20px}
#auth.show{display:flex}
.auth-card{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:30px 26px;width:100%;max-width:370px;box-shadow:var(--shadow);animation:fadeUp 0.4s ease}
.auth-logo{text-align:center;margin-bottom:24px}
.auth-logo img{width:65px;height:65px;border-radius:50%;border:2px solid var(--accent);margin-bottom:10px}
.auth-logo h2{font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-logo p{color:var(--text2);font-size:12px;margin-top:3px}
.auth-tabs{display:flex;gap:4px;background:var(--bg3);padding:4px;border-radius:var(--radius-sm);margin-bottom:20px}
.auth-tab{flex:1;padding:8px;text-align:center;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text2);transition:var(--transition)}
.auth-tab.active{background:var(--accent);color:#000}
.fg{margin-bottom:14px}
.fg label{display:block;font-size:11px;color:var(--text2);margin-bottom:5px;font-weight:500}
.fg input{width:100%;padding:10px 13px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:14px;outline:none;transition:var(--transition)}
.fg input:focus{border-color:var(--accent)}
.pfp-row{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.pfp-circle{width:50px;height:50px;border-radius:50%;background:var(--bg3);border:2px solid var(--border);object-fit:cover;cursor:pointer;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:22px}
.pfp-circle img{width:100%;height:100%;object-fit:cover}
#pfp-file{display:none}
.pfp-label{font-size:12px;color:var(--accent);cursor:pointer}
.pfp-hint{font-size:11px;color:var(--text2);margin-top:2px}
.btn{width:100%;padding:11px;border:none;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:var(--transition)}
.btn:active{transform:scale(0.98)}
.btn:disabled{opacity:0.6;cursor:not-allowed}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-danger{background:var(--danger);color:#fff}
.err{color:var(--danger);font-size:12px;margin-top:8px;display:none}

/* MAIN */
#main{display:none;height:100%}
#main.show{display:flex}
.app-wrap{display:flex;height:100%;width:100%;overflow:hidden}

/* SIDEBAR */
.sidebar{width:320px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;transition:transform var(--transition)}
.s-header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
.s-header h2{font-size:17px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr-actions{display:flex;gap:6px}
.ibtn{width:34px;height:34px;border-radius:50%;background:var(--bg3);border:none;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);font-size:15px}
.ibtn:hover{background:var(--border);color:var(--text)}

/* STATUS */
.status-row{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;overflow-x:auto;flex-shrink:0;scrollbar-width:none}
.status-row::-webkit-scrollbar{display:none}
.st-item{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;flex-shrink:0}
.st-ring{width:46px;height:46px;border-radius:50%;border:2.5px solid var(--accent);padding:2px;position:relative}
.st-ring img{width:100%;height:100%;border-radius:50%;object-fit:cover}
.st-ring.my-status{border-color:var(--border);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--accent)}
.st-item span{font-size:10px;color:var(--text2);max-width:48px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}

/* SEARCH */
.s-search{padding:8px 14px;flex-shrink:0}
.search-wrap{display:flex;align-items:center;background:var(--bg3);border-radius:var(--radius-sm);padding:0 11px;gap:7px}
.search-wrap input{flex:1;background:none;border:none;color:var(--text);font-family:inherit;font-size:13px;padding:9px 0;outline:none}
.search-wrap input::placeholder{color:var(--text2)}

/* TABS */
.chat-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.ctab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:500;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;transition:var(--transition)}
.ctab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* CHAT LIST */
.chat-list{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.ci{display:flex;align-items:center;gap:11px;padding:11px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:var(--transition)}
.ci:hover,.ci.active{background:var(--bg3)}
.ci-av{width:44px;height:44px;border-radius:50%;object-fit:cover;flex-shrink:0;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:600;color:var(--accent)}
.ci-info{flex:1;min-width:0}
.ci-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ci-last{font-size:12px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.ci-meta{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}
.ci-time{font-size:10px;color:var(--text2)}
.ci-badge{background:var(--accent);color:#000;font-size:10px;font-weight:700;border-radius:10px;padding:2px 6px;min-width:17px;text-align:center}

/* CHAT AREA */
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--bg);position:relative;overflow:hidden}
.no-chat{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text2);gap:10px}
.no-chat .big{font-size:60px;opacity:0.25}
.no-chat p{font-size:14px}

/* CHAT HEADER */
.ch-header{display:flex;align-items:center;gap:11px;padding:11px 14px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0}
.ch-info{flex:1;min-width:0}
.ch-name{font-size:15px;font-weight:600}
.ch-sub{font-size:11px;color:var(--text2)}
.back-btn{display:none;background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;padding:4px}

/* MESSAGES */
.msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:5px;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.mw{display:flex;flex-direction:column;max-width:70%}
.mw.out{align-self:flex-end;align-items:flex-end}
.mw.in{align-self:flex-start;align-items:flex-start}
.mb{padding:8px 12px;border-radius:16px;font-size:14px;line-height:1.5;position:relative;word-break:break-word;cursor:pointer}
.mw.out .mb{background:rgba(0,212,170,0.12);border:1px solid rgba(0,212,170,0.18);border-bottom-right-radius:4px}
.mw.in .mb{background:var(--bg3);border-bottom-left-radius:4px}
.m-time{font-size:10px;color:var(--text2);margin-top:2px;padding:0 3px}
.m-sender{font-size:11px;color:var(--accent);font-weight:600;margin-bottom:2px}
.m-img{max-width:200px;border-radius:10px;cursor:pointer;display:block}
.m-audio audio{width:210px;border-radius:8px}
.m-reactions{display:flex;gap:3px;flex-wrap:wrap;margin-top:3px}
.rpill{background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:2px 7px;font-size:12px;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:2px}
.rpill:hover{border-color:var(--accent)}
.rpill .rc{font-size:10px;color:var(--text2)}
.emoji-picker{display:none;position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:7px;gap:4px;z-index:50;box-shadow:var(--shadow);flex-wrap:wrap;width:190px}
.emoji-picker.show{display:flex}
.emoji-picker button{background:none;border:none;font-size:19px;cursor:pointer;padding:3px;border-radius:6px;transition:var(--transition)}
.emoji-picker button:hover{background:var(--bg3);transform:scale(1.2)}

/* INPUT */
.chat-input{padding:10px 14px;background:var(--bg2);border-top:1px solid var(--border);display:flex;align-items:flex-end;gap:8px;flex-shrink:0}
.iw{flex:1;background:var(--bg3);border-radius:var(--radius);padding:9px 12px;display:flex;align-items:flex-end;gap:7px;min-height:42px}
.iw textarea{flex:1;background:none;border:none;color:var(--text);font-family:inherit;font-size:14px;resize:none;outline:none;max-height:110px;line-height:1.5;min-height:21px}
.iw textarea::placeholder{color:var(--text2)}
.send-btn{width:42px;height:42px;border-radius:50%;border:none;flex-shrink:0;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;transition:var(--transition)}
.send-btn:active{transform:scale(0.92)}
.send-btn:disabled{opacity:0.5}

/* VN */
.vn-bar{display:none;align-items:center;gap:9px;flex:1;background:var(--bg3);border-radius:var(--radius);padding:9px 12px}
.vn-bar.show{display:flex}
.rec-dot{width:9px;height:9px;border-radius:50%;background:var(--danger);animation:pulse 1s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.rec-time{font-size:14px;font-weight:600;flex:1}
.rec-cancel{background:none;border:none;color:var(--text2);cursor:pointer;font-size:19px}

/* MODALS */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;align-items:center;justify-content:center;padding:18px}
.overlay.show{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:22px;width:100%;max-width:390px;max-height:88vh;overflow-y:auto;animation:fadeUp 0.3s ease}
.modal h3{font-size:16px;font-weight:700;margin-bottom:18px}
.mfooter{display:flex;gap:9px;margin-top:18px}
.mfooter .btn{flex:1}
.rules-list{list-style:none;display:flex;flex-direction:column;gap:7px}
.rule-item{display:flex;align-items:center;gap:8px;background:var(--bg3);padding:9px 11px;border-radius:var(--radius-sm);font-size:13px}
.rule-item button{background:none;border:none;color:var(--danger);cursor:pointer;margin-left:auto;font-size:15px}
.members-list{display:flex;flex-direction:column;gap:8px;max-height:250px;overflow-y:auto}
.member-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:var(--radius-sm);background:var(--bg3)}
.member-item img{width:34px;height:34px;border-radius:50%;object-fit:cover}
.member-item span{flex:1;font-size:13px}
.member-item .badge{font-size:10px;background:var(--accent);color:#000;padding:2px 6px;border-radius:10px;font-weight:600}

/* PROFILE MENU */
.pmenu{display:none;position:fixed;top:58px;right:14px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:7px;z-index:150;min-width:170px;box-shadow:var(--shadow);animation:fadeUp 0.2s ease}
.pmenu.show{display:block}
.pmi{display:flex;align-items:center;gap:9px;padding:9px 11px;border-radius:var(--radius-sm);cursor:pointer;font-size:13px;transition:var(--transition)}
.pmi:hover{background:var(--bg3)}

/* TOAST */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 18px;font-size:13px;z-index:999;opacity:0;transition:all 0.3s ease;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* IMAGE VIEWER */
.img-viewer{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:500;align-items:center;justify-content:center}
.img-viewer.show{display:flex}
.img-viewer img{max-width:90%;max-height:90%;border-radius:var(--radius);object-fit:contain}
.img-viewer-close{position:absolute;top:20px;right:20px;background:var(--bg3);border:none;color:var(--text);font-size:22px;cursor:pointer;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center}

/* STATUS VIEWER */
.status-viewer{display:none;position:fixed;inset:0;background:#000;z-index:400;flex-direction:column}
.status-viewer.show{display:flex}
.sv-header{display:flex;align-items:center;gap:10px;padding:16px;position:absolute;top:0;left:0;right:0;z-index:1;background:linear-gradient(to bottom,rgba(0,0,0,0.8),transparent)}
.sv-img{flex:1;object-fit:contain;width:100%}
.sv-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;margin-left:auto}
.sv-bar{height:3px;flex:1;background:rgba(255,255,255,0.3);border-radius:3px;overflow:hidden}
.sv-fill{height:100%;background:#fff;border-radius:3px}

/* RESPONSIVE */
@media(max-width:680px){
  .sidebar{position:fixed;inset:0;width:100%;z-index:10;transform:translateX(0)}
  .sidebar.hidden{transform:translateX(-100%)}
  .chat-area{width:100%}
  .back-btn{display:block}
}

/* EMPTY STATE */
.empty-list{text-align:center;padding:40px 20px;color:var(--text2);font-size:13px}
.empty-list .ei{font-size:36px;margin-bottom:8px}

/* GROUP INFO banner */
.gc-rules-banner{background:rgba(0,212,170,0.08);border:1px solid rgba(0,212,170,0.15);border-radius:var(--radius-sm);padding:10px 13px;margin:10px;font-size:12px;color:var(--text2);display:none}
.gc-rules-banner.show{display:block}
.gc-rules-banner strong{color:var(--accent);display:block;margin-bottom:4px}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <img src="https://image2url.com/r2/default/images/1772295169769-b92423f9-499f-4178-942f-409c094d9380.jpg" alt="2k26_DSA" onerror="this.style.display='none'"/>
  <h1>2k26_DSA</h1>
  <p>Welcome to 2k26_DSA üî•</p>
  <div class="splash-bar"><div class="splash-fill"></div></div>
</div>

<!-- AUTH -->
<div id="auth">
  <div class="auth-card">
    <div class="auth-logo">
      <img src="https://image2url.com/r2/default/images/1772295169769-b92423f9-499f-4178-942f-409c094d9380.jpg" alt="logo"/>
      <h2>2k26_DSA</h2>
      <p>Connect. Chat. Vibe.</p>
    </div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')">Login</div>
      <div class="auth-tab" onclick="switchTab('signup')">Sign Up</div>
    </div>
    <!-- LOGIN -->
    <div id="login-form">
      <div class="fg"><label>Email</label><input type="email" id="login-email" placeholder="you@email.com"/></div>
      <div class="fg"><label>Password</label><input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
      <p class="err" id="login-err"></p>
      <button class="btn" onclick="doLogin()">Login</button>
    </div>
    <!-- SIGNUP -->
    <div id="signup-form" style="display:none">
      <div class="pfp-row">
        <div class="pfp-circle" id="pfp-preview" onclick="document.getElementById('pfp-file').click()">üë§</div>
        <div>
          <label class="pfp-label" for="pfp-file">Choose Profile Pic</label>
          <p class="pfp-hint">Tap to upload (Cloudinary)</p>
        </div>
        <input type="file" id="pfp-file" accept="image/*" onchange="previewPfp(this)"/>
      </div>
      <div class="fg"><label>Display Name</label><input type="text" id="su-name" placeholder="Your name"/></div>
      <div class="fg"><label>Email</label><input type="email" id="su-email" placeholder="you@email.com"/></div>
      <div class="fg"><label>Password</label><input type="password" id="su-pass" placeholder="Min 6 characters"/></div>
      <p class="err" id="su-err"></p>
      <button class="btn" onclick="doSignup()">Create Account</button>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="main">
  <div class="app-wrap">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="s-header">
        <h2>2k26_DSA</h2>
        <div class="hdr-actions">
          <button class="ibtn" onclick="openGcModal()" title="New Group">üë•</button>
          <button class="ibtn" onclick="openStatusModal()" title="Post Status">üì∏</button>
          <button class="ibtn" onclick="toggleProfileMenu()" id="profile-btn" title="Profile">
            <img id="header-pfp" style="width:28px;height:28px;border-radius:50%;object-fit:cover;display:none"/>
            <span id="header-pfp-placeholder">üë§</span>
          </button>
        </div>
      </div>
      <!-- Status -->
      <div class="status-row" id="status-row">
        <div class="st-item">
          <div class="st-ring my-status" onclick="openStatusModal()">Ôºã</div>
          <span>My Status</span>
        </div>
      </div>
      <!-- Search -->
      <div class="s-search">
        <div class="search-wrap">
          <span>üîç</span>
          <input type="text" placeholder="Search chats..." oninput="filterChats(this.value)"/>
        </div>
      </div>
      <!-- Tabs -->
      <div class="chat-tabs">
        <div class="ctab active" onclick="switchChatTab('chats',this)">Chats</div>
        <div class="ctab" onclick="switchChatTab('groups',this)">Groups</div>
      </div>
      <!-- List -->
      <div class="chat-list" id="chat-list">
        <div class="empty-list"><div class="ei">üí¨</div>No chats yet.<br/>Start a new conversation!</div>
      </div>
    </div>

    <!-- CHAT AREA -->
    <div class="chat-area" id="chat-area">
      <div class="no-chat" id="no-chat">
        <div class="big">üí¨</div>
        <p>Select a chat to start messaging</p>
      </div>
      <!-- Active Chat -->
      <div id="active-chat" style="display:none;flex-direction:column;height:100%">
        <div class="ch-header">
          <button class="back-btn" onclick="closeChat()">‚Äπ</button>
          <div id="ch-avatar" class="ci-av" style="width:40px;height:40px;font-size:16px"></div>
          <div class="ch-info">
            <div class="ch-name" id="ch-name"></div>
            <div class="ch-sub" id="ch-sub"></div>
          </div>
          <button class="ibtn" id="ch-info-btn" onclick="openChatInfo()">‚ÑπÔ∏è</button>
        </div>
        <div class="gc-rules-banner" id="gc-rules-banner">
          <strong>üìã Group Rules</strong>
          <div id="gc-rules-text"></div>
        </div>
        <div class="msgs" id="msgs"></div>
        <div class="chat-input" id="chat-input-area">
          <!-- Normal input -->
          <div class="iw" id="normal-iw">
            <textarea id="msg-txt" placeholder="Type a message..." rows="1" oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
            <label style="cursor:pointer;font-size:18px;color:var(--text2)" title="Send image">
              üñºÔ∏è<input type="file" accept="image/*,video/*" style="display:none" onchange="sendMedia(this)"/>
            </label>
          </div>
          <!-- VN recording bar -->
          <div class="vn-bar" id="vn-bar">
            <div class="rec-dot"></div>
            <span class="rec-time" id="rec-time">0:00</span>
            <button class="rec-cancel" onclick="cancelVN()" title="Cancel">‚úï</button>
            <button class="ibtn" onclick="stopAndSendVN()" style="background:var(--accent);color:#000" title="Send VN">‚úì</button>
          </div>
          <button class="ibtn" id="vn-btn" onclick="toggleVN()" title="Voice Note" style="width:42px;height:42px;font-size:18px">üé§</button>
          <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PROFILE MENU -->
<div class="pmenu" id="pmenu">
  <div class="pmi" onclick="openProfileEdit()">‚úèÔ∏è Edit Profile</div>
  <div class="pmi" onclick="openNewChat()">üí¨ New Chat</div>
  <div class="pmi" onclick="doLogout()" style="color:var(--danger)">üö™ Logout</div>
</div>

<!-- NEW GROUP MODAL -->
<div class="overlay" id="gc-overlay">
  <div class="modal">
    <h3>Create Group</h3>
    <div class="fg"><label>Group Name</label><input type="text" id="gc-name" placeholder="e.g. Squad 2k26"/></div>
    <div class="fg"><label>Group Description</label><input type="text" id="gc-desc" placeholder="What's this group about?"/></div>
    <div class="fg">
      <label>Group Icon</label>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="pfp-circle" id="gc-icon-preview" onclick="document.getElementById('gc-icon-file').click()">üë•</div>
        <input type="file" id="gc-icon-file" accept="image/*" style="display:none" onchange="previewGcIcon(this)"/>
        <label class="pfp-label" for="gc-icon-file">Upload Icon</label>
      </div>
    </div>
    <div class="fg">
      <label>Add Members (by email)</label>
      <div style="display:flex;gap:7px">
        <input type="email" id="gc-member-input" placeholder="member@email.com" style="flex:1;padding:9px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:13px;outline:none"/>
        <button class="ibtn" onclick="addGcMemberInput()" style="width:auto;padding:0 12px;border-radius:var(--radius-sm)">Add</button>
      </div>
      <div id="gc-members-list" style="margin-top:8px;display:flex;flex-direction:column;gap:5px"></div>
    </div>
    <div class="fg">
      <label>Group Rules (Admin)</label>
      <div style="display:flex;gap:7px">
        <input type="text" id="gc-rule-input" placeholder="e.g. No spam" style="flex:1;padding:9px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:13px;outline:none"/>
        <button class="ibtn" onclick="addRuleInput()" style="width:auto;padding:0 12px;border-radius:var(--radius-sm)">+</button>
      </div>
      <ul class="rules-list" id="rules-preview" style="margin-top:8px"></ul>
    </div>
    <p class="err" id="gc-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('gc-overlay')">Cancel</button>
      <button class="btn" onclick="createGroup()">Create Group</button>
    </div>
  </div>
</div>

<!-- NEW CHAT MODAL -->
<div class="overlay" id="nc-overlay">
  <div class="modal">
    <h3>New Chat</h3>
    <div class="fg"><label>User Email</label><input type="email" id="nc-email" placeholder="friend@email.com"/></div>
    <p class="err" id="nc-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('nc-overlay')">Cancel</button>
      <button class="btn" onclick="startNewChat()">Start Chat</button>
    </div>
  </div>
</div>

<!-- STATUS MODAL -->
<div class="overlay" id="status-overlay">
  <div class="modal">
    <h3>Post Status</h3>
    <div class="fg"><label>Status Image/Video</label>
      <label style="display:flex;align-items:center;gap:10px;background:var(--bg3);padding:12px;border-radius:var(--radius-sm);cursor:pointer;border:1px dashed var(--border)">
        <span>üìé</span><span style="font-size:13px;color:var(--text2)">Click to choose media</span>
        <input type="file" id="status-file" accept="image/*,video/*" style="display:none" onchange="previewStatus(this)"/>
      </label>
      <div id="status-preview" style="margin-top:8px"></div>
    </div>
    <div class="fg"><label>Caption (optional)</label><input type="text" id="status-caption" placeholder="What's on your mind?"/></div>
    <p class="err" id="status-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('status-overlay')">Cancel</button>
      <button class="btn" onclick="postStatus()">Post Status</button>
    </div>
  </div>
</div>

<!-- CHAT INFO MODAL -->
<div class="overlay" id="chatinfo-overlay">
  <div class="modal" id="chatinfo-modal">
    <h3 id="chatinfo-title">Chat Info</h3>
    <div id="chatinfo-content"></div>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('chatinfo-overlay')">Close</button>
      <button class="btn btn-danger" id="leave-btn" style="display:none" onclick="leaveGroup()">Leave Group</button>
    </div>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="overlay" id="profile-overlay">
  <div class="modal">
    <h3>Edit Profile</h3>
    <div class="pfp-row">
      <div class="pfp-circle" id="edit-pfp-preview" onclick="document.getElementById('edit-pfp-file').click()">üë§</div>
      <div>
        <label class="pfp-label" for="edit-pfp-file">Change Photo</label>
        <p class="pfp-hint">Upload to Cloudinary</p>
      </div>
      <input type="file" id="edit-pfp-file" accept="image/*" style="display:none" onchange="previewEditPfp(this)"/>
    </div>
    <div class="fg"><label>Display Name</label><input type="text" id="edit-name" placeholder="Your name"/></div>
    <div class="fg"><label>Status Text</label><input type="text" id="edit-status" placeholder="Hey there! I'm on 2k26_DSA"/></div>
    <p class="err" id="edit-err"></p>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('profile-overlay')">Cancel</button>
      <button class="btn" onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>

<!-- STATUS VIEWER -->
<div class="status-viewer" id="status-viewer">
  <div class="sv-header">
    <div style="display:flex;flex-direction:column;gap:6px;flex:1">
      <div style="display:flex;gap:4px" id="sv-bars"></div>
      <div style="display:flex;align-items:center;gap:8px">
        <img id="sv-av" style="width:32px;height:32px;border-radius:50%;object-fit:cover" src=""/>
        <span id="sv-name" style="font-size:13px;font-weight:600;color:#fff"></span>
        <span id="sv-time" style="font-size:11px;color:rgba(255,255,255,0.6);margin-left:auto"></span>
      </div>
    </div>
    <button class="sv-close" onclick="closeStatusViewer()">‚úï</button>
  </div>
  <img id="sv-img" class="sv-img" src="" alt="Status"/>
</div>

<!-- IMAGE VIEWER -->
<div class="img-viewer" id="img-viewer">
  <button class="img-viewer-close" onclick="closeImgViewer()">‚úï</button>
  <img id="viewer-img" src="" alt=""/>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FIREBASE + APP JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, onSnapshot, query, where, orderBy, updateDoc, arrayUnion, arrayRemove, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey:"AIzaSyBzUELxbbaL6Wb_M1uNhjwlZHVTorN9XJs",
  authDomain:"my-whatsapp-2c1af.firebaseapp.com",
  databaseURL:"https://my-whatsapp-2c1af-default-rtdb.firebaseio.com",
  projectId:"my-whatsapp-2c1af",
  storageBucket:"my-whatsapp-2c1af.firebasestorage.app",
  messagingSenderId:"1089455460888",
  appId:"1:1089455460888:web:15bd0820546c813febe96d"
};
const CLOUD_NAME = "dzxckgbzp";
const CLOUD_PRESET = "ml_default"; // change if you have a custom unsigned preset

const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);
const storage = getStorage(fbApp);

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentUser = null;
let currentUserData = null;
let activeChatId = null;
let activeChatType = null; // 'private' | 'group'
let activeChatData = null;
let msgsUnsub = null;
let chatsUnsub = null;
let activeTab = 'chats';
let mediaRecorder = null;
let recChunks = [];
let recTimer = null;
let recSeconds = 0;
let pendingPfpFile = null;
let pendingGcIconFile = null;
let gcMembersToAdd = [];
let gcRulesArr = [];
let pendingEditPfpFile = null;
let pendingStatusFile = null;
const EMOJIS = ['‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üëç','üî•','üéâ','üòç','üíØ','üôè'];

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function showToast(msg, dur=2500){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}
function showErr(id,msg){const e=document.getElementById(id);e.textContent=msg;e.style.display='block';}
function hideErr(id){const e=document.getElementById(id);e.style.display='none';}
function fmtTime(ts){
  if(!ts)return'';
  const d=ts.toDate?ts.toDate():new Date(ts);
  const now=new Date();
  const diff=now-d;
  if(diff<60000)return'just now';
  if(diff<3600000)return Math.floor(diff/60000)+'m';
  if(d.toDateString()===now.toDateString())return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  return d.toLocaleDateString([],{day:'2-digit',month:'short'});
}
function chatId(a,b){return[a,b].sort().join('_')}

// ‚îÄ‚îÄ CLOUDINARY UPLOAD ‚îÄ‚îÄ
async function uploadToCloudinary(file, folder='2k26dsa'){
  const fd=new FormData();
  fd.append('file',file);
  fd.append('upload_preset',CLOUD_PRESET);
  fd.append('folder',folder);
  const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,{method:'POST',body:fd});
  if(!res.ok) throw new Error('Upload failed: '+res.statusText);
  const data=await res.json();
  if(data.error) throw new Error(data.error.message);
  return data.secure_url;
}

// ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ
setTimeout(()=>{
  document.getElementById('splash').classList.add('hide');
  setTimeout(()=>{
    document.getElementById('splash').style.display='none';
    checkAuth();
  },650);
},3600);

// ‚îÄ‚îÄ AUTH CHECK ‚îÄ‚îÄ
function checkAuth(){
  onAuthStateChanged(auth, async user=>{
    if(user){
      currentUser=user;
      await loadUserData(user.uid);
      showMain();
    } else {
      showAuth();
    }
  });
}

async function loadUserData(uid){
  try{
    const snap=await getDoc(doc(db,'users',uid));
    if(snap.exists()) currentUserData=snap.data();
    else currentUserData={name:currentUser.displayName||'User',pfp:'',statusText:'Hey there!'};
    updateHeaderPfp();
  }catch(e){console.error('loadUserData',e);}
}

function updateHeaderPfp(){
  const img=document.getElementById('header-pfp');
  const ph=document.getElementById('header-pfp-placeholder');
  if(currentUserData?.pfp){
    img.src=currentUserData.pfp; img.style.display='block'; ph.style.display='none';
  } else {
    img.style.display='none'; ph.style.display='block';
  }
}

function showAuth(){document.getElementById('auth').classList.add('show');}
function hideAuth(){document.getElementById('auth').classList.remove('show');}
function showMain(){
  hideAuth();
  document.getElementById('main').classList.add('show');
  loadChats();
  loadStatuses();
}

// ‚îÄ‚îÄ AUTH TABS ‚îÄ‚îÄ
window.switchTab=function(tab){
  document.getElementById('login-form').style.display=tab==='login'?'block':'none';
  document.getElementById('signup-form').style.display=tab==='signup'?'block':'none';
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',(tab==='login'&&i===0)||(tab==='signup'&&i===1)));
  hideErr('login-err'); hideErr('su-err');
};

// ‚îÄ‚îÄ PFP PREVIEW ‚îÄ‚îÄ
window.previewPfp=function(input){
  pendingPfpFile=input.files[0];
  if(!pendingPfpFile)return;
  const url=URL.createObjectURL(pendingPfpFile);
  const prev=document.getElementById('pfp-preview');
  prev.innerHTML=`<img src="${url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`;
};
window.previewGcIcon=function(input){
  pendingGcIconFile=input.files[0];
  if(!pendingGcIconFile)return;
  const url=URL.createObjectURL(pendingGcIconFile);
  const prev=document.getElementById('gc-icon-preview');
  prev.innerHTML=`<img src="${url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`;
};
window.previewEditPfp=function(input){
  pendingEditPfpFile=input.files[0];
  if(!pendingEditPfpFile)return;
  const url=URL.createObjectURL(pendingEditPfpFile);
  const prev=document.getElementById('edit-pfp-preview');
  prev.innerHTML=`<img src="${url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`;
};
window.previewStatus=function(input){
  pendingStatusFile=input.files[0];
  if(!pendingStatusFile)return;
  const url=URL.createObjectURL(pendingStatusFile);
  const isVid=pendingStatusFile.type.startsWith('video');
  document.getElementById('status-preview').innerHTML=isVid
    ?`<video src="${url}" style="max-width:100%;border-radius:8px;max-height:180px" controls></video>`
    :`<img src="${url}" style="max-width:100%;border-radius:8px;max-height:180px"/>`;
};

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
window.doLogin=async function(){
  const email=document.getElementById('login-email').value.trim();
  const pass=document.getElementById('login-pass').value;
  hideErr('login-err');
  if(!email||!pass){showErr('login-err','Please fill all fields.');return;}
  const btn=document.querySelector('#login-form .btn');
  btn.disabled=true; btn.textContent='Logging in...';
  try{
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){
    showErr('login-err',friendlyError(e.code));
    btn.disabled=false; btn.textContent='Login';
  }
};

// ‚îÄ‚îÄ SIGNUP ‚îÄ‚îÄ
window.doSignup=async function(){
  const name=document.getElementById('su-name').value.trim();
  const email=document.getElementById('su-email').value.trim();
  const pass=document.getElementById('su-pass').value;
  hideErr('su-err');
  if(!name||!email||!pass){showErr('su-err','Please fill all fields.');return;}
  if(pass.length<6){showErr('su-err','Password must be at least 6 characters.');return;}
  const btn=document.querySelector('#signup-form .btn');
  btn.disabled=true; btn.textContent='Creating account...';
  try{
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    let pfpUrl='';
    if(pendingPfpFile){
      showToast('Uploading profile picture...');
      pfpUrl=await uploadToCloudinary(pendingPfpFile,'pfps');
    }
    await updateProfile(cred.user,{displayName:name,photoURL:pfpUrl||undefined});
    await setDoc(doc(db,'users',cred.user.uid),{
      uid:cred.user.uid, name, email, pfp:pfpUrl, statusText:'Hey there! I am on 2k26_DSA', createdAt:serverTimestamp()
    });
    showToast('Account created! Welcome üéâ');
  }catch(e){
    showErr('su-err',friendlyError(e.code));
    btn.disabled=false; btn.textContent='Create Account';
  }
};

// ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ
window.doLogout=async function(){
  try{await signOut(auth);}catch(e){}
  currentUser=null; currentUserData=null; activeChatId=null;
  document.getElementById('main').classList.remove('show');
  document.getElementById('pmenu').classList.remove('show');
  showAuth();
};

// ‚îÄ‚îÄ ERROR MESSAGES ‚îÄ‚îÄ
function friendlyError(code){
  const map={
    'auth/user-not-found':'No account found with this email.',
    'auth/wrong-password':'Incorrect password. Try again.',
    'auth/email-already-in-use':'This email is already registered.',
    'auth/invalid-email':'Please enter a valid email address.',
    'auth/weak-password':'Password is too weak.',
    'auth/network-request-failed':'Network error. Check your connection.',
    'auth/too-many-requests':'Too many attempts. Try again later.',
    'auth/invalid-credential':'Invalid email or password.',
  };
  return map[code]||'Something went wrong. Please try again.';
}

// ‚îÄ‚îÄ PROFILE MENU ‚îÄ‚îÄ
window.toggleProfileMenu=function(){
  document.getElementById('pmenu').classList.toggle('show');
};
document.addEventListener('click',e=>{
  if(!e.target.closest('#pmenu')&&!e.target.closest('#profile-btn'))
    document.getElementById('pmenu').classList.remove('show');
});

// ‚îÄ‚îÄ OPEN PROFILE EDIT ‚îÄ‚îÄ
window.openProfileEdit=function(){
  document.getElementById('pmenu').classList.remove('show');
  const prev=document.getElementById('edit-pfp-preview');
  if(currentUserData?.pfp) prev.innerHTML=`<img src="${currentUserData.pfp}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`;
  document.getElementById('edit-name').value=currentUserData?.name||'';
  document.getElementById('edit-status').value=currentUserData?.statusText||'';
  document.getElementById('profile-overlay').classList.add('show');
};

window.saveProfile=async function(){
  hideErr('edit-err');
  const name=document.getElementById('edit-name').value.trim();
  const statusText=document.getElementById('edit-status').value.trim();
  if(!name){showErr('edit-err','Name cannot be empty.');return;}
  const btn=document.querySelector('#profile-overlay .btn:not(.btn-ghost)');
  btn.disabled=true; btn.textContent='Saving...';
  try{
    let pfp=currentUserData?.pfp||'';
    if(pendingEditPfpFile){
      showToast('Uploading photo...');
      pfp=await uploadToCloudinary(pendingEditPfpFile,'pfps');
      pendingEditPfpFile=null;
    }
    await updateProfile(currentUser,{displayName:name,photoURL:pfp||undefined});
    await setDoc(doc(db,'users',currentUser.uid),{name,statusText,pfp},{ merge:true });
    currentUserData={...currentUserData,name,statusText,pfp};
    updateHeaderPfp();
    closeModal('profile-overlay');
    showToast('Profile updated ‚úÖ');
  }catch(e){
    showErr('edit-err',e.message);
  } finally{btn.disabled=false;btn.textContent='Save';}
};

// ‚îÄ‚îÄ NEW CHAT ‚îÄ‚îÄ
window.openNewChat=function(){
  document.getElementById('pmenu').classList.remove('show');
  document.getElementById('nc-email').value='';
  hideErr('nc-err');
  document.getElementById('nc-overlay').classList.add('show');
};

window.startNewChat=async function(){
  const email=document.getElementById('nc-email').value.trim().toLowerCase();
  hideErr('nc-err');
  if(!email){showErr('nc-err','Enter an email.');return;}
  if(email===currentUser.email.toLowerCase()){showErr('nc-err',"You can't chat with yourself.");return;}
  const btn=document.querySelector('#nc-overlay .btn:not(.btn-ghost)');
  btn.disabled=true;btn.textContent='Searching...';
  try{
    const q=query(collection(db,'users'),where('email','==',email));
    const snap=await getDocs(q);
    if(snap.empty){showErr('nc-err','No user found with that email.');btn.disabled=false;btn.textContent='Start Chat';return;}
    const otherUser=snap.docs[0].data();
    const cid=chatId(currentUser.uid,otherUser.uid);
    await setDoc(doc(db,'chats',cid),{
      type:'private',
      members:[currentUser.uid,otherUser.uid],
      memberData:{
        [currentUser.uid]:{name:currentUserData?.name||currentUser.displayName,pfp:currentUserData?.pfp||''},
        [otherUser.uid]:{name:otherUser.name,pfp:otherUser.pfp||''}
      },
      lastMsg:'',lastTime:serverTimestamp(),unread:{}
    },{merge:true});
    closeModal('nc-overlay');
    openChat(cid,'private',{id:otherUser.uid,...otherUser});
  }catch(e){showErr('nc-err',e.message);}
  finally{btn.disabled=false;btn.textContent='Start Chat';}
};

// ‚îÄ‚îÄ LOAD CHATS ‚îÄ‚îÄ
function loadChats(){
  if(chatsUnsub) chatsUnsub();
  const qPrivate=query(collection(db,'chats'),where('members','array-contains',currentUser.uid));
  chatsUnsub=onSnapshot(qPrivate,snap=>{
    const items=[];
    snap.forEach(d=>{items.push({id:d.id,...d.data()});});
    renderChatList(items.filter(i=>activeTab==='groups'?i.type==='group':i.type!=='group'));
  },e=>console.error('loadChats',e));
}

function renderChatList(items){
  const list=document.getElementById('chat-list');
  if(!items.length){
    list.innerHTML=`<div class="empty-list"><div class="ei">${activeTab==='groups'?'üë•':'üí¨'}</div>${activeTab==='groups'?'No groups yet. Create one!':'No chats yet. Start one!'}</div>`;
    return;
  }
  items.sort((a,b)=>{
    const ta=a.lastTime?.seconds||0; const tb=b.lastTime?.seconds||0; return tb-ta;
  });
  list.innerHTML=items.map(item=>{
    let name='',pfp='',last=item.lastMsg||'';
    if(item.type==='group'){name=item.name;pfp=item.icon||'';}
    else{
      const other=item.members.find(m=>m!==currentUser.uid);
      const od=item.memberData?.[other]||{};
      name=od.name||'Unknown'; pfp=od.pfp||'';
    }
    const unread=item.unread?.[currentUser.uid]||0;
    const avHtml=pfp?`<img class="ci-av" src="${pfp}" alt=""/>`:`<div class="ci-av">${name[0]?.toUpperCase()||'?'}</div>`;
    return`<div class="ci${activeChatId===item.id?' active':''}" onclick="openChat('${item.id}','${item.type||'private'}',null)" data-id="${item.id}">
      ${avHtml}
      <div class="ci-info"><div class="ci-name">${escHtml(name)}</div><div class="ci-last">${escHtml(last)}</div></div>
      <div class="ci-meta">
        <span class="ci-time">${fmtTime(item.lastTime)}</span>
        ${unread?`<span class="ci-badge">${unread}</span>`:''}
      </div>
    </div>`;
  }).join('');
}

window.filterChats=function(val){
  document.querySelectorAll('.ci').forEach(el=>{
    el.style.display=el.querySelector('.ci-name').textContent.toLowerCase().includes(val.toLowerCase())?'':'none';
  });
};
window.switchChatTab=function(tab,el){
  activeTab=tab;
  document.querySelectorAll('.ctab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  loadChats();
};

// ‚îÄ‚îÄ OPEN CHAT ‚îÄ‚îÄ
window.openChat=async function(chatId_, type, userData){
  activeChatId=chatId_; activeChatType=type;
  // Mobile: hide sidebar
  document.getElementById('sidebar').classList.add('hidden');
  document.getElementById('no-chat').style.display='none';
  const ac=document.getElementById('active-chat'); ac.style.display='flex';

  // Mark active in list
  document.querySelectorAll('.ci').forEach(el=>el.classList.toggle('active',el.dataset.id===chatId_));

  // Load chat data if not passed
  if(!userData){
    try{
      const snap=await getDoc(doc(db,'chats',chatId_));
      if(snap.exists()) activeChatData={id:snap.id,...snap.data()};
    }catch(e){}
  }

  // Set header
  const chAvatar=document.getElementById('ch-avatar');
  const chName=document.getElementById('ch-name');
  const chSub=document.getElementById('ch-sub');
  const gcBanner=document.getElementById('gc-rules-banner');

  if(type==='group'){
    const snap=await getDoc(doc(db,'chats',chatId_));
    activeChatData={id:snap.id,...snap.data()};
    const d=activeChatData;
    chName.textContent=d.name||'Group';
    chSub.textContent=`${(d.members||[]).length} members`;
    if(d.icon) chAvatar.innerHTML=`<img src="${d.icon}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`;
    else chAvatar.textContent=(d.name||'G')[0].toUpperCase();
    // Rules banner
    if(d.rules&&d.rules.length){
      gcBanner.classList.add('show');
      document.getElementById('gc-rules-text').textContent=d.rules.join(' ‚Ä¢ ');
    } else gcBanner.classList.remove('show');
  } else {
    gcBanner.classList.remove('show');
    const snap=await getDoc(doc(db,'chats',chatId_));
    if(snap.exists()) activeChatData={id:snap.id,...snap.data()};
    const d=activeChatData;
    const other=d?.members?.find(m=>m!==currentUser.uid);
    const od=d?.memberData?.[other]||{};
    chName.textContent=od.name||'User';
    chSub.textContent='Private chat';
    if(od.pfp) chAvatar.innerHTML=`<img src="${od.pfp}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`;
    else chAvatar.textContent=(od.name||'U')[0].toUpperCase();
  }

  // Reset unread
  try{ await updateDoc(doc(db,'chats',chatId_),{[`unread.${currentUser.uid}`]:0}); }catch(e){}

  // Load messages
  loadMessages(chatId_);
};

window.closeChat=function(){
  document.getElementById('sidebar').classList.remove('hidden');
  document.getElementById('active-chat').style.display='none';
  document.getElementById('no-chat').style.display='flex';
  if(msgsUnsub){msgsUnsub();msgsUnsub=null;}
  activeChatId=null;
};

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ
function loadMessages(chatId_){
  if(msgsUnsub){msgsUnsub();msgsUnsub=null;}
  const msgsRef=collection(db,'chats',chatId_,'messages');
  const q=query(msgsRef,orderBy('timestamp','asc'));
  msgsUnsub=onSnapshot(q,snap=>{
    renderMessages(snap.docs.map(d=>({id:d.id,...d.data()})));
  },e=>console.error('loadMessages',e));
}

function renderMessages(msgs){
  const container=document.getElementById('msgs');
  const wasAtBottom=container.scrollHeight-container.scrollTop-container.clientHeight<100;
  container.innerHTML=msgs.map(m=>renderMsg(m)).join('');
  if(wasAtBottom) container.scrollTop=container.scrollHeight;
}

function renderMsg(m){
  const isOut=m.senderId===currentUser.uid;
  const cls=isOut?'out':'in';
  let content='';
  if(m.type==='text') content=`<div class="mb" data-id="${m.id}" oncontextmenu="showEmojiPicker(event,'${m.id}')" ondblclick="showEmojiPicker(event,'${m.id}')">${escHtml(m.text)}<div class="emoji-picker" id="ep_${m.id}">${EMOJIS.map(e=>`<button onclick="reactMsg('${m.id}','${e}')">${e}</button>`).join('')}</div></div>`;
  else if(m.type==='image') content=`<div class="mb" data-id="${m.id}" oncontextmenu="showEmojiPicker(event,'${m.id}')" ondblclick="showEmojiPicker(event,'${m.id}')"><img class="m-img" src="${m.url}" onclick="openImgViewer('${m.url}')"/><div class="emoji-picker" id="ep_${m.id}">${EMOJIS.map(e=>`<button onclick="reactMsg('${m.id}','${e}')">${e}</button>`).join('')}</div></div>`;
  else if(m.type==='audio') content=`<div class="mb m-audio" data-id="${m.id}" oncontextmenu="showEmojiPicker(event,'${m.id}')" ondblclick="showEmojiPicker(event,'${m.id}')"><audio controls src="${m.url}"></audio><div class="emoji-picker" id="ep_${m.id}">${EMOJIS.map(e=>`<button onclick="reactMsg('${m.id}','${e}')">${e}</button>`).join('')}</div></div>`;

  const reactions=m.reactions||{};
  const rHtml=Object.entries(reactions).filter(([,v])=>v&&v.length).map(([emoji,users])=>`<div class="rpill" onclick="reactMsg('${m.id}','${emoji}')">${emoji}<span class="rc">${users.length}</span></div>`).join('');
  const senderName=!isOut&&activeChatType==='group'?`<div class="m-sender">${escHtml(m.senderName||'')}</div>`:'';
  return`<div class="mw ${cls}">${senderName}${content}${rHtml?`<div class="m-reactions">${rHtml}</div>`:''}
    <span class="m-time">${fmtTime(m.timestamp)}</span></div>`;
}

// ‚îÄ‚îÄ SEND MESSAGE ‚îÄ‚îÄ
window.sendMessage=async function(){
  if(!activeChatId) return;
  const txt=document.getElementById('msg-txt').value.trim();
  if(!txt) return;
  document.getElementById('msg-txt').value='';
  autoResize(document.getElementById('msg-txt'));
  try{
    await addDoc(collection(db,'chats',activeChatId,'messages'),{
      type:'text',text:txt,senderId:currentUser.uid,
      senderName:currentUserData?.name||currentUser.displayName,
      timestamp:serverTimestamp(),reactions:{}
    });
    await updateChatMeta(txt);
  }catch(e){showToast('‚ùå Failed to send: '+e.message);}
};

window.handleEnter=function(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
};

async function updateChatMeta(lastMsg){
  if(!activeChatId)return;
  try{
    const snap=await getDoc(doc(db,'chats',activeChatId));
    const d=snap.data()||{};
    const unread={...d.unread||{}};
    (d.members||[]).forEach(m=>{ if(m!==currentUser.uid) unread[m]=(unread[m]||0)+1; });
    await updateDoc(doc(db,'chats',activeChatId),{lastMsg,lastTime:serverTimestamp(),unread});
  }catch(e){}
}

// ‚îÄ‚îÄ SEND MEDIA ‚îÄ‚îÄ
window.sendMedia=async function(input){
  if(!activeChatId||!input.files[0])return;
  const file=input.files[0];
  const isVid=file.type.startsWith('video');
  showToast('Uploading media... üì§');
  try{
    const url=await uploadToCloudinary(file,'media');
    await addDoc(collection(db,'chats',activeChatId,'messages'),{
      type:'image',url,senderId:currentUser.uid,
      senderName:currentUserData?.name||currentUser.displayName,
      timestamp:serverTimestamp(),reactions:{}
    });
    await updateChatMeta(isVid?'üé• Video':'üì∑ Photo');
    showToast('Media sent ‚úÖ');
  }catch(e){showToast('‚ùå Upload failed: '+e.message);}
  input.value='';
};

// ‚îÄ‚îÄ VOICE NOTES ‚îÄ‚îÄ
window.toggleVN=async function(){
  if(mediaRecorder&&mediaRecorder.state==='recording'){stopAndSendVN();return;}
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    recChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recChunks.push(e.data);};
    mediaRecorder.onstop=async()=>{
      stream.getTracks().forEach(t=>t.stop());
      if(recChunks.length===0)return;
      const blob=new Blob(recChunks,{type:'audio/webm'});
      const file=new File([blob],`vn_${Date.now()}.webm`,{type:'audio/webm'});
      showToast('Sending voice note... üé§');
      try{
        const url=await uploadToCloudinary(file,'voicenotes');
        await addDoc(collection(db,'chats',activeChatId,'messages'),{
          type:'audio',url,senderId:currentUser.uid,
          senderName:currentUserData?.name||currentUser.displayName,
          timestamp:serverTimestamp(),reactions:{}
        });
        await updateChatMeta('üé§ Voice note');
        showToast('Voice note sent ‚úÖ');
      }catch(e){showToast('‚ùå VN upload failed: '+e.message);}
    };
    mediaRecorder.start();
    startRecTimer();
    document.getElementById('normal-iw').style.display='none';
    document.getElementById('vn-bar').classList.add('show');
    document.getElementById('send-btn').style.display='none';
    document.getElementById('vn-btn').style.display='none';
  }catch(e){showToast('‚ùå Microphone access denied');}
};

window.stopAndSendVN=function(){
  if(mediaRecorder&&mediaRecorder.state==='recording') mediaRecorder.stop();
  stopRecTimer();
  resetVNUI();
};
window.cancelVN=function(){
  if(mediaRecorder&&mediaRecorder.state==='recording'){
    mediaRecorder.onstop=()=>{};
    mediaRecorder.stop();
    mediaRecorder.stream?.getTracks().forEach(t=>t.stop());
  }
  recChunks=[];
  stopRecTimer();
  resetVNUI();
};
function resetVNUI(){
  document.getElementById('normal-iw').style.display='flex';
  document.getElementById('vn-bar').classList.remove('show');
  document.getElementById('send-btn').style.display='flex';
  document.getElementById('vn-btn').style.display='flex';
}
function startRecTimer(){
  recSeconds=0;
  document.getElementById('rec-time').textContent='0:00';
  recTimer=setInterval(()=>{
    recSeconds++;
    const m=Math.floor(recSeconds/60);
    const s=recSeconds%60;
    document.getElementById('rec-time').textContent=`${m}:${s.toString().padStart(2,'0')}`;
  },1000);
}
function stopRecTimer(){clearInterval(recTimer);recTimer=null;recSeconds=0;}

// ‚îÄ‚îÄ REACTIONS ‚îÄ‚îÄ
window.showEmojiPicker=function(e,msgId){
  e.preventDefault();
  document.querySelectorAll('.emoji-picker').forEach(p=>{if(p.id!=='ep_'+msgId)p.classList.remove('show');});
  document.getElementById('ep_'+msgId)?.classList.toggle('show');
};
document.addEventListener('click',e=>{
  if(!e.target.closest('.emoji-picker')&&!e.target.closest('.mb'))
    document.querySelectorAll('.emoji-picker').forEach(p=>p.classList.remove('show'));
});

window.reactMsg=async function(msgId,emoji){
  if(!activeChatId)return;
  try{
    const mRef=doc(db,'chats',activeChatId,'messages',msgId);
    const snap=await getDoc(mRef);
    if(!snap.exists())return;
    const reactions=snap.data().reactions||{};
    const users=reactions[emoji]||[];
    if(users.includes(currentUser.uid)){
      await updateDoc(mRef,{[`reactions.${emoji}`]:arrayRemove(currentUser.uid)});
    }else{
      await updateDoc(mRef,{[`reactions.${emoji}`]:arrayUnion(currentUser.uid)});
    }
  }catch(e){showToast('‚ùå Reaction failed');}
};

// ‚îÄ‚îÄ CREATE GROUP ‚îÄ‚îÄ
window.openGcModal=function(){
  gcMembersToAdd=[]; gcRulesArr=[];
  document.getElementById('gc-name').value='';
  document.getElementById('gc-desc').value='';
  document.getElementById('gc-members-list').innerHTML='';
  document.getElementById('rules-preview').innerHTML='';
  document.getElementById('gc-icon-preview').innerHTML='üë•';
  pendingGcIconFile=null;
  hideErr('gc-err');
  document.getElementById('gc-overlay').classList.add('show');
};

window.addGcMemberInput=async function(){
  const email=document.getElementById('gc-member-input').value.trim().toLowerCase();
  if(!email)return;
  if(email===currentUser.email.toLowerCase()){showToast('You are already a member.');return;}
  if(gcMembersToAdd.find(m=>m.email===email)){showToast('Already added.');return;}
  try{
    const q=query(collection(db,'users'),where('email','==',email));
    const snap=await getDocs(q);
    if(snap.empty){showToast('User not found.');return;}
    const u=snap.docs[0].data();
    gcMembersToAdd.push(u);
    document.getElementById('gc-member-input').value='';
    renderGcMembersList();
  }catch(e){showToast('‚ùå Error: '+e.message);}
};

function renderGcMembersList(){
  document.getElementById('gc-members-list').innerHTML=gcMembersToAdd.map((m,i)=>
    `<div style="display:flex;align-items:center;gap:8px;background:var(--bg3);padding:7px 10px;border-radius:var(--radius-sm)">
      <span style="font-size:12px;flex:1">${escHtml(m.name)} (${escHtml(m.email)})</span>
      <button onclick="removeGcMember(${i})" style="background:none;border:none;color:var(--danger);cursor:pointer">‚úï</button>
    </div>`
  ).join('');
}
window.removeGcMember=function(i){gcMembersToAdd.splice(i,1);renderGcMembersList();};

window.addRuleInput=function(){
  const rule=document.getElementById('gc-rule-input').value.trim();
  if(!rule)return;
  gcRulesArr.push(rule);
  document.getElementById('gc-rule-input').value='';
  renderRulesPreview();
};
function renderRulesPreview(){
  document.getElementById('rules-preview').innerHTML=gcRulesArr.map((r,i)=>
    `<li class="rule-item">üìå ${escHtml(r)}<button onclick="removeRule(${i})">‚úï</button></li>`
  ).join('');
}
window.removeRule=function(i){gcRulesArr.splice(i,1);renderRulesPreview();};

window.createGroup=async function(){
  const name=document.getElementById('gc-name').value.trim();
  const desc=document.getElementById('gc-desc').value.trim();
  hideErr('gc-err');
  if(!name){showErr('gc-err','Group name is required.');return;}
  const btn=document.querySelector('#gc-overlay .btn:not(.btn-ghost)');
  btn.disabled=true;btn.textContent='Creating...';
  try{
    let icon='';
    if(pendingGcIconFile){
      showToast('Uploading group icon...');
      icon=await uploadToCloudinary(pendingGcIconFile,'group-icons');
      pendingGcIconFile=null;
    }
    const allMembers=[currentUser.uid,...gcMembersToAdd.map(m=>m.uid)];
    const memberData={[currentUser.uid]:{name:currentUserData?.name||currentUser.displayName,pfp:currentUserData?.pfp||''}};
    gcMembersToAdd.forEach(m=>{memberData[m.uid]={name:m.name,pfp:m.pfp||''};});
    const gcDoc=await addDoc(collection(db,'chats'),{
      type:'group',name,description:desc,icon,
      members:allMembers,memberData,
      admins:[currentUser.uid],rules:gcRulesArr,
      lastMsg:'Group created',lastTime:serverTimestamp(),unread:{}
    });
    closeModal('gc-overlay');
    showToast(`Group "${name}" created! üéâ`);
    openChat(gcDoc.id,'group',null);
  }catch(e){showErr('gc-err',e.message);}
  finally{btn.disabled=false;btn.textContent='Create Group';}
};

// ‚îÄ‚îÄ CHAT INFO ‚îÄ‚îÄ
window.openChatInfo=async function(){
  if(!activeChatId)return;
  const modal=document.getElementById('chatinfo-modal');
  const title=document.getElementById('chatinfo-title');
  const content=document.getElementById('chatinfo-content');
  const leaveBtn=document.getElementById('leave-btn');
  if(activeChatType==='group'){
    const snap=await getDoc(doc(db,'chats',activeChatId));
    const d=snap.data()||{};
    title.textContent=d.name||'Group Info';
    const isAdmin=d.admins?.includes(currentUser.uid);
    const membersHtml=Object.entries(d.memberData||{}).map(([uid,m])=>
      `<div class="member-item">
        ${m.pfp?`<img src="${m.pfp}" alt=""/>`:`<div class="ci-av" style="width:34px;height:34px;font-size:13px">${(m.name||'?')[0]}</div>`}
        <span>${escHtml(m.name||'')}</span>
        ${d.admins?.includes(uid)?'<span class="badge">Admin</span>':''}
        ${isAdmin&&uid!==currentUser.uid?`<button onclick="removeMember('${uid}')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:12px">Remove</button>`:''}
      </div>`
    ).join('');
    const rulesHtml=d.rules?.length?`<div style="margin-top:14px"><strong style="font-size:12px;color:var(--accent)">Rules</strong><ul class="rules-list" style="margin-top:6px">${d.rules.map(r=>`<li class="rule-item">üìå ${escHtml(r)}</li>`).join('')}</ul></div>`:'';
    const addRuleHtml=isAdmin?`<div style="display:flex;gap:7px;margin-top:12px">
      <input type="text" id="live-rule-input" placeholder="Add new rule..." style="flex:1;padding:8px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:12px;outline:none"/>
      <button class="ibtn" onclick="addLiveRule()" style="width:auto;padding:0 10px;border-radius:var(--radius-sm);font-size:12px">Add</button></div>`:'';
    content.innerHTML=`<p style="font-size:12px;color:var(--text2);margin-bottom:12px">${escHtml(d.description||'')}</p><div class="members-list">${membersHtml}</div>${rulesHtml}${addRuleHtml}`;
    leaveBtn.style.display='block';
  } else {
    const d=activeChatData||{};
    const other=d.members?.find(m=>m!==currentUser.uid);
    const od=d.memberData?.[other]||{};
    title.textContent='Contact Info';
    content.innerHTML=`<div style="text-align:center;padding:16px 0">
      ${od.pfp?`<img src="${od.pfp}" style="width:72px;height:72px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)"/>`:`<div class="ci-av" style="width:72px;height:72px;font-size:28px;margin:0 auto">${(od.name||'?')[0]}</div>`}
      <div style="font-size:16px;font-weight:600;margin-top:10px">${escHtml(od.name||'')}</div>
    </div>`;
    leaveBtn.style.display='none';
  }
  document.getElementById('chatinfo-overlay').classList.add('show');
};

window.addLiveRule=async function(){
  const rule=document.getElementById('live-rule-input')?.value.trim();
  if(!rule||!activeChatId)return;
  try{
    await updateDoc(doc(db,'chats',activeChatId),{rules:arrayUnion(rule)});
    showToast('Rule added ‚úÖ');
    document.getElementById('live-rule-input').value='';
    openChatInfo();
  }catch(e){showToast('‚ùå '+e.message);}
};

window.removeMember=async function(uid){
  if(!activeChatId)return;
  try{
    await updateDoc(doc(db,'chats',activeChatId),{
      members:arrayRemove(uid),
      [`memberData.${uid}`]:null
    });
    showToast('Member removed');
    openChatInfo();
  }catch(e){showToast('‚ùå '+e.message);}
};

window.leaveGroup=async function(){
  if(!activeChatId||!currentUser)return;
  try{
    await updateDoc(doc(db,'chats',activeChatId),{members:arrayRemove(currentUser.uid)});
    closeModal('chatinfo-overlay');
    closeChat();
    showToast('You left the group');
  }catch(e){showToast('‚ùå '+e.message);}
};

// ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ
window.openStatusModal=function(){
  pendingStatusFile=null;
  document.getElementById('status-preview').innerHTML='';
  document.getElementById('status-caption').value='';
  hideErr('status-err');
  document.getElementById('status-overlay').classList.add('show');
};

window.postStatus=async function(){
  hideErr('status-err');
  if(!pendingStatusFile){showErr('status-err','Please choose an image or video.');return;}
  const btn=document.querySelector('#status-overlay .btn:not(.btn-ghost)');
  btn.disabled=true;btn.textContent='Posting...';
  try{
    const url=await uploadToCloudinary(pendingStatusFile,'statuses');
    const caption=document.getElementById('status-caption').value.trim();
    await addDoc(collection(db,'statuses'),{
      uid:currentUser.uid,name:currentUserData?.name||currentUser.displayName,
      pfp:currentUserData?.pfp||'',url,caption,
      mediaType:pendingStatusFile.type.startsWith('video')?'video':'image',
      timestamp:serverTimestamp(),
      expiresAt:Timestamp.fromMillis(Date.now()+24*3600*1000)
    });
    closeModal('status-overlay');
    pendingStatusFile=null;
    showToast('Status posted! ‚úÖ');
    loadStatuses();
  }catch(e){showErr('status-err',e.message);}
  finally{btn.disabled=false;btn.textContent='Post Status';}
};

async function loadStatuses(){
  try{
    const now=Timestamp.now();
    const q=query(collection(db,'statuses'),where('expiresAt','>',now));
    const snap=await getDocs(q);
    const statuses=[];
    snap.forEach(d=>statuses.push({id:d.id,...d.data()}));
    renderStatuses(statuses);
  }catch(e){console.error('loadStatuses',e);}
}

function renderStatuses(statuses){
  const row=document.getElementById('status-row');
  const myStatus=statuses.filter(s=>s.uid===currentUser.uid);
  const others=statuses.filter(s=>s.uid!==currentUser.uid);
  // Group by user
  const byUser={};
  others.forEach(s=>{if(!byUser[s.uid])byUser[s.uid]=[];byUser[s.uid].push(s);});
  const otherHtml=Object.values(byUser).map(userStatuses=>{
    const s=userStatuses[0];
    return`<div class="st-item" onclick="viewStatus(${JSON.stringify(userStatuses).replace(/"/g,'&quot;')})">
      <div class="st-ring"><img src="${s.pfp||''}" onerror="this.style.display='none'" alt=""/></div>
      <span>${escHtml(s.name||'')}</span>
    </div>`;
  }).join('');
  row.innerHTML=`<div class="st-item">
    <div class="st-ring my-status${myStatus.length?' ':''}${myStatus.length?'has-status':''}" onclick="openStatusModal()" style="${myStatus.length?'border-color:var(--accent)':''}">Ôºã</div>
    <span>My Status</span>
  </div>${otherHtml}`;
}

let svStatuses=[]; let svIndex=0; let svProgress=null;
window.viewStatus=function(statuses){
  svStatuses=statuses; svIndex=0;
  showStatusAt(0);
  document.getElementById('status-viewer').classList.add('show');
};
function showStatusAt(i){
  const s=svStatuses[i];
  if(!s){closeStatusViewer();return;}
  document.getElementById('sv-img').src=s.url;
  document.getElementById('sv-name').textContent=s.name||'';
  document.getElementById('sv-av').src=s.pfp||'';
  document.getElementById('sv-time').textContent=fmtTime(s.timestamp);
  const bars=document.getElementById('sv-bars');
  bars.innerHTML=svStatuses.map((_,j)=>`<div class="sv-bar"><div class="sv-fill" style="width:${j<i?'100':j===i?'0':'0'}%;transition:${j===i?'width 5s linear':'none'}"></div></div>`).join('');
  clearTimeout(svProgress);
  svProgress=setTimeout(()=>{ svIndex++; if(svIndex<svStatuses.length)showStatusAt(svIndex); else closeStatusViewer(); },5100);
  setTimeout(()=>bars.querySelectorAll('.sv-fill')[i]?.style.setProperty('width','100%'),50);
}
window.closeStatusViewer=function(){
  clearTimeout(svProgress);
  document.getElementById('status-viewer').classList.remove('show');
};

// ‚îÄ‚îÄ IMAGE VIEWER ‚îÄ‚îÄ
window.openImgViewer=function(url){
  document.getElementById('viewer-img').src=url;
  document.getElementById('img-viewer').classList.add('show');
};
window.closeImgViewer=function(){document.getElementById('img-viewer').classList.remove('show');};
document.getElementById('img-viewer').addEventListener('click',function(e){if(e.target===this)closeImgViewer();});

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
window.closeModal=function(id){document.getElementById(id).classList.remove('show');};
document.querySelectorAll('.overlay').forEach(ov=>ov.addEventListener('click',function(e){if(e.target===this)closeModal(this.id);}));

// ‚îÄ‚îÄ AUTO RESIZE TEXTAREA ‚îÄ‚îÄ
window.autoResize=function(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';};

// ‚îÄ‚îÄ ESCAPE HTML ‚îÄ‚îÄ
function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

// ‚îÄ‚îÄ ONLINE STATUS (simple) ‚îÄ‚îÄ
async function setOnline(){
  if(!currentUser)return;
  try{await setDoc(doc(db,'users',currentUser.uid),{lastSeen:serverTimestamp()},{merge:true});}catch(e){}
}
setInterval(setOnline,30000);
document.addEventListener('visibilitychange',()=>{if(!document.hidden)setOnline();});
</script>
</body>
</html>
